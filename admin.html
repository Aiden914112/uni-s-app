<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Uni-S æŒæ«ƒç³»çµ±</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* å…±ç”¨è®Šæ•¸ (Morandi/Song Dynasty) */
        :root {
            --primary: #9F8C6D;
            --gold: #CCB28A;
            --bg: #F7F4EF;
            --text: #4A4A4A;
            --danger: #B85C5C;
            --success: #7A8B69;
            --card-bg: #fff;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨æ¨™é¡Œ */
        header {
            background: linear-gradient(135deg, #4A4036, #2C2620);
            color: var(--gold);
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-title { font-family: 'Noto Serif TC'; font-size: 18px; font-weight: bold; letter-spacing: 1px; }
        .shop-badge { background: rgba(204, 178, 138, 0.2); padding: 4px 12px; border-radius: 20px; font-size: 12px; border: 1px solid rgba(204, 178, 138, 0.4); }

        /* é ç±¤ */
        .tabs {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #E0D8CC;
            flex-shrink: 0;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        .tab.active { color: var(--primary); }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 20%; right: 20%;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }
        .badge {
            background: var(--danger); color: white; border-radius: 10px;
            padding: 2px 6px; font-size: 10px; vertical-align: top; margin-left: 2px;
            display: none; /* é è¨­éš±è—ï¼Œæœ‰æ•¸å­—å†é¡¯ç¤º */
        }

        /* å…§å®¹å€ */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        /* è¨‚å–®å¡ç‰‡ (KDS é¢¨æ ¼ - æŒ‰éˆ•è¼ƒå¤§) */
        .order-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            border: 1px solid #E0D8CC;
            border-left: 5px solid #ccc; /* é è¨­é‚Šæ¡†è‰² */
            transition: transform 0.2s;
        }
        .order-card[data-status="å¾…ç¢ºèª"] { border-left-color: var(--danger); }
        .order-card[data-status="âœ… å·²æ¥å–®"] { border-left-color: var(--success); }
        .order-card[data-status="è£½ä½œä¸­"] { border-left-color: var(--gold); }

        .oc-header { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .oc-id { font-family: 'Noto Serif TC'; font-weight: bold; font-size: 16px; color: #2C2620; }
        .oc-time { font-size: 12px; color: #999; }
        
        .oc-customer { font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #555; }
        .oc-items { font-size: 14px; line-height: 1.6; color: #333; margin-bottom: 15px; white-space: pre-wrap; }
        .oc-note { background: #FFF8E1; color: #D4A017; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-bottom: 15px; display: inline-block;}

        .oc-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .oc-price { font-size: 18px; font-weight: bold; color: var(--danger); font-family: 'Noto Serif TC'; }
        
        .oc-actions { display: flex; gap: 10px; }
        .btn { border: none; padding: 8px 20px; border-radius: 30px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--success); color: white; }
        .btn-danger { background: #fff; border: 1px solid var(--danger); color: var(--danger); }
        .btn-gold { background: var(--gold); color: white; }
        .btn-disabled { background: #eee; color: #999; cursor: not-allowed; }

        /* Loading & Overlay */
        #loading-overlay { position: fixed; inset: 0; background: rgba(247, 244, 239, 0.9); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #error-overlay { position: fixed; inset: 0; background: #333; z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading-overlay">
        <i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--primary);"></i>
        <p style="margin-top:10px; font-weight:bold;">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <!-- Error / Access Denied -->
    <div id="error-overlay" class="hidden">
        <i class="fas fa-lock fa-3x" style="color:var(--danger); margin-bottom:20px;"></i>
        <h2>ç„¡æ³•å­˜å–</h2>
        <p id="error-msg">æ‚¨æ²’æœ‰ç®¡ç†æ¬Šé™ï¼Œæˆ–ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ã€‚</p>
    </div>

    <!-- Header -->
    <header>
        <div class="app-title">Uni-S æŒæ«ƒç³»çµ±</div>
        <div class="shop-badge" id="shop-name-display">è¼‰å…¥ä¸­...</div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="setTab('pending')">å¾…è™•ç† <span id="badge-pending" class="badge">0</span></div>
        <div class="tab" onclick="setTab('processing')">è£½ä½œä¸­ <span id="badge-processing" class="badge">0</span></div>
        <div class="tab" onclick="setTab('history')">æ­·å²ç´€éŒ„</div>
    </div>

    <!-- Content -->
    <div class="content-area" id="orders-container">
        <!-- Orders will be injected here -->
    </div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è¨­å®šå€ âš ï¸âš ï¸âš ï¸
        const MY_ADMIN_LIFF_ID = "2008610516-nL4oDLWr"; // è«‹å¡«å…¥ç”³è«‹çš„ Admin LIFF ID
        const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";

        let userProfile = null;
        let allOrders = [];
        let currentTab = 'pending'; // pending, processing, history
        let refreshTimer = null;

        async function initAdmin() {
            try {
                await liff.init({ liffId: MY_ADMIN_LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                userProfile = await liff.getProfile();
                
                // åˆæ¬¡è¼‰å…¥
                await fetchOrders();
                
                // è‡ªå‹•åˆ·æ–° (æ¯ 15 ç§’)
                refreshTimer = setInterval(fetchOrders, 15000);

            } catch (err) {
                showError("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + err.message);
            }
        }

        async function fetchOrders() {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "getStoreOrders",
                        userId: userProfile.userId
                    })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('shop-name-display').innerText = data.shopName;
                    allOrders = data.orders;
                    updateBadges();
                    renderOrders();
                } else {
                    showError(data.message || "æ¬Šé™ä¸è¶³");
                }
            } catch (e) {
                console.error("Fetch error", e);
                // ä¸é¡¯ç¤ºå…¨å±éŒ¯èª¤ï¼Œé¿å…å¹²æ“¾æ“ä½œï¼Œåƒ… log
            }
        }

        function updateBadges() {
            const pendingCount = allOrders.filter(o => o.status === "å¾…ç¢ºèª").length;
            const processingCount = allOrders.filter(o => o.status === "âœ… å·²æ¥å–®" || o.status === "è£½ä½œä¸­").length;

            const b1 = document.getElementById('badge-pending');
            const b2 = document.getElementById('badge-processing');

            b1.innerText = pendingCount;
            b1.style.display = pendingCount > 0 ? 'inline-block' : 'none';
            
            b2.innerText = processingCount;
            b2.style.display = processingCount > 0 ? 'inline-block' : 'none';
        }

        function setTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            // ç°¡å–®çš„é¸å–é‚è¼¯ï¼Œå¯¦éš›é–‹ç™¼å»ºè­°ç”¨ id æˆ– data-attribute
            const tabs = document.querySelectorAll('.tab');
            if(tab === 'pending') tabs[0].classList.add('active');
            if(tab === 'processing') tabs[1].classList.add('active');
            if(tab === 'history') tabs[2].classList.add('active');
            renderOrders();
        }

        function renderOrders() {
            const container = document.getElementById('orders-container');
            container.innerHTML = '';

            let filtered = [];
            if (currentTab === 'pending') {
                filtered = allOrders.filter(o => o.status === "å¾…ç¢ºèª");
            } else if (currentTab === 'processing') {
                filtered = allOrders.filter(o => o.status === "âœ… å·²æ¥å–®" || o.status === "è£½ä½œä¸­");
            } else {
                // History: Exclude pending/processing statuses
                filtered = allOrders.filter(o => !["å¾…ç¢ºèª", "âœ… å·²æ¥å–®", "è£½ä½œä¸­"].includes(o.status));
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">ç›®å‰ç„¡è¨‚å–®</div>';
                return;
            }

            filtered.forEach(o => {
                let btnsHtml = '';
                
                // Dynamic Buttons Logic
                if (o.status === "å¾…ç¢ºèª") {
                    btnsHtml = `
                        <button class="btn btn-danger" onclick="updateStatus('${o.orderId}', 'å·²å©‰æ‹’')">å©‰æ‹’</button>
                        <button class="btn btn-primary" onclick="updateStatus('${o.orderId}', 'âœ… å·²æ¥å–®')">æ¥å–®</button>
                    `;
                } else if (o.status === "âœ… å·²æ¥å–®") {
                    btnsHtml = `<button class="btn btn-gold" onclick="updateStatus('${o.orderId}', 'è£½ä½œä¸­')">é–‹å§‹è£½ä½œ</button>`;
                } else if (o.status === "è£½ä½œä¸­") {
                    btnsHtml = `<button class="btn btn-primary" onclick="updateStatus('${o.orderId}', 'å¯å–é¤')"><i class="fas fa-bell"></i> é€šçŸ¥å–é¤</button>`;
                } else if (o.status === "å¯å–é¤") {
                    btnsHtml = `<button class="btn btn-disabled" onclick="updateStatus('${o.orderId}', 'å·²å®Œæˆ')">å®Œæˆè¨‚å–®</button>`;
                } else {
                    btnsHtml = `<span style="font-size:12px;color:#999;">${o.status}</span>`;
                }

                // Clean Content
                let contentClean = o.content.replace(/----------------/g, '').trim();
                let price = o.total ? `$${o.total}` : '';

                const card = document.createElement('div');
                card.className = 'order-card';
                card.setAttribute('data-status', o.status);
                card.innerHTML = `
                    <div class="oc-header">
                        <div class="oc-id">#${o.orderId.split('-')[1] || o.orderId}</div>
                        <div class="oc-time">${o.time.split(' ')[1] || o.time}</div>
                    </div>
                    <div class="oc-customer">ğŸ‘¤ ${o.customerName}</div>
                    <div class="oc-items">${contentClean}</div>
                    <div class="oc-footer">
                        <div class="oc-price">${price}</div>
                        <div class="oc-actions">${btnsHtml}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function updateStatus(oid, newStatus) {
            if(!confirm(`ç¢ºèªå°‡è¨‚å–®ç‹€æ…‹è®Šæ›´ç‚ºã€Œ${newStatus}ã€ï¼Ÿ`)) return;

            // Show global loading if needed, or button loading
            // é€™è£¡ç°¡å–®ä½¿ç”¨å…¨å± loading
            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "updateStatus",
                        userId: userProfile.userId,
                        orderId: oid,
                        newStatus: newStatus
                    })
                });
                const data = await res.json();
                
                if(data.success) {
                    await fetchOrders(); // Reload data
                } else {
                    alert("æ›´æ–°å¤±æ•—ï¼š" + data.message);
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            } catch(e) {
                alert("ç¶²è·¯éŒ¯èª¤");
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function showError(msg) {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('error-overlay').classList.remove('hidden');
            document.getElementById('error-msg').innerText = msg;
        }

        // Start
        initAdmin();

    </script>
</body>
</html>
