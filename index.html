<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S Tea é»é¤</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* ==================== 0. å…¨å±€èˆ‡é‡ç½® (CHAGEE Standard) ==================== */
    :root { 
      --primary: #B33C3A; /* å“ç‰Œæœ±ç ‚ç´… */
      --gold: #C9A05C;    /* ç²¾ç…‰é‡‘ */ 
      --bg: #FFFFFF;      /* ç´”ç™½èƒŒæ™¯ */ 
      --text: #212121;    /* æ·±é‚ƒé»‘ */ 
      --tea-sidebar: #F7F7F7; 
      --danger: #B33C3A;  
      --success: #7A8B69; 
      --light-bg: #FAFAFA;
      --border: #F0F0F0;
    }

    body { 
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      padding: 0; margin: 0; 
      background-color: var(--bg); 
      color: var(--text); 
      touch-action: manipulation; 
      -webkit-user-select: none; user-select: none; 
      height: 100vh; overflow: hidden; display: flex; flex-direction: column; 
    }
    
    h1, h2, h3, .shop-name, .coupon-val, .spec-header .title, .od-shop-name, .k-shop-name, .page-title {
      font-family: 'Noto Serif TC', serif; 
    }

    .hidden { display: none !important; }
    #loading { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; justify-content: center; align-items: center; color: var(--primary); flex-direction: column; }

    /* é€šç”¨å½ˆçª—é®ç½© */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    /* åº•éƒ¨æ»‘å‡ºé¢æ¿ */
    .modal-sheet { background: #fff; width: 100%; border-radius: 20px 20px 0 0; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; padding-bottom: 20px; position: absolute; bottom: 0; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* ==================== 1. åº•éƒ¨å°èˆª (Tab Bar) ==================== */
    #tab-bar { 
      position: fixed; bottom: 0; left: 0; right: 0; 
      background: #fff; height: 60px; display: flex; 
      border-top: 1px solid #F0F0F0; 
      z-index: 950; padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0; 
      box-shadow: 0 -2px 10px rgba(0,0,0,0.03); 
    }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; transition: all 0.2s; }
    .tab-item.active { color: var(--primary); font-weight: bold; }
    .tab-item.active .tab-icon { transform: translateY(-1px); }
    .tab-icon { font-size: 22px; margin-bottom: 2px; }

    /* ==================== 2. ä¸»è¦–åœ–å®¹å™¨ ==================== */
    .scroll-view { 
      background-color: var(--light-bg); 
      flex: 1; overflow-y: auto; 
      padding-bottom: 80px; 
      -webkit-overflow-scrolling: touch; 
    }

    /* ç°¡å–®é é¢æ¨£å¼ (Home & Member Zone & Construction) */
    .placeholder-page {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100%; text-align: center; padding: 40px; box-sizing: border-box;
    }
    .ip-image {
        width: 120px; height: 120px; object-fit: contain; margin-bottom: 20px;
        opacity: 0.8;
    }
    .placeholder-text {
        font-size: 16px; color: #666; font-family: 'Noto Serif TC'; letter-spacing: 1px;
    }

    /* å„ªæƒ åˆ¸æ¨£å¼ */
    .coupon-grid { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 0 20px; }
    .coupon-item { 
      background: #fff; border-radius: 8px; display: flex; overflow: hidden; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; border: 1px solid #F0F0F0;
    }
    .coupon-left { 
      background: linear-gradient(135deg, var(--primary), #8E2A28); 
      width: 95px; color: #fff; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; text-align: center; padding: 10px; 
      position: relative;
    }
    .coupon-left::after { 
      content: ""; position: absolute; right: -6px; top: 0; bottom: 0; width: 12px; 
      background-image: radial-gradient(circle, #fff 4px, transparent 5px); 
      background-size: 10px 14px; background-repeat: repeat-y; 
    }
    .coupon-val { font-size: 26px; font-weight: bold; }
    .coupon-right { flex: 1; padding: 14px 16px; display: flex; flex-direction: column; justify-content: center; }
    .coupon-name { font-weight: bold; font-size: 15px; color: #212121; margin-bottom: 6px; }
    .coupon-cost { font-size: 12px; color: #888; }
    .btn-redeem { 
      position: absolute; right: 15px; top: 50%; transform: translateY(-50%); 
      background: transparent; border: 1px solid var(--primary); color: var(--primary); 
      padding: 5px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: bold;
    }

    /* æœƒå“¡å¡æ¨£å¼ (My Page) */
    .premium-card { 
      margin: 20px; 
      background: linear-gradient(135deg, #2B2B2B, #1A1A1A); 
      border-radius: 12px; padding: 24px; color: #E0E0E0; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; overflow: hidden; 
    }
    .premium-card::before { 
      content: ""; position: absolute; top: -40px; right: -40px; width: 120px; height: 120px; 
      background: radial-gradient(circle, var(--gold) 0%, transparent 70%); 
      opacity: 0.3; pointer-events: none;
    }
    .card-user-row { display: flex; align-items: center; margin-bottom: 28px; }
    .card-avatar { 
      width: 56px; height: 56px; 
      border-radius: 50%; border: 2px solid var(--gold); 
      margin-right: 15px; 
      object-fit: cover; flex-shrink: 0; 
    }
    .card-stats-row { display: flex; justify-content: space-between; text-align: center; }
    .stat-num { font-size: 22px; font-weight: bold; display: block; margin-bottom: 6px; color: var(--gold); }
    .stat-label { font-size: 11px; opacity: 0.7; letter-spacing: 1px; }
    
    /* [New] æˆ‘çš„åŠŸèƒ½çŸ©é™£å€å¡Š */
    .my-functions-section {
        background: #fff;
        margin: 0 20px 20px 20px;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .section-title {
        font-size: 15px; font-weight: bold; color: #212121; margin-bottom: 20px;
        font-family: 'Noto Sans TC';
    }
    .function-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 25px 10px; /* row-gap col-gap */
    }
    .func-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        cursor: pointer;
    }
    .func-icon {
        font-size: 22px;
        color: #C9A05C; /* Gold Icon */
        margin-bottom: 8px;
    }
    .func-label {
        font-size: 12px;
        color: #666;
    }

    /* History Styles */
    .history-card {
      background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #F0F0F0; position: relative; transition: transform 0.2s;
    }
    .history-card:active { transform: scale(0.98); }
    .hc-header { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid #F5F5F5; padding-bottom: 10px; }
    .hc-shop { font-weight: bold; font-size: 16px; color: #212121; }
    .hc-date { font-size: 12px; color: #999; }
    .hc-body { display: flex; justify-content: space-between; align-items: center; }
    .hc-summary { font-size: 13px; color: #666; line-height: 1.5; flex: 1; padding-right: 10px; }
    .hc-price { font-size: 18px; font-weight: bold; color: var(--primary); }
    .hc-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-top: 5px; }
    .status-wait { background: #FFF8E1; color: #D4A017; }
    .status-ok { background: #E8F5E9; color: var(--success); }
    .status-no { background: #FDEEEE; color: var(--danger); }

    /* ==================== 3. å–®ä¸€å“ç‰Œåº—é‹ªé é¢ (é»å–® View) ==================== */
    #shop-view { background: #fff; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 50; }
    
    .k-header { padding: 10px 15px; background: #fff; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .mode-switch { display: flex; align-items: center; font-size: 16px; }
    .mode-item { font-weight: bold; color: #999; cursor: pointer; transition: color 0.2s; }
    .mode-item.active { color: #000; font-size: 18px; }
    .mode-split { margin: 0 10px; color: #E0E0E0; font-size: 14px; }
    .header-tools i { font-size: 18px; color: #333; }

    .k-shop-info { padding: 5px 15px 10px 15px; background: #fff; position: relative; flex-shrink: 0; }
    .k-shop-name-row { display: flex; align-items: center; margin-bottom: 4px; }
    .k-shop-name { font-size: 16px; font-weight: bold; color: #212121; margin-left: 5px; }
    .k-distance-row { font-size: 11px; color: #999; display: flex; align-items: center; margin-bottom: 8px; }
    .k-friend-order { position: absolute; right: 15px; top: 0px; text-align: center; cursor: pointer; }
    .k-friend-order i { display: block; font-size: 18px; color: var(--gold); margin-bottom: 2px; }
    .k-friend-order span { font-size: 9px; color: #666; }
    .k-announcement-row { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
    .k-tag { border: 1px solid #E0D8CC; color: #8A6D3B; font-size: 10px; padding: 2px 6px; border-radius: 2px; white-space: nowrap; background: #FFFAF0; }

    .k-banner-container { padding: 0 15px 10px 15px; background: #fff; flex-shrink: 0; }
    .k-top-tabs { display: flex; padding: 0 10px 0 10px; background: #fff; overflow-x: auto; scrollbar-width: none; border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .k-tab-item { flex: 0 0 auto; padding: 10px 15px; font-size: 14px; color: #666; cursor: pointer; font-weight: 500; position: relative; }
    .k-tab-item.active { color: #000; font-weight: bold; }
    .k-tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: var(--gold); border-radius: 3px; }

    .shop-body { flex: 1; display: flex; overflow: hidden; position: relative; background: #fff; padding-bottom: 0; }
    .menu-sidebar { width: 85px; background: var(--tea-sidebar); overflow-y: auto; scrollbar-width: none; padding-bottom: 80px; }
    .category-item { padding: 20px 5px; font-size: 12px; color: #666; text-align: center; cursor: pointer; position: relative; font-weight: 500; }
    .category-item.active { background: #fff; color: #212121; font-weight: bold; }
    .category-item.active::before { content: ''; position: absolute; left: 0; top: 18px; bottom: 18px; width: 3px; background: var(--primary); }
    .menu-content { flex: 1; overflow-y: auto; padding: 0 15px 150px 15px; scroll-behavior: smooth; }
    .category-title { font-size: 14px; font-weight: bold; color: #212121; margin: 20px 0 10px 0; }
    .food-item { display: flex; margin-bottom: 20px; }
    .food-img { width: 80px; height: 80px; border-radius: 6px; background-color: #F5F5F5; background-size: cover; background-position: center; flex-shrink: 0; }
    .food-info { flex: 1; padding-left: 12px; display: flex; flex-direction: column; justify-content: space-between; }
    .food-name { font-size: 15px; font-weight: bold; color: #212121; }
    .food-desc { font-size: 11px; color: #999; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-top: 2px; }
    .food-action { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px; }
    .food-price { color: #212121; font-weight: bold; font-size: 15px; }
    .btn-select-spec { background: var(--primary); color: white; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; cursor: pointer; }

    /* Construction Mode for empty tabs */
    .construction-view {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        padding-bottom: 100px; /* Avoid bottom nav */
    }
    .construction-icon {
        width: 100px; height: 100px;
        opacity: 0.6; margin-bottom: 15px;
        background-image: url('https://cdn-icons-png.flaticon.com/512/1865/1865269.png'); /* Cute IP */
        background-size: contain; background-repeat: no-repeat; background-position: center;
    }

    .cart-bar { position: fixed; bottom: 65px; left: 15px; right: 15px; background: #212121; border-radius: 50px; padding: 0; display: flex; justify-content: space-between; align-items: center; color: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 900; height: 50px; cursor: pointer; }
    .cart-left { flex: 1; display: flex; align-items: center; padding-left: 24px; height: 100%; }
    .cart-badge { position: absolute; top: -6px; right: -6px; background: var(--danger); color: #fff; font-size: 10px; padding: 3px 7px; border-radius: 10px; border: 2px solid #fff; }
    .btn-checkout { background: var(--primary); color: #fff; border: none; height: 100%; padding: 0 35px; border-radius: 0 50px 50px 0; font-weight: bold; font-size: 15px; display: flex; align-items: center; letter-spacing: 1px; }

    /* ==================== 4. Modal Styles ==================== */
    /* (Modals CSS unchanged, using previous robust styles) */
    .cart-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 20px; background: #fff; border-bottom: 1px solid #F5F5F5; border-radius: 20px 20px 0 0; }
    .cart-stepper { display: flex; align-items: center; background: #F7F7F7; border-radius: 20px; border: none; }
    .cart-stepper button { width: 30px; height: 30px; border: none; background: transparent; font-size: 12px; display: flex; align-items: center; justify-content: center; color: #212121; }
    .cart-stepper span { font-weight: bold; margin: 0 8px; font-size: 14px; min-width: 20px; text-align: center; color: #212121; }
    .cart-list { padding: 0 20px; max-height: 50vh; overflow-y: auto; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #F7F7F7; }
    
    .spec-header { padding: 20px; display: flex; gap: 15px; border-bottom: 1px solid #F5F5F5; }
    .spec-img { width: 80px; height: 80px; border-radius: 8px; background-color: #eee; background-size: cover; background-position: center; }
    .spec-options { padding: 20px; max-height: 40vh; overflow-y: auto; }
    .option-group { margin-bottom: 10px; padding-bottom: 10px; border-bottom: none !important; }
    .option-title { font-weight: bold; margin-bottom: 10px; color: #212121; font-size: 14px; letter-spacing: 1px; }
    .chip { padding: 8px 18px; background: #F7F7F7; border-radius: 4px; font-size: 13px; color: #666; border: none; cursor: pointer; margin-right: 8px; margin-bottom: 8px; display: inline-block; transition: all 0.2s; }
    .chip.selected { background: var(--primary); color: #fff; font-weight: bold; }
    .spec-add-btn { background: var(--primary); color: #fff; padding: 12px 30px; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: center; box-shadow: 0 4px 12px rgba(179, 60, 58, 0.2); }
    .stepper { display: flex; align-items: center; background: #F7F7F7; border-radius: 4px; padding: 4px 10px; }
    
    #order-detail-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 950; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    .od-paper { background: #fff; width: 100%; max-width: 350px; border-radius: 8px; padding: 0; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; max-height: 85vh; position: relative; }
    .od-paper::before { content: ""; display: block; height: 6px; background: var(--primary); }
    .od-header { padding: 20px; text-align: center; border-bottom: 1px solid #F5F5F5; }
    .od-shop-name { font-size: 20px; font-weight: bold; color: #212121; }
    .od-id { font-size: 11px; color: #999; margin-top: 5px; letter-spacing: 1px; }
    .od-scroll-content { padding: 20px; overflow-y: auto; flex: 1; }
    .od-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #555; }
    .od-total-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #212121; display: flex; justify-content: space-between; align-items: center; }
    .od-total-label { font-size: 14px; font-weight: bold; }
    .od-total-val { font-size: 22px; font-weight: bold; color: #212121; }
    .od-footer { padding: 15px; background: #FAFAFA; text-align: center; border-top: 1px solid #F5F5F5; }
    .btn-close-od { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ccc; background: #fff; color: #333; font-size: 16px; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; margin: 0 auto; }

    .service-option { padding: 15px; border: 1px solid #F0F0F0; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer; margin-bottom: 12px; background: #fff; color: #666; transition: all 0.2s; }
    .service-option.selected { border-color: var(--primary); color: var(--primary); background: #FCEEEE; }

    .modal-content-center { background: #fff; width: 85%; border-radius: 12px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .form-input { width: 100%; padding: 12px; border: 1px solid #E0E0E0; border-radius: 4px; margin-bottom: 15px; box-sizing: border-box; background: #FAFAFA; outline: none; }
    .form-input:focus { border-color: var(--primary); background: #fff; }
    
    .msg-box { background: #fff; width: 80%; max-width: 300px; border-radius: 12px; padding: 30px 20px; text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.3); animation: popIn 0.2s ease-out; }
    .msg-icon { font-size: 48px; margin-bottom: 15px; color: var(--primary); opacity: 0.9; }
    .msg-text { font-size: 16px; font-weight: bold; color: #212121; margin-bottom: 25px; line-height: 1.5; }
    .msg-btns { display: flex; gap: 12px; justify-content: center; }
    .msg-btn { flex: 1; padding: 10px 0; border-radius: 4px; font-size: 14px; font-weight: bold; border: none; cursor: pointer; letter-spacing: 1px; }
    .msg-btn-ok { background: var(--primary); color: #fff; }
    .msg-btn-cancel { background: #F5F5F5; color: #888; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>

  <div id="loading">Uni-S è¼‰å…¥ä¸­...</div>

  <div id="msg-modal-overlay" class="modal-overlay hidden" style="z-index: 2000;">
    <div class="msg-box">
      <div id="msg-icon" class="msg-icon"><i class="fas fa-check-circle"></i></div>
      <div id="msg-text" class="msg-text">...</div>
      <div class="msg-btns">
        <button id="msg-btn-no" class="msg-btn msg-btn-cancel hidden" onclick="closeMsgModal(false)">å–æ¶ˆ</button>
        <button id="msg-btn-yes" class="msg-btn msg-btn-ok" onclick="closeMsgModal(true)">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- 1. é¦–é  (Home) - Simple Placeholder -->
  <div id="home-view" class="scroll-view hidden">
    <div class="placeholder-page">
        <!-- Replace with your cute IP image URL -->
        <img src="https://cdn-icons-png.flaticon.com/512/1865/1865269.png" alt="Cute IP" class="ip-image">
        <div class="placeholder-text">ç™¼å±•åˆæœŸï¼Œçµ¦äºˆå»ºè­°</div>
    </div>
  </div>

  <!-- 2. é»å–® (Menu) - The Main Ordering View -->
  <div id="shop-view" class="hidden">
    <!-- Top Header -->
    <div class="k-header">
        <div class="mode-switch">
            <span class="mode-item active">å ‚é£Ÿ</span>
            <span class="mode-split">|</span>
            <span class="mode-item">å¤–è³£</span>
        </div>
        <div class="header-tools">
            <i class="fas fa-search" style="margin-right: 15px;"></i>
            <i class="fas fa-ellipsis-h"></i>
        </div>
    </div>

    <!-- Shop Info -->
    <div class="k-shop-info">
        <div class="k-shop-name-row">
            <i class="fas fa-star" style="color:var(--gold); font-size:14px; margin-right:6px;"></i>
            <span id="current-shop-name" class="k-shop-name">è¼‰å…¥ä¸­...</span>
            <div id="shop-announcement-btn" onclick="openStoreDetailModal()" style="margin-left: 10px; color: #999; cursor: pointer;"><i class="fas fa-chevron-right"></i></div>
            
            <div class="k-friend-order" onclick="showMsg('å¥½å‹æ‹¼å–®åŠŸèƒ½é–‹ç™¼ä¸­')">
                <i class="fas fa-glass-cheers"></i>
                <span>å¥½å‹æ‹¼å–®</span>
            </div>
        </div>
        <div class="k-distance-row">
            <i class="fas fa-location-arrow" style="margin-right: 5px;"></i>
            <span id="shop-distance">è·æ‚¨ 0.0 km</span>
        </div>
        <div class="k-announcement-row">
             <div class="k-tag" id="anno-1">æŒ‡å®šå•†å“ç‰¹åƒ¹98å…ƒèµ·</div>
             <div class="k-tag" id="anno-2">æ­¡è¿å…‰è‡¨ Uni-S</div>
        </div>
    </div>

    <!-- Banner -->
    <div class="k-banner-container">
        <div id="shop-banner" style="width:100%; height:100px; background-size:cover; background-position:center; border-radius:8px; background-image:url('https://images.unsplash.com/photo-1544787219-7f47ccb76574?q=80&w=600');"></div>
    </div>

    <!-- Top Category Tabs -->
    <div class="k-top-tabs">
        <div class="k-tab-item active" onclick="switchCategoryTab('classic', this)">ç¶“å…¸èœå–®</div>
        <div class="k-tab-item" onclick="switchCategoryTab('research_a', this)">å€åŸŸå¥—é¤</div>
        <div class="k-tab-item" onclick="switchCategoryTab('research_b', this)">ç¾èƒå°ˆå€</div>
        <div class="k-tab-item" onclick="switchCategoryTab('retail', this)">é›¶å”®å‘¨é‚Š</div>
    </div>
    
    <!-- Content Area -->
    <div class="shop-body">
      <div class="menu-sidebar" id="food-sidebar"></div>
      <div class="menu-content" id="food-content"></div>
      
      <!-- Retail will now use placeholder style dynamically -->
      <div id="mode-retail" class="retail-grid hidden" style="display:none;"></div>
      
      <!-- Construction Mode -->
      <div id="mode-construction" class="construction-view hidden">
          <i class="fas fa-hard-hat" style="font-size: 60px; color: #E0E0E0; margin-bottom: 20px;"></i>
          <div class="placeholder-text">ç ”ç™¼ä¸­</div>
      </div>
    </div>
    
    <!-- Cart Bar -->
    <div id="cart-bar" class="cart-bar" style="display:none;">
      <div class="cart-left" onclick="openCartModal()">
        <div style="position:relative;margin-right:15px;"><i class="fas fa-shopping-bag" style="font-size:24px;"></i><div class="cart-badge" id="cart-count">0</div></div>
        <div style="font-size:18px;font-weight:bold;">$<span id="cart-total">0</span></div>
      </div>
      <div class="btn-checkout" onclick="preCheckout()">å»çµç®—</div>
    </div>
  </div>

  <!-- 3. å–èŒ¶ (History) -->
  <div id="history-view" class="scroll-view hidden">
    <div style="padding:20px 20px 10px 20px; display:flex; align-items:center;">
        <div style="font-weight:bold; font-size:20px; color:#212121;">æ­·å²è¨‚å–®</div>
    </div>
    <div id="history-list-container" style="padding: 20px;">
        <div style="text-align:center;color:#999;font-size:12px;">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <!-- 4. æœƒå“¡å°ˆå€ (Member Zone) -->
  <div id="member-zone-view" class="scroll-view hidden">
    <div class="placeholder-page">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Member IP" class="ip-image">
        <div class="placeholder-text">æœƒå“¡æ¬Šç›Šå¾…ç ”ç™¼</div>
    </div>
  </div>

  <!-- 5. æˆ‘çš„ (My) - Redesigned -->
  <div id="my-view" class="scroll-view hidden" style="padding-top: 20px;">
    <!-- Member Card -->
    <div class="premium-card">
      <div class="card-user-row">
          <img id="m-avatar" src="" class="card-avatar" style="border:2px solid var(--gold);">
          <div style="flex:1;">
              <div id="m-name" style="font-size:20px;font-weight:bold;color:var(--gold);font-family:'Noto Serif TC';">...</div>
              <div style="font-size:11px;background:rgba(201, 160, 92, 0.2);color:#E0E0E0;padding:3px 10px;border-radius:12px;display:inline-block;margin-top:6px;border:1px solid rgba(201, 160, 92, 0.3);">æ™®é€šæœƒå“¡</div>
          </div>
          <i class="fas fa-cog" onclick="openEditModal()" style="font-size:20px;color:rgba(255,255,255,0.6);cursor:pointer;"></i>
      </div>
      <div class="card-stats-row">
          <div class="stat-box"><span class="stat-num">0</span><span class="stat-label">é¤˜é¡</span></div>
          <div class="stat-box" style="border-left:1px solid rgba(255,255,255,0.1); border-right:1px solid rgba(255,255,255,0.1);">
              <span class="stat-num" id="m-points">0</span><span class="stat-label">ç©åˆ†</span>
          </div>
          <div class="stat-box"><span class="stat-num">2</span><span class="stat-label">å„ªæƒ åˆ¸</span></div>
      </div>
    </div>

    <!-- My Functions Grid (3x2) -->
    <div class="my-functions-section">
        <div class="section-title">æˆ‘çš„åŠŸèƒ½</div>
        <div class="function-grid">
            <div class="func-item" onclick="showMsg('åœ°å€ç®¡ç†é–‹ç™¼ä¸­')">
                <i class="fas fa-map-marker-alt func-icon"></i>
                <div class="func-label">åœ°å€ç®¡ç†</div>
            </div>
            <div class="func-item" onclick="showMsg('å­¸ç”Ÿèªè­‰é–‹ç™¼ä¸­')">
                <i class="fas fa-graduation-cap func-icon"></i>
                <div class="func-label">å­¸ç”Ÿèªè­‰</div>
            </div>
            <div class="func-item" onclick="showMsg('è»äººèªè­‰é–‹ç™¼ä¸­')">
                <i class="fas fa-user-shield func-icon"></i>
                <div class="func-label">è»äººèªè­‰</div>
            </div>
            <div class="func-item" onclick="showMsg('ç¦®å“å¡åŠŸèƒ½é–‹ç™¼ä¸­')">
                <i class="fas fa-gift func-icon"></i>
                <div class="func-label">ç¦®å“å¡</div>
            </div>
            <div class="func-item" onclick="showMsg('åŠ ç›Ÿè«®è©¢é€£æ¥ä¸­')">
                <i class="fas fa-comments func-icon"></i>
                <div class="func-label">åŠ ç›Ÿè«®è©¢</div>
            </div>
            <div class="func-item" onclick="showMsg('æŸ¥çœ‹å”è­°åŠæ”¿ç­–')">
                <i class="fas fa-file-contract func-icon"></i>
                <div class="func-label">å”è­°åŠæ”¿ç­–</div>
            </div>
        </div>
    </div>
  </div>

  <!-- Store Detail Modal -->
  <div id="store-detail-modal" class="modal-overlay hidden" onclick="document.getElementById('store-detail-modal').classList.add('hidden')">
    <div class="modal-sheet" style="max-height: 50vh; padding: 20px;" onclick="event.stopPropagation()">
        <div style="text-align: center; font-weight: bold; font-size: 18px; color: #212121; margin-bottom: 20px;">é–€åº—è³‡è¨Š</div>
        <div class="detail-row" style="margin-bottom: 15px;">
            <div style="font-weight: bold; color:#555; font-size: 13px;">é–€åº—å…¬å‘Š</div>
            <p id="modal-announcement" style="font-size: 14px; color:#212121; margin: 5px 0; line-height: 1.5;">...</p>
        </div>
        <div class="detail-row" style="margin-bottom: 15px;">
            <div style="font-weight: bold; color:#555; font-size: 13px;">é–€åº—åœ°å€</div>
            <p id="modal-address" style="font-size: 14px; color:#212121; margin: 5px 0; line-height: 1.5;">...</p>
        </div>
        <div style="display:flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #F5F5F5;">
            <div style="color: #666; font-size: 13px;">è¯ç¹«åº—é•·ï¼š<span id="modal-phone" style="color:#212121; font-weight:bold;">...</span></div>
            <a id="modal-call-btn" href="#" class="btn-nav" style="padding: 8px 20px; font-size: 13px; background: var(--primary); color: white; border:none; text-decoration:none; border-radius:20px;">æ’¥æ‰“</a>
        </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal" class="modal-overlay hidden" onclick="closeCartModal()">
    <div class="modal-sheet" style="padding:0;" onclick="event.stopPropagation()">
      <div class="cart-header"><div style="font-weight:bold;font-size:16px;color:#212121;">è³¼ç‰©è»Šå…§å®¹</div><div onclick="closeCartModal()" style="cursor:pointer;padding:5px;color:#999;"><i class="fas fa-chevron-down"></i></div></div>
      <div style="background:#FAFAFA;padding:10px 20px;font-size:12px;color:#888;display:flex;justify-content:space-between;align-items:center;"><span>å·²é¸å•†å“</span><span onclick="clearCart()" style="cursor:pointer;color:#B33C3A;"><i class="fas fa-trash"></i> æ¸…ç©º</span></div>
      <div id="cart-list" class="cart-list"></div>
      <div style="height:20px;"></div>
    </div>
  </div>

  <!-- Spec Modal -->
  <div id="spec-modal" class="modal-overlay hidden">
    <div class="modal-sheet">
      <div style="text-align:right;padding:15px;"><i class="fas fa-times" onclick="closeSpecModal()" style="font-size:22px;color:#ccc;cursor:pointer;"></i></div>
      <div class="spec-header"><div class="spec-img" id="sp-img"></div><div><div class="title" style="font-size:20px;font-weight:bold;color:#212121;" id="sp-name"></div><div style="font-size:13px;color:#888;margin-top:5px;" id="sp-desc"></div></div></div>
      <div id="sp-options" class="spec-options"></div>
      <div class="spec-footer" style="padding:15px 20px; border-top:1px solid #F0F0F0;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;"><div style="font-size:22px;font-weight:bold;color:var(--primary);font-family:'Noto Serif TC';">$<span id="sp-price">0</span></div><div class="stepper"><button onclick="updateSpQty(-1)">-</button><span id="sp-qty" style="margin:0 10px;font-weight:bold;">1</span><button onclick="updateSpQty(1)">+</button></div></div>
        <div class="spec-add-btn" onclick="addSpecToCart()">åŠ å…¥è³¼ç‰©è»Š</div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="service-modal" class="modal-overlay hidden">
    <div class="modal-sheet">
      <div style="padding:25px;">
        <div style="text-align:center;font-weight:bold;font-size:18px;margin-bottom:20px;color:#212121;">é¸æ“‡æœå‹™æ–¹å¼</div>
        <div id="service-options"></div>
        <div style="margin-top:25px;"><div style="font-weight:bold;margin-bottom:10px;color:#4A4A4A;">å„ªæƒ åˆ¸</div><select id="coupon-selector" style="width:100%;padding:12px;border-radius:4px;border:1px solid #E0E0E0;background:#FAFAFA;color:#4A4A4A;outline:none;"><option value="">ä¸ä½¿ç”¨å„ªæƒ åˆ¸</option></select></div>
        <div style="margin-top:25px;text-align:right;"><span style="font-size:14px;color:#888;">å¯¦ä»˜é‡‘é¡</span><span id="final-checkout-price" style="font-size:24px;font-weight:bold;color:var(--danger);margin-left:8px;font-family:'Noto Serif TC';">$0</span></div>
        <div class="spec-add-btn" style="text-align:center;margin-top:20px;" onclick="confirmOrder()">ç¢ºèªä¸‹å–®</div>
        <div style="text-align:center;margin-top:15px;color:#999;font-size:13px;cursor:pointer;" onclick="document.getElementById('service-modal').classList.add('hidden')">å–æ¶ˆ</div>
      </div>
    </div>
  </div>

  <!-- Order Detail -->
  <div id="order-detail-view" class="hidden">
    <div class="od-paper">
      <div class="od-header"><div class="od-shop-name" id="od-shop-name">...</div><div class="od-id">å–®è™Ÿï¼š<span id="od-id"></span></div><div style="margin-top:10px;"><span id="od-status" style="font-weight:bold;font-size:13px;padding:3px 8px;border-radius:4px;background:#eee;">...</span></div></div>
      <div class="od-scroll-content" id="od-items-list"></div>
      <div style="padding:20px;background:#fff;"><div class="od-total-section"><span class="od-total-label">ç¸½è¨ˆé‡‘é¡</span><span class="od-total-val" id="od-total-price">...</span></div><div id="od-cancel-container" style="margin-top:20px;"></div></div>
      <div class="od-footer"><button class="btn-close-od" onclick="closeOrderDetail()"><i class="fas fa-times"></i></button></div>
    </div>
  </div>

  <div id="edit-modal" class="modal-overlay hidden">
    <div class="modal-content-center">
      <div style="text-align:center;font-weight:bold;margin-bottom:20px;font-size:18px;color:#212121;">ç·¨è¼¯è³‡æ–™</div>
      <div style="margin-bottom:12px;"><label style="font-size:12px;color:#888;margin-bottom:4px;display:block;">å§“å</label><input type="text" id="edit-name" class="form-input"></div>
      <div style="margin-bottom:12px;"><label style="font-size:12px;color:#888;margin-bottom:4px;display:block;">é›»è©±</label><input type="tel" id="edit-phone" class="form-input"></div>
      <div style="margin-bottom:20px;"><label style="font-size:12px;color:#888;margin-bottom:4px;display:block;">ç”Ÿæ—¥</label><input type="date" id="edit-birthday" class="form-input"></div>
      <div style="display:flex;gap:12px;"><div style="flex:1;text-align:center;padding:12px;background:#F0EDE5;color:#666;border-radius:4px;cursor:pointer;" onclick="closeEditModal()">å–æ¶ˆ</div><div class="btn-save" style="flex:1;text-align:center;padding:12px;background:var(--primary);color:#fff;border-radius:4px;font-weight:bold;cursor:pointer;" onclick="saveProfile()">å„²å­˜</div></div>
    </div>
  </div>

  <!-- Tab Bar -->
  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('home')">
        <div class="tab-icon"><i class="fas fa-home"></i></div>
        <div>é¦–é </div>
    </div>
    <div class="tab-item" onclick="switchTab('menu')">
        <div class="tab-icon"><i class="fas fa-mug-hot"></i></div>
        <div>é»å–®</div>
    </div>
    <div class="tab-item" onclick="switchTab('history')">
        <div class="tab-icon"><i class="fas fa-receipt"></i></div>
        <div>å–èŒ¶</div>
    </div>
    <div class="tab-item" onclick="switchTab('member-zone')">
        <div class="tab-icon"><i class="fas fa-crown"></i></div>
        <div>æœƒå“¡å°ˆå€</div>
    </div>
    <div class="tab-item" onclick="switchTab('my')">
        <div class="tab-icon"><i class="fas fa-user"></i></div>
        <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";
    const TARGET_SHOP_ID = "1"; 

    let allShops = {}; let currentShop = null; let cart = []; 
    let userProfile = null; let orderCache = []; let selectedService = "";
    let currentItem = null; let currentOptions = {}; let currentQty = 1;
    let userLocation = null;
    let myCoupons = []; 
    let modalCb = null;

    function showMsg(txt, cb, showOkBtn = true) { 
      document.getElementById('msg-text').innerText = txt; 
      document.getElementById('msg-btn-no').classList.add('hidden'); 
      const yesBtn = document.getElementById('msg-btn-yes');
      if (showOkBtn) { yesBtn.classList.remove('hidden'); } else { yesBtn.classList.add('hidden'); }
      document.getElementById('msg-modal-overlay').classList.remove('hidden'); 
      modalCb = cb; 
    }
    function showLoadingMsg(txt) { showMsg(txt, null, false); }
    function showConfirm(txt, cb) {
      document.getElementById('msg-text').innerText = txt; 
      document.getElementById('msg-btn-no').classList.remove('hidden');
      document.getElementById('msg-btn-yes').classList.remove('hidden'); 
      document.getElementById('msg-modal-overlay').classList.remove('hidden');
      modalCb = cb;
    }
    function closeMsgModal(isYes) {
      document.getElementById('msg-modal-overlay').classList.add('hidden');
      if(isYes && modalCb) modalCb();
      modalCb = null;
    }

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        updateUI();

        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        if (allShops[TARGET_SHOP_ID]) {
            openShopDataOnly(TARGET_SHOP_ID); 
        } else {
            showMsg("åº—å®¶è¨­å®šéŒ¯èª¤ (ID Not Found)");
        }
        
        switchTab('home');
        
        await initLocationService();
        // [Fixed] Update distance AFTER location service returns
        if(userLocation && currentShop && currentShop.lat) {
            const dist = calculateDistance(userLocation.lat, userLocation.lng, currentShop.lat, currentShop.lng);
            const distEl = document.getElementById('shop-distance');
            if(distEl) distEl.innerText = `è·æ‚¨ ${dist} km`;
        }
        fetchMemberData();
      } catch (err) { showMsg(err.message); }
    }

    function updateUI() { 
        const mName = document.getElementById('m-name');
        const mAvatar = document.getElementById('m-avatar');
        if (mName) mName.innerText = userProfile.displayName;
        if (mAvatar) mAvatar.src = userProfile.pictureUrl;
    }

    function openShopDataOnly(id) {
        currentShop = allShops[id]; 
        currentShop.id = id; 
        
        // [Fixed] Ensure correct spelling 'getElementById'
        document.getElementById('current-shop-name').innerText = currentShop.name;
        // document.getElementById('shop-address').innerText = currentShop.address || ""; 
        document.getElementById('modal-address').innerText = currentShop.address || "";
        document.getElementById('modal-announcement').innerText = currentShop.openHours || "ç‡Ÿæ¥­æ™‚é–“ï¼š09:00-22:00";
        document.getElementById('modal-phone').innerText = "188****6289"; 
        if (currentShop.bannerUrl) {
            document.getElementById('shop-banner').style.backgroundImage = `url(${currentShop.bannerUrl})`;
        }
        renderFoodMenu();
    }

    function renderPlaceholder(containerId, message) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = `
            <div class="placeholder-page" style="height:100%;">
                <i class="fas fa-hard-hat fa-3x" style="color:#C9A05C; margin-bottom: 20px; opacity:0.6;"></i>
                <div class="placeholder-text">${message}</div>
            </div>
        `;
    }

    function switchCategoryTab(type, el) {
        document.querySelectorAll('.k-tab-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
        
        const foodSidebar = document.getElementById('food-sidebar');
        const foodContent = document.getElementById('food-content');
        const modeRetail = document.getElementById('mode-retail');
        const modeConstruction = document.getElementById('mode-construction');

        // Reset All
        foodSidebar.style.display = 'none';
        foodContent.style.display = 'none';
        modeRetail.style.display = 'none';
        modeConstruction.style.display = 'none';

        if (type === 'classic') {
            foodSidebar.style.display = 'block';
            foodContent.style.display = 'block';
            renderFoodMenu(); // [Fixed] Force Render Classic Menu
        } else if (type === 'retail') {
            // [Fixed] Retail as Construction Mode
            modeRetail.style.display = 'flex';
            modeRetail.className = 'construction-view'; // Use shared centered flex style
            renderPlaceholder('mode-retail', 'é›¶å”®å‘¨é‚Š ç ”ç™¼ä¸­');
        } else if (type === 'research_a') {
            modeConstruction.style.display = 'flex';
            modeConstruction.classList.remove('hidden');
            renderPlaceholder('mode-construction', 'å€åŸŸå¥—é¤ ç ”ç™¼ä¸­');
        } else if (type === 'research_b') {
            modeConstruction.style.display = 'flex';
            modeConstruction.classList.remove('hidden');
            renderPlaceholder('mode-construction', 'ç¾èƒå°ˆå€ ç ”ç™¼ä¸­');
        }
    }

    // ========== æ ¸å¿ƒè·¯ç”± (5 Tabs) ==========
    function switchTab(tab) {
        ['home-view', 'shop-view', 'member-zone-view', 'history-view', 'my-view', 'coupons-view', 'order-detail-view'].forEach(id => {
             const el = document.getElementById(id);
             if(el) el.classList.add('hidden');
        });

        const tabBar = document.getElementById('tab-bar');
        tabBar.classList.remove('hidden');

        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        
        if (tab === 'home') {
            document.getElementById('home-view').classList.remove('hidden');
            document.querySelectorAll('.tab-item')[0].classList.add('active');
        } else if (tab === 'menu') {
            document.getElementById('shop-view').classList.remove('hidden');
            document.querySelectorAll('.tab-item')[1].classList.add('active');
            // Default to Classic Menu
            const firstTab = document.querySelector('.k-top-tabs .k-tab-item:nth-child(1)');
            if(firstTab) switchCategoryTab('classic', firstTab);
            updateCartUI();
        } else if (tab === 'history') {
            document.getElementById('history-view').classList.remove('hidden');
            document.querySelectorAll('.tab-item')[2].classList.add('active');
            loadOrderHistory();
        } else if (tab === 'member-zone') {
            document.getElementById('member-zone-view').classList.remove('hidden');
            document.querySelectorAll('.tab-item')[3].classList.add('active');
        } else if (tab === 'my') {
            document.getElementById('my-view').classList.remove('hidden');
            document.querySelectorAll('.tab-item')[4].classList.add('active');
            fetchMemberData();
            loadMyCoupons();
        }
    }

    function openStoreDetailModal() {
        document.getElementById('store-detail-modal').classList.remove('hidden');
    }

    async function loadCoupons() {
        const list = document.getElementById('coupons-list');
        list.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">è¼‰å…¥å„ªæƒ åˆ¸ä¸­...</div>';
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getCoupons" }) });
            const text = await res.text();
            let coupons; try { coupons = JSON.parse(text); } catch (e) { throw new Error("Server Error"); }
            if (coupons.status === 'error') throw new Error(coupons.message);
            if (!Array.isArray(coupons) || coupons.length === 0) { list.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;margin-top:20px;">ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>'; return; }
            let html = '';
            coupons.forEach(c => {
                html += `<div class="coupon-item"><div class="coupon-left"><div class="coupon-val">$${c.value}</div><div style="font-size:10px;">æŠµç”¨åˆ¸</div></div><div class="coupon-right"><div class="coupon-name">${c.name}</div><div class="coupon-cost">éœ€ ${c.cost} ç©åˆ†</div><div class="btn-redeem" onclick="redeemCoupon('${c.id}')">ç«‹å³å…Œæ›</div></div></div>`;
            });
            list.innerHTML = html;
        } catch(e) { list.innerHTML = `<div style="text-align:center;color:var(--danger);">è¼‰å…¥å¤±æ•—</div>`; }
    }

    async function redeemCoupon(id) {
        showConfirm("ç¢ºå®šè¦å…Œæ›é€™å¼µå„ªæƒ åˆ¸å—ï¼Ÿ", async () => {
            showLoadingMsg("è™•ç†ä¸­...");
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "redeemCoupon", userId: userProfile.userId, couponId: id }) });
                setTimeout(() => { showMsg("âœ… å…Œæ›è«‹æ±‚å·²é€å‡ºï¼", () => { fetchMemberData(); }); }, 1500);
            } catch(e) { showMsg("éŒ¯èª¤ï¼š" + e.message); }
        });
    }

    async function loadMyCoupons() {
        const list = document.getElementById('my-coupons-list');
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMyCoupons", userId: userProfile.userId }) });
            const text = await res.text();
            try { myCoupons = JSON.parse(text); } catch(e) { myCoupons = []; }
            if (myCoupons.length === 0) { list.innerHTML = 'å°šç„¡å„ªæƒ åˆ¸'; } else {
                let html = '';
                myCoupons.forEach(c => {
                    html += `<div class="my-coupon-item"><div><div style="font-weight:bold;color:#212121;">${c.name}</div><div style="font-size:11px;color:#999;">æŠ˜æŠµ $${c.value}</div></div><div style="color:var(--primary);font-weight:bold;font-size:12px;border:1px solid var(--primary);padding:2px 8px;border-radius:10px;">æœªä½¿ç”¨</div></div>`;
                });
                list.innerHTML = html;
            }
        } catch(e) { list.innerHTML = 'è¼‰å…¥å¤±æ•—'; }
    }

    async function preCheckout() {
      if(cart.length===0) { showMsg("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }
      const svcs = currentShop.services || ["è‡ªå–"];
      let html = '';
      svcs.forEach((s,i) => { html += `<div class="service-option ${i===0?'selected':''}" onclick="selSvc(this,'${s}')">${s}</div>`; if(i===0) selectedService = s; });
      document.getElementById('service-options').innerHTML = html;
      const select = document.getElementById('coupon-selector');
      select.innerHTML = '<option value="" data-val="0">ä¸ä½¿ç”¨å„ªæƒ åˆ¸</option>';
      select.onchange = updateFinalPrice; 
      try {
          const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMyCoupons", userId: userProfile.userId }) });
          const text = await res.text();
          myCoupons = JSON.parse(text);
          myCoupons.forEach(c => {
              let opt = document.createElement('option');
              opt.value = c.uuid;
              opt.setAttribute('data-val', c.value);
              opt.innerText = `${c.name} (æŠ˜æŠµ $${c.value})`;
              select.appendChild(opt);
          });
      } catch(e) {}
      updateFinalPrice();
      document.getElementById('service-modal').classList.remove('hidden');
    }

    function updateFinalPrice() {
        const select = document.getElementById('coupon-selector');
        const discount = parseInt(select.options[select.selectedIndex].getAttribute('data-val') || 0);
        const cartTotal = parseInt(document.getElementById('cart-total').innerText);
        const final = Math.max(0, cartTotal - discount);
        document.getElementById('final-checkout-price').innerText = "$" + final;
    }

    async function confirmOrder() {
      document.getElementById('service-modal').classList.add('hidden');
      const select = document.getElementById('coupon-selector');
      const couponUuid = select.value;
      const discount = parseInt(select.options[select.selectedIndex].getAttribute('data-val') || 0);
      let detail = "", total = 0;
      cart.forEach(x => { detail += `${x.name} x ${x.qty} ($${x.total})\n`; total += x.total; });
      detail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ\næœå‹™æ–¹å¼ï¼š${selectedService}`;
      if (discount > 0) { detail += `\nå„ªæƒ åˆ¸æŠ˜æŠµï¼š-$${discount}\nå¯¦ä»˜é‡‘é¡ï¼š$${Math.max(0, total - discount)}`; }
      let phone = localStorage.getItem("uni_user_phone");
      if(!phone) { phone = prompt("è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼š"); if(!phone) return; localStorage.setItem("uni_user_phone", phone); }
      detail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${phone}`;
      showLoadingMsg("è™•ç†ä¸­...");
      try {
        await liff.sendMessages([{type:"text", text:`ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${detail}`}]);
        await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({ shopId:currentShop.id, userName:userProfile.displayName, userId:userProfile.userId, order:detail, couponUuid: couponUuid })
        });
        showMsg("âœ… è¨‚å–®å·²é€å‡ºï¼", () => { 
            cart=[]; 
            updateCartUI(); 
            switchTab('history'); 
        });
      } catch(e) { showMsg("å¤±æ•—:"+e.message); }
    }
    
    function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = deg2rad(lat2 - lat1); const dLon = deg2rad(lon2 - lon1); const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return (R * c).toFixed(1); }
    function deg2rad(deg) { return deg * (Math.PI/180); }
    function initLocationService() { return new Promise((resolve) => { if (!navigator.geolocation) { resolve(); return; } const timeoutId = setTimeout(() => { resolve(); }, 5000); navigator.geolocation.getCurrentPosition((position) => { clearTimeout(timeoutId); userLocation = { lat: position.coords.latitude, lng: position.coords.longitude }; resolve(); }, (error) => { clearTimeout(timeoutId); resolve(); }); }); }
    function openMap() { if (currentShop) { if (currentShop.address && currentShop.address.trim() !== "") { window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(currentShop.address)}`, '_blank'); } else if (currentShop.lat && currentShop.lng) { window.open(`https://www.google.com/maps/dir/?api=1&destination=${currentShop.lat},${currentShop.lng}`, '_blank'); } else { showMsg("ç„¡æ³•å–å¾—å•†å®¶ä½ç½®è³‡è¨Š"); } } }
    
    function renderFoodMenu() { 
        const catList = document.getElementById('food-sidebar'); 
        const prodList = document.getElementById('food-content'); 
        catList.innerHTML = ''; prodList.innerHTML = ''; 
        
        let menu = [];
        if (currentShop.menu && Array.isArray(currentShop.menu)) {
             if (currentShop.menu.length > 0 && currentShop.menu[0].category) {
                 menu = currentShop.menu;
             } else {
                 menu = [{category:"å…¨éƒ¨", items:currentShop.menu}];
             }
        }

        menu.forEach((cat, idx) => { 
            catList.innerHTML += `<div class="category-item ${idx===0?'active':''}" id="cat-btn-${idx}" onclick="document.getElementById('cat-sec-${idx}').scrollIntoView({behavior:'smooth'})">${cat.category}</div>`; 
            let itemsHtml = ''; 
            if(cat.items && Array.isArray(cat.items)) {
                cat.items.forEach(item => { 
                    let itemJson = JSON.stringify(item).replace(/"/g, '&quot;'); 
                    itemsHtml += `
                    <div class="food-item" onclick="openSpecModal(${itemJson})">
                        <div class="food-img" style="background-image:url(${item.img||currentShop.bannerUrl})"></div>
                        <div class="food-info">
                            <div><div class="food-name">${item.name}</div><div class="food-desc">${item.desc||''}</div></div>
                            <div class="food-action">
                                <div class="food-price">$${item.price}</div>
                                <div class="btn-select-spec">é¸è¦æ ¼</div>
                            </div>
                        </div>
                    </div>`; 
                }); 
            }
            prodList.innerHTML += `<div id="cat-sec-${idx}" class="cat-section"><div class="category-title">${cat.category}</div>${itemsHtml}</div>`; 
        }); 
        
        prodList.onscroll = function() { 
            const secs = document.querySelectorAll('.cat-section'); 
            secs.forEach((sec,i) => { 
                if(sec.offsetTop - prodList.offsetTop <= prodList.scrollTop + 50) { 
                    document.querySelectorAll('.category-item').forEach(e=>e.classList.remove('active')); 
                    const btn = document.getElementById(`cat-btn-${i}`);
                    if(btn) btn.classList.add('active'); 
                } 
            }); 
        }; 
    }
    
    function openSpecModal(item) { currentItem = item; currentQty = 1; currentOptions = {}; document.getElementById('sp-name').innerText = item.name; document.getElementById('sp-desc').innerText = item.desc||''; document.getElementById('sp-price').innerText = item.price; document.getElementById('sp-img').style.backgroundImage = `url(${item.img||currentShop.bannerUrl})`; document.getElementById('sp-qty').innerText = 1; let html = ''; for (let [k, vals] of Object.entries(item.options||{})) { currentOptions[k] = vals[0]; let chips = vals.map((v,i) => `<div class="chip ${i===0?'selected':''}" onclick="selOpt(this,'${k}','${v}')">${v}</div>`).join(''); html += `<div class="option-group"><div class="option-title">${k}</div><div class="option-chips" style="display:flex;gap:8px;flex-wrap:wrap;">${chips}</div></div>`; } document.getElementById('sp-options').innerHTML = html || '<div style="color:#999;font-size:12px;">ç„¡è¦æ ¼é¸é …</div>'; document.getElementById('spec-modal').classList.remove('hidden'); }
    function selOpt(el, k, v) { el.parentNode.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); currentOptions[k] = v; }
    function updateSpQty(n) { if(currentQty+n>0) { currentQty+=n; document.getElementById('sp-qty').innerText=currentQty; document.getElementById('sp-price').innerText=currentItem.price*currentQty; } }
    function addSpecToCart() { let opts = Object.values(currentOptions).join('/'); if(opts) opts = `(${opts})`; cart.push({name: currentItem.name + " " + opts, price: currentItem.price, qty: currentQty, total: currentItem.price*currentQty}); document.getElementById('spec-modal').classList.add('hidden'); updateCartUI(); }
    function updateCartRetail(name, price, change) { let exist = cart.find(x => x.name === name); if(exist) { exist.qty += change; if(exist.qty<=0) cart = cart.filter(x=>x.name!==name); else exist.total = exist.price*exist.qty; } else if(change>0) cart.push({name:name, price:price, qty:1, total:price, opts:""}); updateCartUI(); currentShop.menu.forEach((item,idx) => { let el = document.getElementById(`r-qty-${idx}`); let inCart = cart.find(x=>x.name===item.name); if(el) el.innerText = inCart?inCart.qty:0; }); }
    function updateCartUI() { let totalQty = cart.reduce((a,b)=>a+b.qty,0); let totalPrice = cart.reduce((a,b)=>a+b.total,0); if(totalQty > 0) { document.getElementById('cart-bar').style.display = 'flex'; document.getElementById('cart-count').innerText = totalQty; document.getElementById('cart-total').innerText = totalPrice; } else { document.getElementById('cart-bar').style.display = 'none'; closeCartModal(); } }
    function openCartModal() { if(cart.length===0) { closeCartModal(); return; } const list = document.getElementById('cart-list'); let html = ''; cart.forEach((item, idx) => { html += ` <div class="cart-item"> <div style="flex:1;"> <div style="font-size:15px;font-weight:bold;margin-bottom:4px;">${item.name}</div> <div style="font-size:12px;color:#999;">$${item.price}</div> </div> <div style="display:flex;align-items:center;gap:15px;"> <div style="font-weight:bold;min-width:40px;text-align:right;">$${item.total}</div> <div class="cart-stepper"> <button onclick="updateCartItemQty(${idx}, -1)"><i class="fas fa-minus"></i></button> <span>${item.qty}</span> <button onclick="updateCartItemQty(${idx}, 1)"><i class="fas fa-plus"></i></button> </div> </div> </div>`; }); list.innerHTML = html; document.getElementById('cart-modal').classList.remove('hidden'); }
    function updateCartItemQty(idx, change) { let item = cart[idx]; if(!item) return; item.qty += change; if(item.qty <= 0) { cart.splice(idx, 1); } else { item.total = item.price * item.qty; } updateCartUI(); if(cart.length > 0) { openCartModal(); } else { closeCartModal(); } }
    function closeCartModal() { document.getElementById('cart-modal').classList.add('hidden'); }
    function closeSpecModal() { document.getElementById('spec-modal').classList.add('hidden'); }
    function clearCart() { cart = []; updateCartUI(); }
    function removeCartItem(idx) { cart.splice(idx, 1); updateCartUI(); if(cart.length > 0) openCartModal(); }
    function selSvc(el, s) { document.querySelectorAll('.service-option').forEach(e=>e.classList.remove('selected')); el.classList.add('selected'); selectedService = s; }
    function loadOrderHistory() { document.getElementById('history-list-container').innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">è¼‰å…¥ä¸­...</div>'; fetch(API_URL, {method:'POST', body:JSON.stringify({action:"getHistory", userId:userProfile.userId})}).then(res=>res.json()).then(data=>{ orderCache = data; const container = document.getElementById('history-list-container'); if(orderCache.length===0) { container.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">å°šç„¡è¨‚å–®ç´€éŒ„</div>'; return; } let html = ''; orderCache.forEach((o, i) => { let price = o.content.split('ç¸½é‡‘é¡ï¼š')[1]?.split('\n')[0].replace('å…ƒ','').trim() || ''; let summary = o.content.split('\n').filter(line => !line.includes('ç¸½é‡‘é¡') && !line.includes('---') && !line.includes('é›»è©±') && line.trim() !== '').slice(0, 2).join(', '); if (summary.length > 20) summary = summary.substring(0, 20) + '...'; let statusClass = 'status-wait'; if (o.status.includes('å·²æ¥å–®')) statusClass = 'status-ok'; else if (o.status.includes('å©‰æ‹’') || o.status.includes('å–æ¶ˆ')) statusClass = 'status-no'; html += `<div class="history-card" onclick="openOrderDetail(${i})"><div class="hc-header"><div class="hc-shop">${o.shopName}</div><div class="hc-date">${o.time}</div></div><div class="hc-body"><div class="hc-summary">${summary || 'é»æ“ŠæŸ¥çœ‹è©³æƒ…'}</div><div style="text-align:right;"><div class="hc-price">$${price}</div><div class="hc-status ${statusClass}">${o.status}</div></div></div></div>`; }); container.innerHTML = html; }).catch(e=>{}); }
    function openOrderDetail(idx) { let o = orderCache[idx]; document.getElementById('order-detail-view').classList.remove('hidden'); document.getElementById('od-shop-name').innerText = o.shopName; document.getElementById('od-status').innerText = o.status; document.getElementById('od-id').innerText = o.orderId; document.getElementById('od-time').innerText = o.time; let html = '', total = '0', phone = '--'; o.content.split('\n').forEach(line => { if(line.includes('ç¸½é‡‘é¡')) { total = line.split('ï¼š')[1].replace('å…ƒ','').trim(); } else if(line.includes('é›»è©±')) { phone = line.split('ï¼š')[1]; } else if(!line.includes('---') && line.trim()) { let parts = line.split('$'); let name = line; let price = ''; if(parts.length > 1) { name = parts[0]; price = '$' + parts[1]; } html += `<div class="od-row"><div>${name}</div><div>${price}</div></div>`; } }); document.getElementById('od-items-list').innerHTML = html; document.getElementById('od-total-price').innerText = total; document.getElementById('od-phone').innerText = phone; const cancelDiv = document.getElementById('od-cancel-container'); if(o.status.includes('å¾…ç¢ºèª')) { cancelDiv.innerHTML = `<div class="spec-add-btn" style="background:#fff;color:#D32F2F;border:1px solid #D32F2F;text-align:center;box-shadow:none;" onclick="cancelOrder('${o.orderId}')">å–æ¶ˆè¨‚å–®</div>`; } else { cancelDiv.innerHTML = ''; } }
    function closeOrderDetail() { document.getElementById('order-detail-view').classList.add('hidden'); }
    function cancelOrder(oid) { showConfirm("ç¢ºå®šå–æ¶ˆï¼Ÿ", async () => { await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:"cancelOrder", orderId:oid, userId:userProfile.userId})}); setTimeout(() => { showMsg("å·²é€å‡ºå–æ¶ˆ", () => { closeOrderDetail(); loadOrderHistory(); }); }, 1500); }); }
    function fetchMemberData() { fetch(`${API_URL}?action=getMember&userId=${userProfile.userId}`).then(res=>res.json()).then(data=>{ document.getElementById('m-points').innerText = data.points || 0; if(data.name && data.name!=="æœƒå“¡") ['home-name','m-name'].forEach(id=>{ const el = document.getElementById(id); if(el) el.innerText=data.name; }); window.currentMemberData = data; }).catch(e=>{}); }
    function openEditModal() { const data = window.currentMemberData || {}; document.getElementById('edit-name').value = data.name || userProfile.displayName; document.getElementById('edit-phone').value = data.phone || localStorage.getItem("uni_user_phone") || ""; if (data.birthday) try { document.getElementById('edit-birthday').value = new Date(data.birthday).toISOString().split('T')[0]; } catch(e){} document.getElementById('edit-modal').classList.remove('hidden'); }
    function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
    function saveProfile() { const name = document.getElementById('edit-name').value; const phone = document.getElementById('edit-phone').value; const birthday = document.getElementById('edit-birthday').value; if (!name || !phone) { showMsg("å§“åèˆ‡é›»è©±ç‚ºå¿…å¡«"); return; } const btn = document.querySelector('.btn-save'); btn.innerText = "å„²å­˜ä¸­..."; fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: "updateProfile", userId: userProfile.userId, name: name, phone: phone, birthday: birthday }) }).then(()=>{ showMsg("è³‡æ–™æ›´æ–°æˆåŠŸï¼", () => { localStorage.setItem("uni_user_phone", phone); closeEditModal(); fetchMemberData(); }); }).catch(e=>{ showMsg("æ›´æ–°å¤±æ•—"); }).finally(()=>{ btn.innerText = "å„²å­˜"; }); }

    main();
  </script>
</body>
</html>
