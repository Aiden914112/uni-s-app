<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S ç”Ÿæ´»åœˆ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* CSS å…¨å±€è¨­å®š */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 0; margin: 0; background-color: #f2f3f5; touch-action: manipulation; -webkit-user-select: none; user-select: none; padding-bottom: 90px; }
    .hidden { display: none !important; }
    #loading, #error-box { text-align: center; padding: 50px; color: #999; }
    
    /* åº•éƒ¨å°èˆª */
    #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; height: 60px; display: flex; border-top: 1px solid #eee; z-index: 200; padding-bottom: env(safe-area-inset-bottom); }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
    .tab-item.active { color: #06C755; }
    .tab-icon { font-size: 24px; margin-bottom: 2px; }

    /* å¤§å»³ */
    #lobby-view { padding: 20px; }
    #lobby-title { font-size: 24px; font-weight: 800; color: #111; margin-bottom: 20px; }
    #lobby-title span { color: #06C755; }
    .shop-card { background: white; border-radius: 16px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.1s; cursor: pointer; }
    .shop-card:active { transform: scale(0.98); }
    .card-banner { height: 140px; background-size: cover; background-position: center; position: relative; }
    .card-info { padding: 15px; }
    .card-name { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .card-tag { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; backdrop-filter: blur(4px); }

    /* æœƒå“¡ä¸­å¿ƒ */
    #member-view { padding: 20px; }
    .member-card { background: linear-gradient(135deg, #06C755, #04a545); border-radius: 20px; padding: 25px; color: white; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(6, 199, 85, 0.3); }
    .member-header { display: flex; align-items: center; margin-bottom: 20px; }
    .avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); margin-right: 15px; background: #eee; }
    .member-name { font-size: 20px; font-weight: bold; }
    .points-value { font-size: 36px; font-weight: 800; }
    .history-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 15px; }
    .history-item { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 10px; }
    .h-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #888; }
    .h-shop { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .h-content { font-size: 14px; color: #666; white-space: pre-wrap; margin-bottom: 10px; background: #f9f9f9; padding: 8px; border-radius: 6px; }
    .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
    .status-wait { background: #fff3cd; color: #856404; }
    .status-ok { background: #d4edda; color: #155724; }
    .status-no { background: #f8d7da; color: #721c24; }

    /* é»é¤ */
    #shop-view { background: #f8f9fa; }
    #banner { width: 100%; height: 200px; background-size: cover; background-position: center; position: relative; background-color: #ddd; }
    #shop-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 20px; color: white; }
    #shop-name { font-size: 24px; font-weight: bold; margin: 0; }
    #back-btn { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .container { padding: 15px; }
    .menu-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .stepper { display: flex; align-items: center; background: #f0f0f0; border-radius: 20px; padding: 2px; }
    .stepper button { width: 32px; height: 32px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; }
    .btn-plus { background: #06C755; color: white; }
    #cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 100; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
    #checkout-btn { background: #06C755; color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; }
    #checkout-btn.active { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body>

  <div id="loading">è¼‰å…¥ä¸­...</div>
  <div id="error-box" class="hidden"></div>

  <div id="lobby-view" class="hidden">
    <div id="lobby-title">Uni-S <span>ç”Ÿæ´»åœˆ</span></div>
    <div style="font-size:14px; color:#666; margin-bottom:15px;">ä½ å¥½ï¼Œ<span id="lobby-user"></span>ï¼ä»Šå¤©è¦æ¢ç´¢å“ªå®¶å¥½åº—ï¼Ÿ</div>
    <div id="shop-list"></div>
  </div>

  <div id="member-view" class="hidden">
    <div class="member-card">
      <div class="member-header">
        <img id="m-avatar" src="" class="avatar">
        <div>
          <div id="m-name" class="member-name">...</div>
          <div style="font-size:12px; opacity:0.9;">Uni-S æœƒå“¡</div>
        </div>
      </div>
      <div style="font-size:12px; opacity:0.8;">ç›®å‰ç´¯ç©é»æ•¸</div>
      <div class="points-value"><span id="m-points">0</span> <span class="points-unit">P</span></div>
    </div>
    <div class="history-title">ğŸ“œ æœ€è¿‘è¨‚å–®ç´€éŒ„</div>
    <div id="history-loading" style="text-align:center; color:#999; font-size:12px;">æ­£åœ¨æŸ¥è©¢...</div>
    <div id="history-list" class="history-list"></div>
  </div>

  <div id="shop-view" class="hidden">
    <button id="back-btn" onclick="goLobby()">â€¹</button>
    <div id="banner"><div id="shop-info"><h1 id="shop-name">è¼‰å…¥ä¸­...</h1></div></div>
    <div class="container"><div id="menu-list"></div></div>
    <div id="cart-bar">
      <div>ç¸½è¨ˆ $<span id="total-display">0</span></div>
      <button id="checkout-btn" onclick="sendOrder()">é€å‡ºè¨‚å–® (0)</button>
    </div>
  </div>

  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('lobby')"><div class="tab-icon">ğŸ </div><div>é¦–é </div></div>
    <div class="tab-item" onclick="switchTab('member')"><div class="tab-icon">ğŸ‘¤</div><div>æœƒå“¡</div></div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ è¨­å®šå€ï¼šè«‹å¡«å…¥ä½ çš„ ID å’Œ URL âš ï¸âš ï¸âš ï¸
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";

    let allShops = {}; let currentShop = null; let cart = {}; let userProfile = null;

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        document.getElementById('lobby-user').innerText = userProfile.displayName;

        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        const shopId = new URLSearchParams(window.location.search).get('id');
        if (shopId && allShops[shopId]) openShop(shopId);
        else { renderLobby(); switchTab('lobby'); }
      } catch (err) { showError(err.message); }
    }

    function switchTab(tab) {
      document.getElementById('lobby-view').classList.add('hidden');
      document.getElementById('member-view').classList.add('hidden');
      document.getElementById('shop-view').classList.add('hidden');
      document.getElementById('tab-bar').classList.remove('hidden');
      document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
      
      if (tab === 'lobby') {
        document.getElementById('lobby-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[0].classList.add('active');
      } else if (tab === 'member') {
        document.getElementById('member-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[1].classList.add('active');
        fetchMemberData();
        loadOrderHistory();
      }
    }

    async function fetchMemberData() {
      document.getElementById('m-name').innerText = userProfile.displayName;
      document.getElementById('m-avatar').src = userProfile.pictureUrl;
      document.getElementById('m-points').innerText = "...";
      try {
        const url = `${API_URL}?action=getMember&userId=${userProfile.userId}`;
        const res = await fetch(url);
        const data = await res.json();
        document.getElementById('m-points').innerText = data.points;
      } catch(e) { document.getElementById('m-points').innerText = "Err"; }
    }

    async function loadOrderHistory() {
      const listDiv = document.getElementById('history-list');
      const loadingDiv = document.getElementById('history-loading');
      listDiv.innerHTML = ''; loadingDiv.style.display = 'block';
      try {
        const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", userId: userProfile.userId }) });
        const history = await response.json();
        loadingDiv.style.display = 'none';
        
        if (history.length === 0) { listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">å°šç„¡è¨‚å–®ç´€éŒ„</div>'; return; }
        
        let html = '';
        history.forEach(order => {
          let badgeClass = 'status-wait';
          if (order.status.includes('å·²æ¥å–®')) badgeClass = 'status-ok';
          if (order.status.includes('å·²å©‰æ‹’')) badgeClass = 'status-no';
          html += `<div class="history-item"><div class="h-header"><span>${order.time}</span><span>#${order.orderId}</span></div><div class="h-shop">${order.shopName}</div><div class="h-content">${order.content}</div><div class="h-footer"><span class="status-badge ${badgeClass}">${order.status}</span></div></div>`;
        });
        listDiv.innerHTML = html;
      } catch (e) { loadingDiv.style.display = 'none'; listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">å°šç„¡è¨‚å–® (æˆ–è¼‰å…¥å¤±æ•—)</div>'; }
    }

    function renderLobby() {
      const list = document.getElementById('shop-list');
      let html = '';
      Object.keys(allShops).forEach(id => {
        const s = allShops[id];
        html += `<div class="shop-card" onclick="openShop('${id}', true)"><div class="card-banner" style="background-image:url(${s.bannerUrl})"><div class="card-tag">ç‡Ÿæ¥­ä¸­</div></div><div class="card-info"><div class="card-name">${s.name}</div><div class="card-desc">é»æ“Šé€²å…¥é ç´„é»é¤...</div></div></div>`;
      });
      list.innerHTML = html;
    }

    function openShop(id, pushHistory=false) {
      currentShop = allShops[id]; currentShop.id = id; cart = {};
      if(pushHistory) { const url = new URL(window.location); url.searchParams.set('id', id); window.history.pushState({}, '', url); }
      document.getElementById('tab-bar').classList.add('hidden'); document.getElementById('lobby-view').classList.add('hidden'); document.getElementById('member-view').classList.add('hidden'); document.getElementById('shop-view').classList.remove('hidden');
      renderShopUI(currentShop);
    }
    
    function renderShopUI(data) {
      document.getElementById('shop-name').innerText = data.name; document.getElementById('banner').style.backgroundImage = `url(${data.bannerUrl})`; document.getElementById('total-display').innerText = '0';
      const btn = document.getElementById('checkout-btn'); btn.innerText = 'é€å‡ºè¨‚å–® (0)'; btn.classList.remove('active'); btn.style.backgroundColor = '#ccc';
      let html = '';
      data.menu.forEach((item, index) => {
        html += `<div class="menu-item"><div style="flex:1;"><span class="item-name">${item.name}</span><span class="item-price">$${item.price}</span></div><div class="stepper"><button class="btn-minus" onclick="updateCart('${item.name}', ${item.price}, -1)">âˆ’</button><span class="count" id="count-${index}">0</span><button class="btn-plus" style="background:${data.themeColor}" onclick="updateCart('${item.name}', ${item.price}, 1)">+</button></div></div>`;
      });
      document.getElementById('menu-list').innerHTML = html;
    }

    function updateCart(name, price, change) {
      if (!cart[name]) cart[name] = 0; cart[name] += change; if (cart[name] < 0) cart[name] = 0;
      const items = currentShop.menu; let total = 0; let count = 0;
      items.forEach((item, index) => {
        if (item.name === name) document.getElementById(`count-${index}`).innerText = cart[name];
        if (cart[item.name]) { total += cart[item.name] * item.price; count += cart[item.name]; }
      });
      document.getElementById('total-display').innerText = total;
      const btn = document.getElementById('checkout-btn'); btn.innerText = `é€å‡ºè¨‚å–® (${count})`;
      if (count > 0) { btn.classList.add('active'); btn.style.backgroundColor = currentShop.themeColor; } else { btn.classList.remove('active'); btn.style.backgroundColor = '#ccc'; }
    }

    // ğŸ”¥ğŸ”¥ é€™æ˜¯æ›´æ–°å¾Œçš„ sendOrder (å«é›»è©±é©—è­‰) ğŸ”¥ğŸ”¥
    async function sendOrder() {
      if (!liff.isInClient()) { alert('è«‹åœ¨ LINE App ä¸­ä½¿ç”¨'); return; }
      
      let orderDetail = "";
      let total = 0;
      for (let [name, qty] of Object.entries(cart)) {
        if (qty > 0) {
          let item = currentShop.menu.find(i => i.name === name);
          let subtotal = item.price * qty;
          orderDetail += `${name} x ${qty} ($${subtotal})\n`;
          total += subtotal;
        }
      }

      if (total === 0) { alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼"); return; }
      orderDetail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ`;

      // ğŸ“ é›»è©±æª¢æŸ¥é‚è¼¯
      let userPhone = localStorage.getItem("uni_user_phone");
      if (!userPhone) {
        userPhone = prompt("è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œä»¥ä¾¿åº—å®¶è¯çµ¡ï¼š");
        if (!userPhone || userPhone.trim() === "") { alert("âŒ å¿…é ˆå¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼æ‰èƒ½ä¸‹å–®å–”ï¼"); return; }
        if (userPhone.length < 9 || isNaN(userPhone)) { alert("âŒ æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢º"); return; }
        localStorage.setItem("uni_user_phone", userPhone);
      }
      orderDetail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${userPhone}`;

      const btn = document.getElementById('checkout-btn');
      btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
      
      try {
        await liff.sendMessages([{ type: "text", text: `ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${orderDetail}` }]);
        const orderData = { shopId: currentShop.id, userName: userProfile.displayName, userId: userProfile.userId, order: orderDetail };
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
        alert("âœ… è¨‚å–®å·²é€å‡ºï¼\nåº—å®¶å°‡æœƒæ”¶åˆ°æ‚¨çš„è¯çµ¡é›»è©±ã€‚"); 
        goLobby();
      } catch (err) { 
        alert("ç™¼é€å¤±æ•—ï¼š" + err.message); 
        btn.innerText = "é‡è©¦"; btn.disabled = false;
      }
    }
    
    function goLobby() { const url = new URL(window.location); url.searchParams.delete('id'); window.history.pushState({}, '', url); switchTab('lobby'); }
    function showError(msg) { document.getElementById('loading').classList.add('hidden'); document.getElementById('error-box').classList.remove('hidden'); document.getElementById('error-box').innerText = msg; }

    main();
  </script>
</body>
</html>
