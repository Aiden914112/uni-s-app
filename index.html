<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S ç”Ÿæ´»åœˆ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ==================== å…¨å±€è¨­å®š ==================== */
    :root { --primary: #06C755; --bg: #F5F6F7; --text: #333; --card-bg: #fff; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 0; margin: 0; background-color: var(--bg); color: var(--text); touch-action: manipulation; -webkit-user-select: none; user-select: none; padding-bottom: 90px; }
    .hidden { display: none !important; }
    #loading, #error-box { text-align: center; padding: 50px; color: #999; }
    .container { padding: 15px; }
    .section-title { font-size: 16px; font-weight: bold; margin: 20px 0 10px 0; }

    /* ==================== åº•éƒ¨å°èˆªåˆ— (3å€‹Tab) ==================== */
    #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; height: 60px; display: flex; border-top: 1px solid #eee; z-index: 200; padding-bottom: env(safe-area-inset-bottom); }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; }
    .tab-item.active { color: var(--primary); }
    .tab-icon { font-size: 22px; margin-bottom: 3px; }

    /* ==================== ğŸ  å¤§å»³ (Lobby) - æœå°‹èˆ‡èˆŠç‰ˆå¡ç‰‡ ==================== */
    #lobby-view { padding: 15px; }
    /* æœå°‹æ¬„ */
    .search-bar { background: #fff; padding: 10px; border-radius: 20px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .search-bar i { color: #999; margin-right: 10px; }
    .search-bar input { border: none; flex: 1; outline: none; font-size: 14px; }
    /* åˆ†é¡æ¿¾é¡ */
    .filter-tags { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
    .filter-tag { background: #fff; padding: 6px 15px; border-radius: 15px; font-size: 12px; color: #666; white-space: nowrap; }
    .filter-tag.active { background: var(--primary); color: #fff; }
    /* èˆŠç‰ˆå¡ç‰‡æ¨£å¼ */
    .shop-card-classic { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.1s; cursor: pointer; }
    .shop-card-classic:active { transform: scale(0.98); }
    .classic-banner { height: 150px; background-size: cover; background-position: center; position: relative; }
    .classic-info { padding: 12px; }
    .classic-name { font-size: 16px; font-weight: bold; }
    .classic-desc { font-size: 12px; color: #888; margin-top: 5px; }

    /* ==================== ğŸ“œ è¨‚å–®åˆ—è¡¨ (Orders List) - åƒè€ƒæˆªåœ–6 ==================== */
    #orders-view { padding: 15px; }
    .order-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; }
    .oc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #f5f5f5; padding-bottom: 10px; }
    .oc-shop { font-weight: bold; font-size: 16px; display: flex; align-items: center; }
    .oc-shop i { margin-right: 8px; color: #666; }
    .oc-status { font-size: 14px; color: #888; }
    .oc-status.finished { color: var(--primary); }
    .oc-body { display: flex; justify-content: space-between; align-items: center; }
    .oc-summary { font-size: 14px; color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; flex: 1; margin-right: 15px; }
    .oc-price { font-size: 18px; font-weight: bold; color: #333; }

    /* ==================== ğŸ“„ è¨‚å–®è©³æƒ… (Order Detail) - åƒè€ƒæˆªåœ–5/7 ==================== */
    #order-detail-view { background: #F5F6F7; min-height: 100vh; padding-bottom: 20px; }
    .od-navbar { background: #fff; padding: 15px; display: flex; align-items: center; font-weight: bold; position: sticky; top: 0; z-index: 10; }
    .od-back { font-size: 20px; margin-right: 15px; cursor: pointer; }
    .od-section { background: #fff; margin: 15px; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    /* é–€åº—è³‡è¨Š */
    .od-store-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .od-store-name { font-size: 18px; font-weight: bold; }
    .od-store-actions { display: flex; gap: 10px; }
    .btn-icon { width: 36px; height: 36px; border-radius: 50%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #333; font-size: 18px; cursor: pointer; }
    /* é¤é»åˆ—è¡¨ */
    .od-item { display: flex; justify-content: space-between; margin-bottom: 15px; }
    .od-item-name { font-weight: 500; flex: 1; }
    .od-item-qty { color: #888; margin: 0 15px; }
    .od-item-price { font-weight: bold; }
    /* è³‡è¨Šè¡Œ */
    .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; color: #666; }
    .info-label { color: #888; }
    .info-value { color: #333; font-weight: 500; text-align: right; }

    /* ==================== ğŸ‘¤ æœƒå“¡ä¸­å¿ƒ (Member) - åƒè€ƒæˆªåœ–2/5 ==================== */
    #member-view { padding-bottom: 20px; }
    .member-banner { background-image: url('https://images.unsplash.com/photo-1613310023042-ad79320c00fc?q=80&w=2070'); background-size: cover; background-position: center; padding: 30px 20px 80px 20px; color: rgba(255,255,255,0.9); }
    .user-info { display: flex; align-items: center; }
    .user-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #fff; margin-right: 15px; background: #eee; }
    .user-name { font-size: 20px; font-weight: bold; color: #fff; }
    .user-level-badge { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 5px; }
    /* æµ®å‹•å¡ç‰‡ */
    .member-stats-card { background: #fff; border-radius: 16px; margin: -50px 15px 20px 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: relative; }
    .stats-row { display: flex; justify-content: space-around; text-align: center; margin-bottom: 20px; }
    .stat-num { font-size: 24px; font-weight: 800; color: var(--primary); display: block; }
    .stat-label { font-size: 12px; color: #888; }
    /* ç¶“é©—æ¢ */
    .exp-bar-container { margin-top: 15px; }
    .exp-info { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 5px; }
    .progress-bg { height: 6px; background: #eee; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

    /* ==================== ğŸœ é»é¤èˆ‡å…¶ä»– (ä¿æŒä¸è®Š) ==================== */
    #shop-view { background: #f8f9fa; }
    #banner { width: 100%; height: 200px; background-size: cover; background-position: center; position: relative; background-color: #ddd; }
    #shop-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 20px; color: white; }
    #shop-name-title { font-size: 24px; font-weight: bold; margin: 0; }
    #back-btn-shop { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .menu-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .stepper { display: flex; align-items: center; background: #f0f0f0; border-radius: 20px; padding: 2px; }
    .stepper button { width: 32px; height: 32px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; }
    .btn-plus { background: var(--primary); color: white; }
    #cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 100; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
    #checkout-btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; }
    #checkout-btn.active { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body>

  <div id="loading">Uni-S è¼‰å…¥ä¸­...</div>
  <div id="error-box" class="hidden"></div>

  <div id="lobby-view" class="hidden">
    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="æœå°‹åº—å®¶..." oninput="filterShops()">
    </div>
    <div class="filter-tags">
      <div class="filter-tag active">å…¨éƒ¨</div>
      <div class="filter-tag">ç¾é£Ÿ</div>
      <div class="filter-tag">é£²å“</div>
      <div class="filter-tag">ç”Ÿæ´»</div>
      </div>
    <div class="section-title">æ¨è–¦å•†å®¶</div>
    <div id="shop-list"></div>
  </div>

  <div id="orders-view" class="hidden">
    <div class="section-title" style="margin-top:0;">æˆ‘çš„è¨‚å–®</div>
    <div id="orders-loading" style="text-align:center; color:#999; margin-top:50px;">è¼‰å…¥ä¸­...</div>
    <div id="orders-list-container"></div>
  </div>

  <div id="order-detail-view" class="hidden">
    <div class="od-navbar">
      <div class="od-back" onclick="closeOrderDetail()"><i class="fas fa-arrow-left"></i></div>
      <div>è¨‚å–®è©³æƒ…</div>
    </div>
    
    <div class="od-section">
      <div class="od-store-header">
        <div class="od-store-name" id="od-shop-name">...</div>
        <div class="od-store-actions">
          <div class="btn-icon" onclick="alert('æ’¥æ‰“é›»è©±åŠŸèƒ½é–‹ç™¼ä¸­')"><i class="fas fa-phone"></i></div>
          <div class="btn-icon" onclick="alert('åœ°åœ–å°èˆªåŠŸèƒ½é–‹ç™¼ä¸­')"><i class="fas fa-location-arrow"></i></div>
        </div>
      </div>
    </div>

    <div class="od-section">
      <div class="section-title" style="margin-top:0;">é¤é»æ˜ç´°</div>
      <div id="od-items-list">
        </div>
      <div style="border-top:1px solid #eee; margin-top:15px; padding-top:15px;">
        <div class="info-row" style="font-size:16px; color:#333;">
          <span>åˆè¨ˆ</span>
          <span style="font-weight:bold; color:#D32F2F;" id="od-total-price">...</span>
        </div>
      </div>
    </div>

    <div class="od-section">
      <div class="section-title" style="margin-top:0;">ç”¨é¤è³‡è¨Š</div>
      <div class="info-row"><span class="info-label">é ç•™é›»è©±</span><span class="info-value" id="od-user-phone">--</span></div>
    </div>

    <div class="od-section">
      <div class="section-title" style="margin-top:0;">è¨‚å–®è³‡è¨Š</div>
      <div class="info-row"><span class="info-label">è¨‚å–®ç·¨è™Ÿ</span><span class="info-value" id="od-id">...</span></div>
      <div class="info-row"><span class="info-label">ä¸‹å–®æ™‚é–“</span><span class="info-value" id="od-time">...</span></div>
      <div class="info-row"><span class="info-label">è¨‚å–®ç‹€æ…‹</span><span class="info-value" id="od-status">...</span></div>
    </div>
  </div>


  <div id="member-view" class="hidden">
    <div class="member-banner">
      <div class="user-info">
        <img id="m-avatar" src="" class="user-avatar">
        <div>
          <div id="m-name" class="user-name">...</div>
          <div><span id="m-level" class="user-level-badge">æ™®é€šæœƒå“¡</span></div>
        </div>
      </div>
    </div>
    
    <div class="member-stats-card">
      <div class="stats-row">
        <div><span class="stat-num" id="m-points">0</span><span class="stat-label">ç©åˆ†</span></div>
        <div><span class="stat-num">0</span><span class="stat-label">å„ªæƒ åˆ¸</span></div>
        <div><span class="stat-num">0</span><span class="stat-label">é¤˜é¡</span></div>
      </div>
      <div class="exp-bar-container">
        <div class="exp-info">
          <span>æˆé•·å€¼</span>
          <span><span id="m-exp-current">0</span> / <span id="m-exp-next">100</span></span>
        </div>
        <div class="progress-bg">
          <div class="progress-fill" id="m-progress" style="width: 0%;"></div>
        </div>
        <div style="font-size:10px; color:#999; margin-top:5px;">å†ç´¯ç© <span id="m-exp-need">100</span> é»å‡ç´š</div>
      </div>
    </div>
  </div>


  <div id="shop-view" class="hidden">
    <button id="back-btn-shop" onclick="goLobby()">â€¹</button>
    <div id="banner"><div id="shop-info"><h1 id="shop-name-title">...</h1></div></div>
    <div class="container"><div id="menu-list"></div></div>
    <div id="cart-bar">
      <div>ç¸½è¨ˆ $<span id="total-display">0</span></div>
      <button id="checkout-btn" onclick="sendOrder()">é€å‡ºè¨‚å–® (0)</button>
    </div>
  </div>

  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('lobby')">
      <div class="tab-icon"><i class="fas fa-home"></i></div><div>é¦–é </div>
    </div>
    <div class="tab-item" onclick="switchTab('orders')">
      <div class="tab-icon"><i class="fas fa-receipt"></i></div><div>è¨‚å–®</div>
    </div>
    <div class="tab-item" onclick="switchTab('member')">
      <div class="tab-icon"><i class="fas fa-user"></i></div><div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ è¨­å®šå€ âš ï¸âš ï¸âš ï¸
    const MY_LIFF_ID = "ä½ çš„LIFF_ID"; 
    const API_URL = "ä½ çš„Apps_Script_URL";

    let allShops = {}; let currentShop = null; let cart = {}; let userProfile = null; let orderHistoryCache = [];

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        
        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        const shopId = new URLSearchParams(window.location.search).get('id');
        if (shopId && allShops[shopId]) openShop(shopId);
        else { renderLobby(allShops); switchTab('lobby'); }
        
        fetchMemberData(); // é åŠ è¼‰æœƒå“¡è³‡æ–™

      } catch (err) { showError(err.message); }
    }

    // ========== é é¢åˆ‡æ›é‚è¼¯ ==========
    function switchTab(tab) {
      // éš±è—æ‰€æœ‰ä¸»è¦–åœ–
      ['lobby-view', 'orders-view', 'member-view', 'shop-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
      // é¡¯ç¤º Tab Bar
      document.getElementById('tab-bar').classList.remove('hidden');
      document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
      
      if (tab === 'lobby') {
        document.getElementById('lobby-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[0].classList.add('active');
      } else if (tab === 'orders') {
        document.getElementById('orders-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[1].classList.add('active');
        loadOrderHistory(); // è¼‰å…¥è¨‚å–®åˆ—è¡¨
      } else if (tab === 'member') {
        document.getElementById('member-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[2].classList.add('active');
        fetchMemberData(); // æ›´æ–°æœƒå“¡è³‡æ–™
      }
    }

    // é–‹å•Ÿè¨‚å–®è©³æƒ… (é€™æ˜¯ç¨ç«‹é é¢ï¼Œæœƒè“‹ä½ Tab Bar)
    function openOrderDetail(orderData) {
      document.getElementById('tab-bar').classList.add('hidden'); // éš±è— Tab Bar
      document.getElementById('orders-view').classList.add('hidden');
      document.getElementById('order-detail-view').classList.remove('hidden');
      
      // å¡«å…¥è³‡æ–™
      document.getElementById('od-shop-name').innerText = orderData.shopName;
      document.getElementById('od-id').innerText = orderData.orderId;
      document.getElementById('od-time').innerText = orderData.time;
      document.getElementById('od-status').innerText = orderData.status;
      
      // è§£æè¨‚å–®å…§å®¹èˆ‡é›»è©±
      let contentHtml = '';
      let totalPrice = '';
      let userPhone = '--';

      const lines = orderData.content.split('\n');
      lines.forEach(line => {
        line = line.trim();
        if (line.includes('ç¸½é‡‘é¡ï¼š')) {
          totalPrice = line.replace('ç¸½é‡‘é¡ï¼š', '').replace('----------------', '').trim();
        } else if (line.includes('è¯çµ¡é›»è©±ï¼š')) {
          userPhone = line.replace('è¯çµ¡é›»è©±ï¼š', '').trim();
        } else if (line !== '' && !line.includes('---')) {
          // ç°¡å–®è§£æé¤é»åç¨±å’Œåƒ¹æ ¼ (å‡è¨­æ ¼å¼: å“å x æ•¸é‡ ($å°è¨ˆ))
          let parts = line.split(' x ');
          if (parts.length >= 2) {
             let name = parts[0];
             let rest = parts[1].split(' ($');
             let qty = rest[0];
             let price = rest[1] ? '$' + rest[1].replace(')', '') : '';
             contentHtml += `<div class="od-item"><div class="od-item-name">${name}</div><div class="od-item-qty">x${qty}</div><div class="od-item-price">${price}</div></div>`;
          } else {
             contentHtml += `<div class="od-item"><div class="od-item-name">${line}</div></div>`;
          }
        }
      });
      
      document.getElementById('od-items-list').innerHTML = contentHtml;
      document.getElementById('od-total-price').innerText = totalPrice;
      document.getElementById('od-user-phone').innerText = userPhone;
    }

    function closeOrderDetail() {
      document.getElementById('order-detail-view').classList.add('hidden');
      switchTab('orders'); // å›åˆ°è¨‚å–®åˆ—è¡¨
    }

    // ========== è³‡æ–™è¼‰å…¥é‚è¼¯ ==========
    async function fetchMemberData() {
      document.getElementById('m-name').innerText = userProfile.displayName;
      document.getElementById('m-avatar').src = userProfile.pictureUrl;
      try {
        const res = await fetch(`${API_URL}?action=getMember&userId=${userProfile.userId}`);
        const data = await res.json();
        let points = parseInt(data.points) || 0;
        document.getElementById('m-points').innerText = points;
        document.getElementById('m-level').innerText = data.level;
        
        // è¨ˆç®—ç¶“é©—å€¼é€²åº¦ (å‡è¨­ 100 é»å‡ä¸€ç´š)
        let currentExp = points % 100;
        let nextExp = 100;
        let needExp = nextExp - currentExp;
        let progressPercent = (currentExp / nextExp) * 100;
        
        document.getElementById('m-exp-current').innerText = currentExp;
        document.getElementById('m-exp-next').innerText = nextExp;
        document.getElementById('m-exp-need').innerText = needExp;
        document.getElementById('m-progress').style.width = progressPercent + "%";

      } catch(e) { console.error(e); }
    }

    async function loadOrderHistory() {
      const listContainer = document.getElementById('orders-list-container');
      const loadingDiv = document.getElementById('orders-loading');
      listContainer.innerHTML = ''; loadingDiv.classList.remove('hidden');
      try {
        const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", userId: userProfile.userId }) });
        orderHistoryCache = await response.json(); // å¿«å–ä¸‹ä¾†çµ¦è©³æƒ…é ç”¨
        loadingDiv.classList.add('hidden');
        
        if (orderHistoryCache.length === 0) { listContainer.innerHTML = '<div style="text-align:center;color:#999;margin-top:20px;">æ‚¨é‚„æ²’æœ‰è¨‚å–®ç´€éŒ„</div>'; return; }
        
        let html = '';
        orderHistoryCache.forEach((order, index) => {
          let statusClass = order.status.includes('å·²æ¥å–®') ? 'finished' : '';
          // è§£æç¸½åƒ¹å’Œæ‘˜è¦
          let summary = ''; let price = '';
          order.content.split('\n').forEach(line => {
             if (line.includes('ç¸½é‡‘é¡ï¼š')) price = line.replace('ç¸½é‡‘é¡ï¼š', '').replace('----------------', '').replace('å…ƒ','').trim();
             else if (!line.includes('---') && !line.includes('è¯çµ¡é›»è©±') && line.trim() !== '') summary += line.trim() + ' ';
          });

          html += `
            <div class="order-card" onclick="openOrderDetail(orderHistoryCache[${index}])">
              <div class="oc-header">
                <div class="oc-shop"><i class="fas fa-store"></i> ${order.shopName}</div>
                <div class="oc-status ${statusClass}">${order.status}</div>
              </div>
              <div class="oc-body">
                <div class="oc-summary">${summary}</div>
                <div class="oc-price">${price}</div>
              </div>
            </div>`;
        });
        listContainer.innerHTML = html;
      } catch (e) { loadingDiv.classList.add('hidden'); }
    }

    // ========== å¤§å»³é‚è¼¯ ==========
    function renderLobby(shops) {
      const list = document.getElementById('shop-list');
      let html = '';
      Object.keys(shops).forEach(id => {
        const s = shops[id];
        html += `
          <div class="shop-card-classic" onclick="openShop('${id}', true)">
            <div class="classic-banner" style="background-image:url(${s.bannerUrl})"></div>
            <div class="classic-info">
              <div class="classic-name">${s.name}</div>
              <div class="classic-desc">é»æ“Šé€²å…¥é ç´„é»é¤...</div>
            </div>
          </div>`;
      });
      list.innerHTML = html;
    }

    function filterShops() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const filtered = {};
      Object.keys(allShops).forEach(id => {
        if (allShops[id].name.toLowerCase().includes(searchTerm)) {
          filtered[id] = allShops[id];
        }
      });
      renderLobby(filtered);
    }

    // ========== é»é¤é‚è¼¯ (ä¿æŒä¸è®Š) ==========
    function openShop(id, pushHistory=false) {
      currentShop = allShops[id]; currentShop.id = id; cart = {};
      if(pushHistory) { const url = new URL(window.location); url.searchParams.set('id', id); window.history.pushState({}, '', url); }
      document.getElementById('tab-bar').classList.add('hidden'); ['lobby-view', 'orders-view', 'member-view'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('shop-view').classList.remove('hidden');
      renderShopUI(currentShop);
    }
    
    function renderShopUI(data) {
      document.getElementById('shop-name-title').innerText = data.name; document.getElementById('banner').style.backgroundImage = `url(${data.bannerUrl})`; document.getElementById('total-display').innerText = '0';
      const btn = document.getElementById('checkout-btn'); btn.innerText = 'é€å‡ºè¨‚å–® (0)'; btn.classList.remove('active'); btn.style.backgroundColor = '#ccc';
      let html = '';
      data.menu.forEach((item, index) => {
        html += `<div class="menu-item"><div style="flex:1;"><span class="item-name">${item.name}</span><span class="item-price">$${item.price}</span></div><div class="stepper"><button class="btn-minus" onclick="updateCart('${item.name}', ${item.price}, -1)">âˆ’</button><span class="count" id="count-${index}">0</span><button class="btn-plus" style="background:${data.themeColor}" onclick="updateCart('${item.name}', ${item.price}, 1)">+</button></div></div>`;
      });
      document.getElementById('menu-list').innerHTML = html;
    }

    function updateCart(name, price, change) {
      if (!cart[name]) cart[name] = 0; cart[name] += change; if (cart[name] < 0) cart[name] = 0;
      const items = currentShop.menu; let total = 0; let count = 0;
      items.forEach((item, index) => {
        if (item.name === name) document.getElementById(`count-${index}`).innerText = cart[name];
        if (cart[item.name]) { total += cart[item.name] * item.price; count += cart[item.name]; }
      });
      document.getElementById('total-display').innerText = total;
      const btn = document.getElementById('checkout-btn'); btn.innerText = `é€å‡ºè¨‚å–® (${count})`;
      if (count > 0) { btn.classList.add('active'); btn.style.backgroundColor = currentShop.themeColor; } else { btn.classList.remove('active'); btn.style.backgroundColor = '#ccc'; }
    }

    async function sendOrder() {
      if (!liff.isInClient()) { alert('è«‹åœ¨ LINE App ä¸­ä½¿ç”¨'); return; }
      let orderDetail = ""; let total = 0;
      for (let [name, qty] of Object.entries(cart)) { if (qty > 0) { let item = currentShop.menu.find(i => i.name === name); let subtotal = item.price * qty; orderDetail += `${name} x ${qty} ($${subtotal})\n`; total += subtotal; } }
      if (total === 0) { alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼"); return; }
      orderDetail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ`;

      let userPhone = localStorage.getItem("uni_user_phone");
      if (!userPhone) {
        userPhone = prompt("è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œä»¥ä¾¿åº—å®¶è¯çµ¡ï¼š");
        if (!userPhone || userPhone.trim() === "") { alert("âŒ å¿…é ˆå¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼"); return; }
        localStorage.setItem("uni_user_phone", userPhone);
      }
      orderDetail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${userPhone}`;

      const btn = document.getElementById('checkout-btn'); btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
      try {
        await liff.sendMessages([{ type: "text", text: `ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${orderDetail}` }]);
        const orderData = { shopId: currentShop.id, userName: userProfile.displayName, userId: userProfile.userId, order: orderDetail };
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
        alert("âœ… è¨‚å–®å·²é€å‡ºï¼"); goLobby();
      } catch (err) { alert("ç™¼é€å¤±æ•—ï¼š" + err.message); btn.innerText = "é‡è©¦"; btn.disabled = false; }
    }
    
    function goLobby() { const url = new URL(window.location); url.searchParams.delete('id'); window.history.pushState({}, '', url); switchTab('lobby'); }
    function showError(msg) { document.getElementById('loading').classList.add('hidden'); document.getElementById('error-box').classList.remove('hidden'); document.getElementById('error-box').innerText = msg; }

    main();
  </script>
</body>
</html>
