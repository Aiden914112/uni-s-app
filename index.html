<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S ç”Ÿæ´»åœˆ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ==================== å…¨å±€è®Šæ•¸ ==================== */
    :root { 
      --primary: #06C755; 
      --gold: #C5A674; /* è³ªæ„Ÿé‡‘ */
      --dark-bg: #2C3E50;
      --bg: #F5F6F7; 
      --text: #333; 
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 0; margin: 0; background-color: var(--bg); color: var(--text); touch-action: manipulation; -webkit-user-select: none; user-select: none; padding-bottom: 90px; }
    .hidden { display: none !important; }
    #loading, #error-box { text-align: center; padding: 50px; color: #999; }

    /* åº•éƒ¨å°èˆª */
    #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; height: 60px; display: flex; border-top: 1px solid #eee; z-index: 200; padding-bottom: env(safe-area-inset-bottom); }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; }
    .tab-item.active { color: var(--primary); }
    .tab-icon { font-size: 22px; margin-bottom: 3px; }

    /* ==================== ğŸ‘¤ æœƒå“¡ä¸­å¿ƒ (Member Center) - å…¨æ–°ç¾ç·¨ç‰ˆ ==================== */
    #member-view { padding: 0; }
    
    /* 1. é ­éƒ¨èƒŒæ™¯ (æ²‰æµ¸å¼) */
    .member-header-bg { 
      background-color: var(--bg);
      height: 100px; /* ç•™ç™½çµ¦å¡ç‰‡ä¸Šæµ® */
    }

    /* 2. å°Šçˆµé»‘é‡‘æœƒå“¡å¡ */
    .premium-card {
      margin: -80px 15px 15px 15px; /* å‘ä¸Šæµ®å‹• */
      background: linear-gradient(135deg, #2b2b2b, #1a1a1a); /* é»‘é‡‘è³ªæ„Ÿ */
      border-radius: 16px;
      padding: 20px;
      color: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      position: relative;
      overflow: hidden;
    }
    /* å¡ç‰‡èƒŒæ™¯è£é£¾ç´‹è·¯ */
    .premium-card::after {
      content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(197, 166, 116, 0.1) 0%, transparent 70%);
      border-radius: 50%; pointer-events: none;
    }

    /* ç”¨æˆ¶åŸºæœ¬è³‡æ–™åˆ— */
    .card-user-row { display: flex; align-items: center; margin-bottom: 25px; }
    .card-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); margin-right: 12px; }
    .card-user-info { flex: 1; }
    .card-name { font-size: 18px; font-weight: bold; color: var(--gold); }
    .card-level-tag { 
      display: inline-block; background: linear-gradient(to right, #C5A674, #E5C690); 
      color: #000; font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 10px; 
      margin-top: 4px; 
    }
    .card-qr-btn { font-size: 24px; color: var(--gold); opacity: 0.8; }

    /* æ•¸æ“šä¸‰æ¬„ (é¤˜é¡/ç©åˆ†/å„ªæƒ åˆ¸) */
    .card-stats-row { display: flex; justify-content: space-between; text-align: center; position: relative; z-index: 2; }
    .stat-box { flex: 1; }
    .stat-num { font-size: 22px; font-weight: bold; display: block; margin-bottom: 4px; font-family: 'DIN Alternate', sans-serif; }
    .stat-label { font-size: 11px; color: rgba(255,255,255,0.6); }
    /* ä¸­é–“çš„åˆ†éš”ç·š */
    .stat-box:nth-child(2) { border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1); }

    /* ç­‰ç´šé€²åº¦æ¢ */
    .level-progress-container { margin-top: 20px; }
    .level-info { display: flex; justify-content: space-between; font-size: 10px; color: rgba(197, 166, 116, 0.8); margin-bottom: 5px; }
    .progress-track { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
    .progress-bar { height: 100%; background: var(--gold); width: 0%; border-radius: 2px; }

    /* 3. åŠŸèƒ½æœå‹™å°ˆæ¬„ (Service Grid) */
    .service-section { 
      background: #fff; margin: 0 15px 15px 15px; 
      border-radius: 12px; padding: 15px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
    }
    .service-title { font-size: 14px; font-weight: bold; margin-bottom: 15px; color: #333; }
    .service-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .service-item { text-align: center; cursor: pointer; }
    .service-item:active { opacity: 0.6; }
    .service-icon { 
      width: 40px; height: 40px; margin: 0 auto 5px auto; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 20px; color: #555; 
      /* ç¨å¾®ä¸€é»èƒŒæ™¯è‰²å¢åŠ å±¤æ¬¡ */
      background: #f9f9f9; border-radius: 10px;
    }
    .service-label { font-size: 11px; color: #666; }

    /* 4. æ­·å²è¨‚å–® (History) */
    .history-section { margin: 0 15px 20px 15px; }
    .history-item { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .h-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: #888; }
    .h-shop { font-size: 15px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .h-content { font-size: 13px; color: #666; background: #f9f9f9; padding: 8px; border-radius: 6px; }
    .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
    .status-wait { background: #FFF3E0; color: #F57C00; }
    .status-ok { background: #E8F5E9; color: #388E3C; }
    .status-no { background: #FFEBEE; color: #D32F2F; }

    /* å…¶ä»–é é¢æ¨£å¼ (ä¿æŒä¸è®Š) */
    #lobby-view { padding: 15px; }
    .search-bar { background: #fff; padding: 10px; border-radius: 20px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .search-bar input { border: none; flex: 1; outline: none; margin-left: 10px; }
    .shop-card-classic { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .classic-banner { height: 150px; background-size: cover; background-position: center; }
    .classic-info { padding: 12px; }
    .classic-name { font-size: 16px; font-weight: bold; }
    
    #orders-view { padding: 15px; }
    .order-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    
    #shop-view { background: #f8f9fa; }
    #banner { width: 100%; height: 200px; background-size: cover; background-position: center; position: relative; }
    #shop-name-title { position: absolute; bottom: 20px; left: 20px; color: white; font-size: 24px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); margin: 0; }
    #back-btn-shop { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; z-index: 10; display:flex; align-items:center; justify-content:center; }
    .menu-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
    .stepper { display: flex; align-items: center; background: #f0f0f0; border-radius: 20px; padding: 2px; }
    .stepper button { width: 32px; height: 32px; border-radius: 50%; border: none; }
    .btn-plus { background: var(--primary); color: white; }
    #cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 100; padding-bottom: max(15px, env(safe-area-inset-bottom)); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    #checkout-btn { background: var(--primary); color: white; padding: 10px 30px; border-radius: 30px; border:none; font-weight: bold; }
  </style>
</head>
<body>

  <div id="loading">è¼‰å…¥ä¸­...</div>
  <div id="error-box" class="hidden"></div>

  <div id="lobby-view" class="hidden">
    <div class="search-bar"><i class="fas fa-search" style="color:#999;"></i><input type="text" id="search-input" placeholder="æœå°‹åº—å®¶..." oninput="filterShops()"></div>
    <div style="font-weight:bold; margin-bottom:10px; color:#333;">æ¨è–¦å•†å®¶</div>
    <div id="shop-list"></div>
  </div>

  <div id="orders-view" class="hidden">
    <div style="font-weight:bold; margin-bottom:10px; color:#333;">æˆ‘çš„è¨‚å–®</div>
    <div id="orders-list-container"></div>
  </div>

  <div id="member-view" class="hidden">
    <div class="member-header-bg"></div>
    
    <div class="premium-card">
      <div class="card-user-row">
        <img id="m-avatar" src="" class="card-avatar">
        <div class="card-user-info">
          <div id="m-name" class="card-name">...</div>
          <div id="m-level" class="card-level-tag">æ™®é€šæœƒå“¡</div>
        </div>
        <div class="card-qr-btn"><i class="fas fa-qrcode"></i></div>
      </div>
      
      <div class="card-stats-row">
        <div class="stat-box">
          <span class="stat-num">0</span>
          <span class="stat-label">é¤˜é¡</span>
        </div>
        <div class="stat-box">
          <span class="stat-num" id="m-points">0</span>
          <span class="stat-label">ç©åˆ†</span>
        </div>
        <div class="stat-box">
          <span class="stat-num">0</span>
          <span class="stat-label">å„ªæƒ åˆ¸</span>
        </div>
      </div>

      <div class="level-progress-container">
        <div class="level-info">
          <span>æˆé•·å€¼ <span id="m-exp-current">0</span>/<span id="m-exp-next">100</span></span>
          <span>å†ç´¯ç© <span id="m-exp-need">100</span> å‡ç´š</span>
        </div>
        <div class="progress-track">
          <div class="progress-bar" id="m-progress" style="width: 0%;"></div>
        </div>
      </div>
    </div>

    <div class="service-section">
      <div class="service-title">æˆ‘çš„æœå‹™</div>
      <div class="service-grid">
        <div class="service-item" onclick="alert('ç©åˆ†å…Œæ›åŠŸèƒ½é–‹ç™¼ä¸­')">
          <div class="service-icon"><i class="fas fa-gift"></i></div>
          <div class="service-label">ç©åˆ†å…Œæ›</div>
        </div>
        <div class="service-item" onclick="alert('è¯ç¹«å®¢æœåŠŸèƒ½é–‹ç™¼ä¸­')">
          <div class="service-icon"><i class="fas fa-headset"></i></div>
          <div class="service-label">è¯ç¹«å®¢æœ</div>
        </div>
        <div class="service-item" onclick="alert('å¸¸è¦‹å•é¡ŒåŠŸèƒ½é–‹ç™¼ä¸­')">
          <div class="service-icon"><i class="fas fa-question-circle"></i></div>
          <div class="service-label">å¸¸è¦‹å•é¡Œ</div>
        </div>
        <div class="service-item" onclick="alert('é—œæ–¼æˆ‘å€‘åŠŸèƒ½é–‹ç™¼ä¸­')">
          <div class="service-icon"><i class="fas fa-info-circle"></i></div>
          <div class="service-label">é—œæ–¼æˆ‘å€‘</div>
        </div>
        <div class="service-item" onclick="alert('åœ°å€ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­')">
          <div class="service-icon"><i class="fas fa-map-marker-alt"></i></div>
          <div class="service-label">åœ°å€ç®¡ç†</div>
        </div>
        <div class="service-item" onclick="alert('ç™¼ç¥¨ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­')">
          <div class="service-icon"><i class="fas fa-file-invoice"></i></div>
          <div class="service-label">ç™¼ç¥¨ç®¡ç†</div>
        </div>
      </div>
    </div>

    <div class="history-section">
      <div class="service-title">æœ€è¿‘è¨‚å–®</div>
      <div id="history-loading" style="text-align:center; color:#999; font-size:12px;">æŸ¥è©¢ä¸­...</div>
      <div id="history-list"></div>
    </div>
  </div>

  <div id="shop-view" class="hidden">
    <button id="back-btn-shop" onclick="goLobby()">â€¹</button>
    <div id="banner"><h1 id="shop-name-title">...</h1></div>
    <div class="container"><div id="menu-list"></div></div>
    <div id="cart-bar">
      <div>ç¸½è¨ˆ $<span id="total-display">0</span></div>
      <button id="checkout-btn" onclick="sendOrder()">é€å‡ºè¨‚å–® (0)</button>
    </div>
  </div>

  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('lobby')"><div class="tab-icon"><i class="fas fa-home"></i></div><div>é¦–é </div></div>
    <div class="tab-item" onclick="switchTab('orders')"><div class="tab-icon"><i class="fas fa-receipt"></i></div><div>è¨‚å–®</div></div>
    <div class="tab-item" onclick="switchTab('member')"><div class="tab-icon"><i class="fas fa-user"></i></div><div>æœƒå“¡</div></div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ é€™è£¡å¡«å…¥ä½ çš„ ID å’Œ URL âš ï¸âš ï¸âš ï¸
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";

    let allShops = {}; let currentShop = null; let cart = {}; let userProfile = null;

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        
        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        const shopId = new URLSearchParams(window.location.search).get('id');
        if (shopId && allShops[shopId]) openShop(shopId);
        else { renderLobby(allShops); switchTab('lobby'); }
        
        fetchMemberData(); // é è¼‰æœƒå“¡è³‡æ–™

      } catch (err) { showError(err.message); }
    }

    function switchTab(tab) {
      ['lobby-view', 'orders-view', 'member-view', 'shop-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('tab-bar').classList.remove('hidden');
      document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
      
      if (tab === 'lobby') {
        document.getElementById('lobby-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[0].classList.add('active');
      } else if (tab === 'orders') {
        document.getElementById('orders-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[1].classList.add('active');
        loadOrderHistory('orders-list-container');
      } else if (tab === 'member') {
        document.getElementById('member-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[2].classList.add('active');
        fetchMemberData();
        loadOrderHistory('history-list');
      }
    }

    async function fetchMemberData() {
      document.getElementById('m-name').innerText = userProfile.displayName;
      document.getElementById('m-avatar').src = userProfile.pictureUrl;
      try {
        const res = await fetch(`${API_URL}?action=getMember&userId=${userProfile.userId}`);
        const data = await res.json();
        let points = parseInt(data.points) || 0;
        document.getElementById('m-points').innerText = points;
        document.getElementById('m-level').innerText = data.level;
        
        // æ¨¡æ“¬ç¶“é©—å€¼
        let currentExp = points % 100;
        document.getElementById('m-exp-current').innerText = currentExp;
        document.getElementById('m-exp-need').innerText = 100 - currentExp;
        document.getElementById('m-progress').style.width = currentExp + "%";
      } catch(e) { console.error(e); }
    }

    async function loadOrderHistory(containerId) {
      const listDiv = document.getElementById(containerId);
      if(!listDiv) return;
      listDiv.innerHTML = ''; 
      if(containerId === 'history-list') document.getElementById('history-loading').style.display = 'block';

      try {
        const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", userId: userProfile.userId }) });
        const history = await response.json();
        if(containerId === 'history-list') document.getElementById('history-loading').style.display = 'none';
        
        if (history.length === 0) { listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;margin-top:10px;">æš«ç„¡è¨‚å–®</div>'; return; }
        
        let html = '';
        history.forEach(order => {
          let badgeClass = 'status-wait';
          if (order.status.includes('å·²æ¥å–®')) badgeClass = 'status-ok';
          if (order.status.includes('å·²å©‰æ‹’')) badgeClass = 'status-no';
          // è¨‚å–®åˆ—è¡¨æ¨£å¼ (å…±ç”¨)
          html += `
            <div style="background:#fff; padding:15px; border-radius:12px; margin-bottom:10px; box-shadow:0 2px 5px rgba(0,0,0,0.02);">
              <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:12px; color:#888;">
                <span>${order.time}</span>
                <span class="status-badge ${badgeClass}">${order.status}</span>
              </div>
              <div style="font-weight:bold; color:#333; margin-bottom:5px;">${order.shopName}</div>
              <div style="font-size:13px; color:#666; background:#f9f9f9; padding:8px; border-radius:6px;">${order.content}</div>
            </div>`;
        });
        listDiv.innerHTML = html;
      } catch (e) { console.error(e); }
    }

    // å¤§å»³èˆ‡æœå°‹
    function renderLobby(shops) {
      const list = document.getElementById('shop-list');
      let html = '';
      Object.keys(shops).forEach(id => {
        const s = shops[id];
        html += `<div class="shop-card-classic" onclick="openShop('${id}', true)"><div class="classic-banner" style="background-image:url(${s.bannerUrl})"></div><div class="classic-info"><div class="classic-name">${s.name}</div><div class="classic-desc">é»æ“Šé€²å…¥é ç´„...</div></div></div>`;
      });
      list.innerHTML = html;
    }
    function filterShops() {
      const term = document.getElementById('search-input').value.toLowerCase();
      const filtered = {};
      Object.keys(allShops).forEach(id => { if(allShops[id].name.toLowerCase().includes(term)) filtered[id] = allShops[id]; });
      renderLobby(filtered);
    }

    // é»é¤åŠŸèƒ½
    function openShop(id, pushHistory=false) {
      currentShop = allShops[id]; currentShop.id = id; cart = {};
      if(pushHistory) { const url = new URL(window.location); url.searchParams.set('id', id); window.history.pushState({}, '', url); }
      document.getElementById('tab-bar').classList.add('hidden'); ['lobby-view','orders-view','member-view'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('shop-view').classList.remove('hidden');
      
      document.getElementById('shop-name-title').innerText = currentShop.name;
      document.getElementById('banner').style.backgroundImage = `url(${currentShop.bannerUrl})`;
      document.getElementById('total-display').innerText = '0';
      const btn = document.getElementById('checkout-btn'); btn.innerText = 'é€å‡ºè¨‚å–® (0)'; btn.classList.remove('active'); btn.style.backgroundColor = '#ccc';
      
      let html = '';
      currentShop.menu.forEach((item, idx) => {
        html += `<div class="menu-item"><div><span style="font-weight:bold;display:block;">${item.name}</span><span style="color:#e64a19;font-weight:bold;">$${item.price}</span></div><div class="stepper"><button class="btn-minus" onclick="upd('${item.name}',${item.price},-1)">âˆ’</button><span class="count" id="c-${idx}">0</span><button class="btn-plus" style="background:${currentShop.themeColor}" onclick="upd('${item.name}',${item.price},1)">+</button></div></div>`;
      });
      document.getElementById('menu-list').innerHTML = html;
    }

    function upd(n,p,c) {
      if(!cart[n]) cart[n]=0; cart[n]+=c; if(cart[n]<0) cart[n]=0;
      const items = currentShop.menu; let total=0, count=0;
      items.forEach((i, idx) => {
        if(i.name===n) document.getElementById(`c-${idx}`).innerText = cart[n];
        if(cart[i.name]) { total+=cart[i.name]*i.price; count+=cart[i.name]; }
      });
      document.getElementById('total-display').innerText = total;
      const btn = document.getElementById('checkout-btn'); btn.innerText = `é€å‡ºè¨‚å–® (${count})`;
      if(count>0) { btn.classList.add('active'); btn.style.backgroundColor = currentShop.themeColor; } else { btn.classList.remove('active'); btn.style.backgroundColor = '#ccc'; }
    }

    async function sendOrder() {
      if (!liff.isInClient()) { alert('è«‹åœ¨ LINE App ä¸­ä½¿ç”¨'); return; }
      let detail = "", total = 0;
      for (let [n, q] of Object.entries(cart)) { if (q>0) { let i = currentShop.menu.find(x=>x.name===n); let s = i.price*q; detail+=`${n} x ${q} ($${s})\n`; total+=s; } }
      if (total===0) return; detail+=`----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ`;
      
      let phone = localStorage.getItem("uni_user_phone");
      if (!phone) { phone = prompt("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼š"); if(!phone) return; localStorage.setItem("uni_user_phone", phone); }
      detail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${phone}`;

      const btn = document.getElementById('checkout-btn'); btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
      try {
        await liff.sendMessages([{type:"text", text:`ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${detail}`}]);
        await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({shopId:currentShop.id, userName:userProfile.displayName, userId:userProfile.userId, order:detail})});
        alert("âœ… è¨‚å–®å·²é€å‡ºï¼"); goLobby();
      } catch(e) { alert("å¤±æ•—: "+e.message); btn.innerText = "é‡è©¦"; btn.disabled = false; }
    }

    function goLobby() { const url = new URL(window.location); url.searchParams.delete('id'); window.history.pushState({}, '', url); switchTab('lobby'); }
    function showError(m) { document.getElementById('loading').classList.add('hidden'); document.getElementById('error-box').classList.remove('hidden'); document.getElementById('error-box').innerText = m; }

    main();
  </script>
</body>
</html>
