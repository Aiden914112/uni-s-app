<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S ç”Ÿæ´»åœˆ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* CSS è¨­å®š (èˆ‡ä¹‹å‰ç›¸åŒï¼Œæ–°å¢äº†æ­·å²è¨‚å–®æ¨£å¼) */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 0; margin: 0; background-color: #f2f3f5; touch-action: manipulation; -webkit-user-select: none; user-select: none; padding-bottom: 90px; }
    .hidden { display: none !important; }
    
    #loading, #error-box { text-align: center; padding: 50px; color: #999; }
    
    #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; height: 60px; display: flex; border-top: 1px solid #eee; z-index: 200; padding-bottom: env(safe-area-inset-bottom); }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; -webkit-tap-highlight-color: transparent; }
    .tab-item.active { color: #06C755; }
    .tab-icon { font-size: 24px; margin-bottom: 2px; }

    /* å¤§å»³ */
    #lobby-view { padding: 20px; }
    .shop-card { background: white; border-radius: 16px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.1s; }
    .shop-card:active { transform: scale(0.98); }
    .card-banner { height: 140px; background-size: cover; background-position: center; position: relative; }
    .card-info { padding: 15px; }
    .card-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
    .card-tag { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; backdrop-filter: blur(4px); }

    /* æœƒå“¡ä¸­å¿ƒ */
    #member-view { padding: 20px; }
    .member-card { background: linear-gradient(135deg, #06C755, #04a545); border-radius: 20px; padding: 25px; color: white; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(6, 199, 85, 0.3); }
    .member-header { display: flex; align-items: center; margin-bottom: 20px; }
    .avatar { width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); margin-right: 15px; background: #eee; }
    .member-name { font-size: 20px; font-weight: bold; }
    .points-value { font-size: 36px; font-weight: 800; }
    .points-unit { font-size: 14px; font-weight: normal; }

    /* ğŸ”¥ æ­·å²è¨‚å–®åˆ—è¡¨æ¨£å¼ */
    .history-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 15px; display: flex; align-items: center; }
    .history-list { display: flex; flex-direction: column; gap: 15px; }
    .history-item { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .h-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #888; }
    .h-shop { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .h-content { font-size: 14px; color: #666; white-space: pre-wrap; margin-bottom: 10px; background: #f9f9f9; padding: 8px; border-radius: 6px; }
    .h-footer { display: flex; justify-content: space-between; align-items: center; }
    .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
    .status-wait { background: #fff3cd; color: #856404; } /* å¾…ç¢ºèª */
    .status-ok { background: #d4edda; color: #155724; }   /* å·²æ¥å–® */
    .status-no { background: #f8d7da; color: #721c24; }   /* å·²å©‰æ‹’ */

    /* é»é¤ */
    #shop-view { background: #f8f9fa; }
    #banner { width: 100%; height: 200px; background-size: cover; background-position: center; position: relative; background-color: #ddd; }
    #shop-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 20px; color: white; }
    #shop-name { font-size: 24px; font-weight: bold; margin: 0; }
    #back-btn { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .container { padding: 15px; }
    .menu-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .stepper { display: flex; align-items: center; background: #f0f0f0; border-radius: 20px; padding: 2px; }
    .stepper button { width: 32px; height: 32px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; }
    .btn-plus { background: #06C755; color: white; }
    #cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 100; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
    #checkout-btn { background: #06C755; color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none; }
    #checkout-btn.active { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body>

  <div id="loading">è¼‰å…¥ä¸­...</div>
  <div id="error-box" class="hidden"></div>

  <div id="lobby-view" class="hidden">
    <div id="lobby-title">Uni-S <span>ç”Ÿæ´»åœˆ</span></div>
    <div style="font-size:14px; color:#666; margin-bottom:15px;">ä½ å¥½ï¼Œ<span id="lobby-user"></span>ï¼ä»Šå¤©è¦æ¢ç´¢å“ªå®¶å¥½åº—ï¼Ÿ</div>
    <div id="shop-list"></div>
  </div>

  <div id="member-view" class="hidden">
    <div class="member-card">
      <div class="member-header">
        <img id="m-avatar" src="" class="avatar">
        <div>
          <div id="m-name" class="member-name">...</div>
          <div style="font-size:12px; opacity:0.9;">Uni-S æœƒå“¡</div>
        </div>
      </div>
      <div style="font-size:12px; opacity:0.8;">ç›®å‰ç´¯ç©é»æ•¸</div>
      <div class="points-value"><span id="m-points">0</span> <span class="points-unit">P</span></div>
    </div>

    <div class="history-title">ğŸ“œ æœ€è¿‘è¨‚å–®ç´€éŒ„</div>
    <div id="history-loading" style="text-align:center; color:#999; font-size:12px;">æ­£åœ¨æŸ¥è©¢...</div>
    <div id="history-list" class="history-list"></div>
  </div>

  <div id="shop-view" class="hidden">
    <button id="back-btn" onclick="goLobby()">â€¹</button>
    <div id="banner"><div id="shop-info"><h1 id="shop-name">è¼‰å…¥ä¸­...</h1></div></div>
    <div class="container"><div id="menu-list"></div></div>
    <div id="cart-bar">
      <div>ç¸½è¨ˆ $<span id="total-display">0</span></div>
      <button id="checkout-btn" onclick="sendOrder()">é€å‡ºè¨‚å–® (0)</button>
    </div>
  </div>

  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('lobby')">
      <div class="tab-icon">ğŸ </div><div>é¦–é </div>
    </div>
    <div class="tab-item" onclick="switchTab('member')">
      <div class="tab-icon">ğŸ‘¤</div><div>æœƒå“¡</div>
    </div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ è¨˜å¾—å¡«å…¥ ID å’Œ URL
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";

    let allShops = {}; let currentShop = null; let cart = {}; let userProfile = null;

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        document.getElementById('lobby-user').innerText = userProfile.displayName;

        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        const shopId = new URLSearchParams(window.location.search).get('id');
        if (shopId && allShops[shopId]) openShop(shopId);
        else { renderLobby(); switchTab('lobby'); }
      } catch (err) { showError(err.message); }
    }

    function switchTab(tab) {
      document.getElementById('lobby-view').classList.add('hidden');
      document.getElementById('member-view').classList.add('hidden');
      document.getElementById('shop-view').classList.add('hidden');
      document.getElementById('tab-bar').classList.remove('hidden');
      document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
      
      if (tab === 'lobby') {
        document.getElementById('lobby-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[0].classList.add('active');
      } else if (tab === 'member') {
        document.getElementById('member-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[1].classList.add('active');
        fetchMemberData();
        loadOrderHistory(); // ğŸ”¥ åˆ‡æ›åˆ°æœƒå“¡é æ™‚ï¼Œè¼‰å…¥æ­·å²è¨‚å–®
      }
    }

// ğŸ•µï¸ åµéŒ¯ç‰ˆï¼šæª¢æŸ¥åˆ°åº•æ˜¯èª°ä¸è¦‹äº†
    async function fetchMemberData() {
      try {
        // 1. æª¢æŸ¥ userProfile
        if (!userProfile) throw new Error("userProfile æ˜¯ç©ºçš„ï¼(å¯èƒ½å°šæœªç™»å…¥æˆåŠŸ)");
        
        // 2. æª¢æŸ¥ HTML å…ƒç´ æ˜¯å¦å­˜åœ¨
        const elName = document.getElementById('m-name');
        const elAvatar = document.getElementById('m-avatar');
        const elPoints = document.getElementById('m-points');
        const elLevel = document.getElementById('m-level');

        if (!elName) throw new Error("æ‰¾ä¸åˆ° id='m-name' çš„å…ƒç´  (HTMLä¸å®Œæ•´)");
        if (!elAvatar) throw new Error("æ‰¾ä¸åˆ° id='m-avatar' çš„å…ƒç´  (HTMLä¸å®Œæ•´)");
        if (!elPoints) throw new Error("æ‰¾ä¸åˆ° id='m-points' çš„å…ƒç´  (HTMLä¸å®Œæ•´)");

        // 3. æ›´æ–° UI
        elName.innerText = userProfile.displayName;
        elAvatar.src = userProfile.pictureUrl;
        elPoints.innerText = "...";
        
        // 4. å‘¼å«å¾Œç«¯
        const url = `${API_URL}?action=getMember&userId=${userProfile.userId}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (!data) throw new Error("å¾Œç«¯å›å‚³ç©ºçš„è³‡æ–™");

        elPoints.innerText = data.points;
        if (elLevel) elLevel.innerText = data.level;
        
      } catch(e) { 
        console.error(e);
        // è·³å‡ºæ›´è©³ç´°çš„éŒ¯èª¤è¦–çª—
        alert("æŠ“åˆ°éŒ¯èª¤äº†ï¼\nåŸå› ï¼š" + e.message);
      }
    }

    // ğŸ”¥ è¼‰å…¥æ­·å²è¨‚å–®å‡½æ•¸
    async function loadOrderHistory() {
      const listDiv = document.getElementById('history-list');
      const loadingDiv = document.getElementById('history-loading');
      listDiv.innerHTML = '';
      loadingDiv.style.display = 'block';

      try {
        // ä½¿ç”¨ fetch é€å‡º post è«‹æ±‚æŸ¥è©¢æ­·å²
        // æ³¨æ„ï¼šå¦‚æœä½ æ²’æœ‰è¨­å®š CORSï¼Œé€™è£¡å¯èƒ½æœƒè®€ä¸åˆ°å›å‚³å€¼
        // ä½†æˆ‘å€‘å¯ä»¥ç”¨ JSONP æˆ–ç°¡å–®çš„ POST å˜—è©¦
        // é€™è£¡ç‚ºäº†æ¼”ç¤ºï¼Œå‡è¨­ä½ å·²ç¶“è§£æ±ºè·¨åŸŸæˆ–ä½¿ç”¨ no-cors (ä½† no-cors è®€ä¸åˆ°è³‡æ–™)
        // âœ¨ æŠ€å·§ï¼šç”¨ GET + URLåƒæ•¸ ä¾†é¿é–‹éƒ¨åˆ† CORS å•é¡Œï¼Œæˆ–æ˜¯ Apps Script å¿…é ˆæ­£ç¢ºå›å‚³ header
        
        // ç‚ºäº†ç¢ºä¿ä½ èƒ½çœ‹åˆ°æ•ˆæœï¼Œæˆ‘å€‘å˜—è©¦ç”¨ GET (å‰ææ˜¯å¾Œç«¯ doPost ä¹Ÿè¦æ”¯æ´ doGet æŸ¥è©¢ï¼Œæˆ–æ˜¯æˆ‘å€‘æ”¹ç”¨ POST)
        // é€™è£¡ç¤ºç¯„æ¨™æº– POST fetchï¼Œå¦‚æœä½ çš„ Apps Script æœ‰æ­£ç¢ºè¨­å®šå›å‚³ header å°±èƒ½è®€åˆ°
        
        const response = await fetch(API_URL, {
          method: 'POST',
          // âš ï¸ é—œéµï¼šå¦‚æœä½ æƒ³è¦è®€å–å›å‚³å€¼ï¼Œä¸èƒ½ç”¨ 'no-cors'ï¼Œå¿…é ˆç”¨ 'cors'
          // ä½† Apps Script éœ€è¦ç‰¹æ®Šè™•ç†ã€‚å¦‚æœé€™è£¡å¤±æ•—ï¼Œæˆ‘å€‘å…ˆé¡¯ç¤ºå‡è³‡æ–™
          body: JSON.stringify({ action: "getHistory", userId: userProfile.userId })
        });
        
        // å¦‚æœ Apps Script æ²’æœ‰è¨­ CORS headerï¼Œé€™è£¡æœƒå ±éŒ¯ï¼Œæˆ‘å€‘å°± catch ä½
        const history = await response.json();
        
        loadingDiv.style.display = 'none';
        
        if (history.length === 0) {
          listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">å°šç„¡è¨‚å–®ç´€éŒ„</div>';
          return;
        }

        let html = '';
        history.forEach(order => {
          let badgeClass = 'status-wait';
          if (order.status.includes('å·²æ¥å–®')) badgeClass = 'status-ok';
          if (order.status.includes('å·²å©‰æ‹’')) badgeClass = 'status-no';

          html += `
            <div class="history-item">
              <div class="h-header">
                <span>${order.time}</span>
                <span>#${order.orderId}</span>
              </div>
              <div class="h-shop">${order.shopName}</div>
              <div class="h-content">${order.content}</div>
              <div class="h-footer">
                <span class="status-badge ${badgeClass}">${order.status}</span>
              </div>
            </div>
          `;
        });
        listDiv.innerHTML = html;

      } catch (e) {
        console.error(e);
        loadingDiv.style.display = 'none';
        listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">ç„¡æ³•è®€å–ç´€éŒ„ (è·¨åŸŸé™åˆ¶)</div>';
      }
    }

    // ... (ä»¥ä¸‹ renderLobby, renderShopUI, updateCart, sendOrder, goLobby ä¿æŒä¸è®Š) ...
    // ç‚ºç¯€çœç¯‡å¹…ï¼Œè«‹ä¿ç•™ä½ åŸæœ¬çš„é€™äº›å‡½æ•¸ï¼Œå®ƒå€‘ä¸éœ€è¦æ”¹å‹•
    // åªè¦ç¢ºä¿ sendOrder è£¡é¢çš„ orderData æœ‰åŒ…å« userId å³å¯

    function renderLobby() {
      const list = document.getElementById('shop-list');
      let html = '';
      Object.keys(allShops).forEach(id => {
        const s = allShops[id];
        html += `<div class="shop-card" onclick="openShop('${id}', true)"><div class="card-banner" style="background-image:url(${s.bannerUrl})"><div class="card-tag">ç‡Ÿæ¥­ä¸­</div></div><div class="card-info"><div class="card-name">${s.name}</div><div class="card-desc">é»æ“Šé€²å…¥é ç´„é»é¤...</div></div></div>`;
      });
      list.innerHTML = html;
    }

    function openShop(id, pushHistory=false) {
      currentShop = allShops[id]; currentShop.id = id; cart = {};
      if(pushHistory) { const url = new URL(window.location); url.searchParams.set('id', id); window.history.pushState({}, '', url); }
      document.getElementById('tab-bar').classList.add('hidden'); document.getElementById('lobby-view').classList.add('hidden'); document.getElementById('member-view').classList.add('hidden'); document.getElementById('shop-view').classList.remove('hidden');
      renderShopUI(currentShop);
    }
    
    function renderShopUI(data) {
      document.getElementById('shop-name').innerText = data.name; document.getElementById('banner').style.backgroundImage = `url(${data.bannerUrl})`; document.getElementById('total-display').innerText = '0';
      const btn = document.getElementById('checkout-btn'); btn.innerText = 'é€å‡ºè¨‚å–® (0)'; btn.classList.remove('active'); btn.style.backgroundColor = '#ccc';
      let html = '';
      data.menu.forEach((item, index) => {
        html += `<div class="menu-item"><div style="flex:1;"><span class="item-name">${item.name}</span><span class="item-price">$${item.price}</span></div><div class="stepper"><button class="btn-minus" onclick="updateCart('${item.name}', ${item.price}, -1)">âˆ’</button><span class="count" id="count-${index}">0</span><button class="btn-plus" style="background:${data.themeColor}" onclick="updateCart('${item.name}', ${item.price}, 1)">+</button></div></div>`;
      });
      document.getElementById('menu-list').innerHTML = html;
    }

    function updateCart(name, price, change) {
      if (!cart[name]) cart[name] = 0; cart[name] += change; if (cart[name] < 0) cart[name] = 0;
      const items = currentShop.menu; let total = 0; let count = 0;
      items.forEach((item, index) => {
        if (item.name === name) document.getElementById(`count-${index}`).innerText = cart[name];
        if (cart[item.name]) { total += cart[item.name] * item.price; count += cart[item.name]; }
      });
      document.getElementById('total-display').innerText = total;
      const btn = document.getElementById('checkout-btn'); btn.innerText = `é€å‡ºè¨‚å–® (${count})`;
      if (count > 0) { btn.classList.add('active'); btn.style.backgroundColor = currentShop.themeColor; } else { btn.classList.remove('active'); btn.style.backgroundColor = '#ccc'; }
    }

    async function sendOrder() {
      if (!liff.isInClient()) { alert('è«‹åœ¨ LINE App ä¸­ä½¿ç”¨'); return; }
      let orderDetail = ""; let total = 0;
      for (let [name, qty] of Object.entries(cart)) { if (qty > 0) { let item = currentShop.menu.find(i => i.name === name); let subtotal = item.price * qty; orderDetail += `${name} x ${qty} ($${subtotal})\n`; total += subtotal; } }
      if (total === 0) return;
      orderDetail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ`;
      const btn = document.getElementById('checkout-btn'); btn.innerText = "è™•ç†ä¸­...";
      try {
        await liff.sendMessages([{ type: "text", text: `ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${orderDetail}` }]);
        const orderData = { shopId: currentShop.id, userName: userProfile.displayName, userId: userProfile.userId, order: orderDetail };
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
        alert("âœ… è¨‚å–®å·²é€å‡ºï¼"); goLobby();
      } catch (err) { alert("ç™¼é€å¤±æ•—ï¼š" + err.message); btn.innerText = "é‡è©¦"; }
    }
    
    function goLobby() { const url = new URL(window.location); url.searchParams.delete('id'); window.history.pushState({}, '', url); switchTab('lobby'); }
    function showError(msg) { document.getElementById('loading').classList.add('hidden'); document.getElementById('error-box').classList.remove('hidden'); document.getElementById('error-box').innerText = msg; }

    main();
  </script>
</body>
</html>