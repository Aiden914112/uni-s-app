<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S ç”Ÿæ´»åœˆ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ==================== 0. å…¨å±€è®Šæ•¸èˆ‡é‡ç½® ==================== */
    :root { 
      --primary: #06C755; --gold: #C5A674; --bg: #F5F6F7; --text: #333; 
      --tea-sidebar: #F5F5F5;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 0; margin: 0; background-color: var(--bg); color: var(--text); touch-action: manipulation; -webkit-user-select: none; user-select: none; padding-bottom: 90px; height: 100vh; overflow-y: auto; }
    .hidden { display: none !important; }
    #loading, #error-box { text-align: center; padding: 50px; color: #999; }

    /* ==================== 1. é€šç”¨å…ƒä»¶ ==================== */
    /* åº•éƒ¨å°èˆª */
    #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; height: 60px; display: flex; border-top: 1px solid #eee; z-index: 900; padding-bottom: env(safe-area-inset-bottom); }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; }
    .tab-item.active { color: var(--primary); font-weight: bold; }
    .tab-icon { font-size: 22px; margin-bottom: 3px; }

    /* å½ˆçª—é®ç½© */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    
    /* è¨Šæ¯å½ˆçª— */
    .msg-box { background: white; width: 80%; max-width: 320px; border-radius: 16px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.2s ease-out; }
    .msg-icon { font-size: 40px; margin-bottom: 15px; color: var(--primary); }
    .msg-text { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 20px; }
    .msg-btns { display: flex; gap: 10px; }
    .msg-btn { flex: 1; padding: 10px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
    .msg-btn-ok { background: var(--primary); color: white; }
    .msg-btn-cancel { background: #eee; color: #666; }

    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* ==================== 2. å¤§å»³ (Lobby) ==================== */
    #lobby-view { padding-bottom: 20px; }
    .lobby-header-bg { background: linear-gradient(135deg, #2c3e50, #000); height: 160px; border-radius: 0 0 20px 20px; padding: 20px; color: var(--gold); }
    .float-member-card { background: #fff; margin: -80px 15px 15px 15px; border-radius: 12px; padding: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); display: flex; align-items: center; cursor: pointer; }
    .mini-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; background: #eee; }
    .quick-points { margin-left: auto; text-align: center; border-left: 1px solid #eee; padding-left: 15px; }
    .quick-points .num { font-size: 20px; font-weight: bold; color: var(--gold); }
    
    .search-bar { margin: 0 15px 15px 15px; background: #fff; padding: 10px; border-radius: 20px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .search-bar input { border: none; flex: 1; outline: none; margin-left: 10px; font-size: 14px; }
    .filter-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 0 15px 10px 15px; scrollbar-width: none; }
    .filter-tag { background: #fff; padding: 6px 16px; border-radius: 20px; font-size: 13px; color: #666; border: 1px solid #eee; white-space: nowrap; cursor: pointer; }
    .filter-tag.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    
    .shop-card { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; padding: 10px; cursor: pointer; }
    .shop-thumb { width: 80px; height: 80px; border-radius: 8px; background-size: cover; background-position: center; flex-shrink: 0; }
    .shop-info { padding-left: 15px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .shop-name { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .shop-action .btn-visit { background: #333; color: var(--gold); border: none; padding: 4px 12px; border-radius: 20px; font-size: 12px; }

    /* ==================== 3. æœƒå“¡ä¸­å¿ƒ (Member) ==================== */
    .member-header-bg { background-color: var(--bg); height: 80px; }
    .premium-card { margin: -60px 15px 15px 15px; background: linear-gradient(135deg, #2b2b2b, #1a1a1a); border-radius: 16px; padding: 20px; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; overflow: hidden; }
    .card-user-row { display: flex; align-items: center; margin-bottom: 25px; }
    .card-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); margin-right: 12px; }
    .card-stats-row { display: flex; justify-content: space-between; text-align: center; }
    .stat-num { font-size: 20px; font-weight: bold; display: block; margin-bottom: 4px; }
    
    .service-section { background: #fff; margin: 0 15px 15px 15px; border-radius: 12px; padding: 20px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .service-item { text-align: center; cursor: pointer; }
    .service-icon { font-size: 24px; color: #555; margin-bottom: 5px; }
    
    .history-simple-item { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; }
    .hs-info { flex: 1; }
    .hs-shop { font-weight: bold; font-size: 15px; margin-bottom: 4px; }
    .hs-status { font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 4px; }
    .status-wait { background: #FFF3E0; color: #F57C00; }
    .status-ok { background: #E8F5E9; color: #388E3C; }
    .status-no { background: #FFEBEE; color: #D32F2F; }

    /* ==================== 4. è¨‚å–®è©³æƒ… (Order Detail) ==================== */
    #order-detail-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #F5F6F7; z-index: 950; overflow-y: auto; display: flex; flex-direction: column; }
    .od-navbar { background: #fff; padding: 15px; display: flex; align-items: center; font-weight: bold; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .od-content { padding: 15px; padding-bottom: 50px; }
    .od-card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .od-actions { display: flex; gap: 15px; margin-top: 10px; border-top: 1px solid #f5f5f5; padding-top: 10px; }
    .action-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #333; cursor: pointer; background: #f9f9f9; padding: 8px; border-radius: 8px; }
    .action-btn i { margin-right: 5px; }

    /* ==================== 5. åº—é‹ªé é¢ (Shop - é›™æ¨¡å¼) ==================== */
    #shop-view { background: #fff; height: 100vh; display: flex; flex-direction: column; }
    
    /* é ‚éƒ¨å°èˆª */
    .shop-header { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee; background: #fff; z-index: 10; }
    .shop-back-btn { font-size: 20px; width: 30px; cursor: pointer; }
    .shop-title-box { flex: 1; margin-left: 10px; }
    .shop-title { font-size: 16px; font-weight: bold; }
    .shop-subtitle { font-size: 11px; color: #999; }

    /* å®¹å™¨ï¼šæ ¹æ“šæ¨¡å¼åˆ‡æ› */
    .shop-body { flex: 1; display: flex; overflow: hidden; position: relative; }

    /* A. èŒ¶é£²æ¨¡å¼ (Food Mode) */
    .menu-sidebar { width: 85px; background: var(--tea-sidebar); overflow-y: auto; }
    .category-item { padding: 15px 5px; font-size: 13px; color: #666; text-align: center; cursor: pointer; border-left: 3px solid transparent; }
    .category-item.active { background: #fff; color: #333; font-weight: bold; border-left: 3px solid var(--primary); }
    .menu-content { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }
    .category-title { font-size: 13px; font-weight: bold; color: #666; margin: 15px 0 10px 0; }
    .food-item { display: flex; margin-bottom: 15px; }
    .food-img { width: 80px; height: 80px; border-radius: 8px; background-color: #eee; background-size: cover; background-position: center; flex-shrink: 0; }
    .food-info { flex: 1; padding-left: 10px; display: flex; flex-direction: column; justify-content: space-between; }
    .food-add-btn { background: var(--primary); color: #fff; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; align-self: flex-end; }

    /* B. é›¶å”®æ¨¡å¼ (Retail Mode) */
    .retail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; width: 100%; overflow-y: auto; align-content: flex-start; }
    .retail-item { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #eee; display: flex; flex-direction: column; }
    .retail-img { height: 140px; background-color: #eee; background-size: cover; background-position: center; }
    .retail-info { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .retail-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
    .stepper-mini { display: flex; align-items: center; background: #f5f5f5; border-radius: 20px; }
    .stepper-mini button { width: 24px; height: 24px; border: none; background: transparent; font-size: 12px; }

    /* è³¼ç‰©è»Šæ¢ */
    #cart-bar { position: absolute; bottom: 20px; left: 15px; right: 15px; background: #333; border-radius: 50px; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; color: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 50; }
    #checkout-btn { background: var(--primary); color: #fff; border: none; padding: 8px 25px; border-radius: 20px; font-weight: bold; }

    /* è¦æ ¼å½ˆçª— (Spec Modal) */
    .spec-sheet { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding-bottom: 20px; max-height: 80vh; overflow-y: auto; position: absolute; bottom: 0; animation: slideUp 0.3s; }
    .spec-header { padding: 15px; display: flex; gap: 15px; }
    .spec-img { width: 90px; height: 90px; border-radius: 8px; background-color: #eee; background-size: cover; background-position: center; }
    .spec-options { padding: 0 15px 15px 15px; }
    .option-group { margin-bottom: 12px; }
    .option-title { font-size: 13px; color: #666; margin-bottom: 8px; }
    .option-chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { padding: 6px 15px; background: #F5F5F5; border-radius: 6px; font-size: 12px; color: #333; border: 1px solid transparent; cursor: pointer; }
    .chip.selected { background: #e8f5e9; color: var(--primary); border-color: var(--primary); }
    .spec-footer { border-top: 1px solid #eee; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .spec-add-btn { background: var(--primary); color: #fff; padding: 10px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; }

    /* ç·¨è¼¯è³‡æ–™å½ˆçª— */
    .modal-content { background: #fff; width: 80%; border-radius: 16px; padding: 20px; }
    .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
    
    /* æœå‹™é¸æ“‡å½ˆçª— */
    .service-sheet { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; }
    .service-option { padding: 15px; border: 2px solid #eee; border-radius: 12px; font-weight: bold; text-align: center; cursor: pointer; margin-bottom: 10px; }
    .service-option.selected { border-color: var(--primary); color: var(--primary); background: rgba(6, 199, 85, 0.05); }

  </style>
</head>
<body>

  <div id="loading">Uni-S è¼‰å…¥ä¸­...</div>

  <div id="msg-modal-overlay" class="modal-overlay hidden">
    <div class="msg-box">
      <div id="msg-icon" class="msg-icon"><i class="fas fa-check-circle"></i></div>
      <div id="msg-text" class="msg-text">...</div>
      <div class="msg-btns">
        <button id="msg-btn-no" class="msg-btn msg-btn-cancel hidden" onclick="closeMsgModal(false)">å–æ¶ˆ</button>
        <button id="msg-btn-yes" class="msg-btn msg-btn-ok" onclick="closeMsgModal(true)">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <div id="lobby-view" class="hidden">
    <div class="lobby-header-bg">
      <div style="font-weight:bold; letter-spacing:1px; font-size:12px; opacity:0.8;">UNI-S PLATFORM</div>
      <div style="font-size:20px; font-weight:bold; margin-top:5px; color:#fff;">æ¢ç´¢ç¾å¥½ç”Ÿæ´»</div>
    </div>
    <div class="float-member-card" onclick="switchTab('member')">
      <img id="home-avatar" src="" class="mini-avatar">
      <div class="user-greeting"><h3><span id="home-name">...</span></h3><p>é»æ“ŠæŸ¥çœ‹æœƒå“¡æ¬Šç›Š â€º</p></div>
      <div class="quick-points"><span class="num" id="home-points">0</span><span class="label">ç©åˆ†</span></div>
    </div>
    
    <div class="search-bar" style="margin: 0 15px 15px 15px; background: #fff; padding: 10px; border-radius: 20px; display: flex; align-items: center;">
      <i class="fas fa-search" style="color:#999; margin-right:10px;"></i>
      <input type="text" id="search-input" placeholder="æœå°‹åº—å®¶..." oninput="filterShops()" style="border:none;flex:1;outline:none;">
    </div>
    
    <div class="filter-scroll" style="display:flex;gap:10px;overflow-x:auto;padding:0 15px 15px 15px;">
      <div class="filter-tag active" onclick="filterCategory('all', this)">å…¨éƒ¨</div>
      <div class="filter-tag" onclick="filterCategory('food', this)">ç¾é£Ÿé£²å“</div>
      <div class="filter-tag" onclick="filterCategory('retail', this)">ç”Ÿæ´»é›¶å”®</div>
    </div>

    <div id="shop-list" style="padding: 0 15px;"></div>
  </div>

  <div id="coupons-view" class="hidden">
    <div style="padding:20px; text-align:center; color:#999;">å„ªæƒ åˆ¸åŠŸèƒ½é–‹ç™¼ä¸­...</div>
  </div>

  <div id="member-view" class="hidden">
    <div class="member-header-bg"></div>
    <div class="premium-card">
      <div class="card-user-row">
        <img id="m-avatar" src="" class="card-avatar">
        <div style="flex:1;"><div id="m-name" style="font-size:18px;font-weight:bold;color:var(--gold);">...</div></div>
        <i class="fas fa-edit" onclick="openEditModal()" style="font-size:20px;color:var(--gold);opacity:0.8;cursor:pointer;"></i>
      </div>
      <div class="card-stats-row">
        <div class="stat-box"><span class="stat-num" id="m-points">0</span><span class="stat-label">ç©åˆ†</span></div>
        <div class="stat-box"><span class="stat-num">0</span><span class="stat-label">å„ªæƒ åˆ¸</span></div>
      </div>
    </div>
    <div class="history-section" style="padding:0 15px;">
      <div style="font-weight:bold; margin-bottom:10px;">æœ€è¿‘è¨‚å–®</div>
      <div id="history-loading" style="text-align:center; color:#999; font-size:12px;">è¼‰å…¥ä¸­...</div>
      <div id="history-list"></div>
    </div>
  </div>

  <div id="order-detail-view" class="hidden">
    <div class="od-navbar"><div style="font-size:20px;width:30px;cursor:pointer;" onclick="closeOrderDetail()"><i class="fas fa-chevron-left"></i></div><div style="flex:1;text-align:center;margin-right:30px;">è¨‚å–®è©³æƒ…</div></div>
    <div class="od-content">
      <div class="od-card">
        <div class="od-shop-header" style="display:flex;justify-content:space-between;margin-bottom:10px;border-bottom:1px solid #f5f5f5;padding-bottom:10px;">
          <div style="font-size:18px;font-weight:bold;" id="od-shop-name">...</div>
        </div>
        <div style="display:flex;gap:10px;margin-bottom:10px;">
          <div class="action-btn" onclick="showMsg('åŠŸèƒ½é–‹ç™¼ä¸­')"><i class="fas fa-phone"></i> æ’¥æ‰“é›»è©±</div>
          <div class="action-btn" onclick="showMsg('åŠŸèƒ½é–‹ç™¼ä¸­')"><i class="fas fa-map-marker-alt"></i> æŸ¥çœ‹ä½ç½®</div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:13px;color:#666;"><span>è¨‚å–®ç‹€æ…‹</span><span id="od-status" style="font-weight:bold;">...</span></div>
      </div>
      <div class="od-card">
        <div style="font-weight:bold;margin-bottom:10px;">è¨‚å–®å…§å®¹</div>
        <div id="od-items-list"></div>
        <div style="text-align:right;margin-top:10px;font-weight:bold;color:#D32F2F;">åˆè¨ˆ <span id="od-total-price">...</span></div>
      </div>
      <div class="od-card">
        <div style="font-weight:bold;margin-bottom:10px;">è¨‚å–®è³‡è¨Š</div>
        <div style="font-size:13px;color:#666;margin-bottom:5px;">ç·¨è™Ÿï¼š<span id="od-id"></span></div>
        <div style="font-size:13px;color:#666;margin-bottom:5px;">æ™‚é–“ï¼š<span id="od-time"></span></div>
        <div style="font-size:13px;color:#666;">é›»è©±ï¼š<span id="od-phone"></span></div>
      </div>
      <div id="od-cancel-container" style="margin-top:20px;"></div>
    </div>
  </div>

  <div id="shop-view" class="hidden">
    <div class="shop-header">
      <div class="shop-back-btn" onclick="goLobby()"><i class="fas fa-chevron-left"></i></div>
      <div class="shop-title-box">
        <div class="shop-title" id="shop-name">...</div>
        <div class="shop-subtitle">ç‡Ÿæ¥­ä¸­ â€¢ æ­¡è¿å…‰è‡¨</div>
      </div>
    </div>

    <div class="shop-body">
      
      <div id="mode-food" style="display:none; width:100%; height:100%; display:flex;">
        <div class="menu-sidebar" id="food-sidebar"></div>
        <div class="menu-content" id="food-content"></div>
      </div>

      <div id="mode-retail" class="retail-grid" style="display:none;"></div>

    </div>

    <div id="cart-bar" style="display:none;">
      <div style="display:flex;align-items:center;">
        <i class="fas fa-shopping-bag" style="font-size:24px;margin-right:10px;"></i>
        <div style="font-size:18px;font-weight:bold;">$<span id="cart-total">0</span></div>
      </div>
      <button id="checkout-btn" onclick="preCheckout()">å»çµç®— (<span id="cart-count">0</span>)</button>
    </div>
  </div>

  <div id="spec-modal" class="modal-overlay hidden">
    <div class="spec-sheet">
      <div style="position:relative;">
        <div class="btn-close" onclick="closeSpecModal()" style="position:absolute;top:10px;right:10px;font-size:24px;color:#999;cursor:pointer;">Ã—</div>
        <div class="spec-header">
          <div class="spec-img" id="sp-img"></div>
          <div>
            <div style="font-size:18px;font-weight:bold;margin-bottom:5px;" id="sp-name">...</div>
            <div style="font-size:12px;color:#888;" id="sp-desc">...</div>
            <div style="font-size:20px;font-weight:bold;color:#D32F2F;margin-top:5px;">$<span id="sp-price">0</span></div>
          </div>
        </div>
        <div id="sp-options" class="spec-options"></div>
        <div class="spec-footer">
          <div class="stepper" style="display:flex;align-items:center;background:#f5f5f5;border-radius:20px;padding:5px 10px;">
            <div onclick="updateSpQty(-1)" style="font-size:20px;cursor:pointer;padding:0 10px;">-</div>
            <span id="sp-qty" style="font-weight:bold;">1</span>
            <div onclick="updateSpQty(1)" style="font-size:20px;cursor:pointer;padding:0 10px;">+</div>
          </div>
          <div class="spec-add-btn" onclick="addSpecToCart()">åŠ å…¥è³¼ç‰©è»Š</div>
        </div>
      </div>
    </div>
  </div>

  <div id="service-modal" class="modal-overlay hidden">
    <div class="service-sheet">
      <div style="text-align:center;font-weight:bold;font-size:18px;margin-bottom:20px;">é¸æ“‡æœå‹™æ–¹å¼</div>
      <div id="service-list"></div>
      <div class="spec-add-btn" style="text-align:center;margin-top:15px;" onclick="confirmService()">ç¢ºèªä¸‹å–®</div>
      <div style="text-align:center;margin-top:15px;color:#999;cursor:pointer;" onclick="document.getElementById('service-modal').classList.add('hidden')">å–æ¶ˆ</div>
    </div>
  </div>

  <div id="edit-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div style="text-align:center;font-weight:bold;margin-bottom:15px;">ç·¨è¼¯è³‡æ–™</div>
      <div style="margin-bottom:10px;"><label style="font-size:12px;color:#666;">å§“å</label><input type="text" id="edit-name" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;"></div>
      <div style="margin-bottom:10px;"><label style="font-size:12px;color:#666;">é›»è©±</label><input type="tel" id="edit-phone" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;"></div>
      <div style="margin-bottom:15px;"><label style="font-size:12px;color:#666;">ç”Ÿæ—¥</label><input type="date" id="edit-birthday" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;"></div>
      <div style="display:flex;gap:10px;">
        <div style="flex:1;text-align:center;padding:10px;background:#eee;border-radius:20px;" onclick="document.getElementById('edit-modal').classList.add('hidden')">å–æ¶ˆ</div>
        <div style="flex:1;text-align:center;padding:10px;background:var(--primary);color:#fff;border-radius:20px;font-weight:bold;" onclick="saveProfile()">å„²å­˜</div>
      </div>
    </div>
  </div>

  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('lobby')"><div class="tab-icon"><i class="fas fa-home"></i></div><div>é¦–é </div></div>
    <div class="tab-item" onclick="switchTab('coupons')"><div class="tab-icon"><i class="fas fa-ticket-alt"></i></div><div>å„ªæƒ </div></div>
    <div class="tab-item" onclick="switchTab('member')"><div class="tab-icon"><i class="fas fa-user"></i></div><div>æˆ‘çš„</div></div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ ID å¡«é€™è£¡ âš ï¸âš ï¸âš ï¸
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";

    // ç‹€æ…‹è®Šæ•¸
    let allShops = {}; let currentShop = null; let cart = []; 
    let userProfile = null; let orderCache = []; let selectedService = "";
    let currentItem = null; let currentOptions = {}; let currentQty = 1;

    // è‡ªè¨‚å½ˆçª—
    let modalCb = null;
    function showMsg(txt, cb) { 
      document.getElementById('msg-text').innerText = txt; 
      document.getElementById('msg-btn-no').classList.add('hidden'); 
      document.getElementById('msg-modal-overlay').classList.remove('hidden'); 
      modalCb = cb; 
    }
    function showConfirm(txt, cb) {
      document.getElementById('msg-text').innerText = txt;
      document.getElementById('msg-btn-no').classList.remove('hidden');
      document.getElementById('msg-modal-overlay').classList.remove('hidden');
      modalCb = cb;
    }
    function closeMsgModal(isYes) {
      document.getElementById('msg-modal-overlay').classList.add('hidden');
      if(isYes && modalCb) modalCb();
      modalCb = null;
    }

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        updateUI();

        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        const params = new URLSearchParams(window.location.search);
        if (params.get('id') && allShops[params.get('id')]) openShop(params.get('id'));
        else if (params.get('tab') === 'member') { renderLobby(allShops); switchTab('member'); }
        else { renderLobby(allShops); switchTab('lobby'); }
        
        fetchMemberData();
      } catch (err) { showMsg(err.message); }
    }

    function updateUI() {
      ['home-name','m-name'].forEach(id => document.getElementById(id).innerText = userProfile.displayName);
      ['home-avatar','m-avatar'].forEach(id => document.getElementById(id).src = userProfile.pictureUrl);
    }

    function switchTab(tab) {
      ['lobby-view', 'coupons-view', 'member-view', 'shop-view', 'order-detail-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('tab-bar').classList.remove('hidden');
      document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
      
      if (tab === 'lobby') {
        document.getElementById('lobby-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[0].classList.add('active');
        fetchMemberData();
      } else if (tab === 'coupons') {
        document.getElementById('coupons-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[1].classList.add('active');
      } else if (tab === 'member') {
        document.getElementById('member-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[2].classList.add('active');
        fetchMemberData();
        loadOrderHistory();
      }
    }

    // ========== API ç›¸é—œ ==========
    async function fetchMemberData() {
      try {
        const res = await fetch(`${API_URL}?action=getMember&userId=${userProfile.userId}`);
        const data = await res.json();
        const pts = data.points || 0;
        document.getElementById('m-points').innerText = pts;
        document.getElementById('home-points').innerText = pts;
        if(data.name && data.name!=="æœƒå“¡") ['home-name','m-name'].forEach(id=>document.getElementById(id).innerText=data.name);
        window.currentMemberData = data;
      } catch(e) {}
    }

    async function loadOrderHistory() {
      document.getElementById('history-loading').style.display='block';
      document.getElementById('history-list').innerHTML='';
      try {
        const res = await fetch(API_URL, {method:'POST', body:JSON.stringify({action:"getHistory", userId:userProfile.userId})});
        orderCache = await res.json();
        document.getElementById('history-loading').style.display='none';
        
        let html = '';
        orderCache.forEach((o, i) => {
          let price = o.content.split('ç¸½é‡‘é¡ï¼š')[1]?.split('\n')[0].replace('å…ƒ','').trim() || '';
          let cls = o.status.includes('å·²æ¥å–®')?'status-ok':(o.status.includes('å©‰æ‹’')||o.status.includes('å–æ¶ˆ')?'status-no':'status-wait');
          html += `<div class="history-simple-item" onclick="openOrderDetail(${i})"><div class="hs-info"><div class="hs-shop">${o.shopName}</div><div class="hs-date">${o.time}</div><div class="hs-status ${cls}">${o.status}</div></div><div class="hs-price">${price}</div><div class="hs-arrow">â€º</div></div>`;
        });
        document.getElementById('history-list').innerHTML = html || '<div style="text-align:center;color:#999;font-size:12px;">ç„¡ç´€éŒ„</div>';
      } catch(e) {}
    }

    // ========== é›™æ¨¡å¼åº—é‹ªç³»çµ± ==========
    function openShop(id) {
      currentShop = allShops[id]; currentShop.id = id; cart = []; updateCartBar();
      const url = new URL(window.location); url.searchParams.set('id', id); window.history.pushState({}, '', url);
      
      document.getElementById('tab-bar').classList.add('hidden');
      ['lobby-view','coupons-view','member-view'].forEach(id=>document.getElementById(id).classList.add('hidden'));
      document.getElementById('shop-view').classList.remove('hidden');
      
      document.getElementById('shop-name').innerText = currentShop.name;
      
      // åˆ¤æ–·æ¨¡å¼
      if (currentShop.type === 'retail') {
        document.getElementById('mode-food').style.display = 'none';
        document.getElementById('mode-retail').style.display = 'grid';
        renderRetailMenu();
      } else {
        document.getElementById('mode-retail').style.display = 'none';
        document.getElementById('mode-food').style.display = 'flex';
        renderFoodMenu();
      }
    }

    // 1. é›¶å”®æ¸²æŸ“
    function renderRetailMenu() {
      let html = '';
      currentShop.menu.forEach((item, idx) => {
        let img = item.img || currentShop.bannerUrl;
        // ç‚ºäº†ç°¡å–®ï¼Œé›¶å”®æ¨¡å¼ç›´æ¥æŒ‰åŠ è™ŸåŠ å…¥è³¼ç‰©è»Š(ç„¡è¦æ ¼)
        let itemJson = JSON.stringify(item).replace(/"/g, '&quot;');
        html += `
          <div class="retail-item">
            <div class="retail-img" style="background-image:url(${img})"></div>
            <div class="retail-info">
              <div style="font-weight:bold;font-size:14px;">${item.name}</div>
              <div class="retail-actions">
                <span style="color:#e64a19;font-weight:bold;">$${item.price}</span>
                <div class="stepper-mini">
                  <button onclick="updateCartRetail('${item.name}', ${item.price}, -1)">-</button>
                  <span id="r-qty-${idx}" style="font-size:13px;font-weight:bold;margin:0 5px;">0</span>
                  <button onclick="updateCartRetail('${item.name}', ${item.price}, 1)">+</button>
                </div>
              </div>
            </div>
          </div>`;
      });
      document.getElementById('mode-retail').innerHTML = html;
    }

    function updateCartRetail(name, price, change) {
      // é›¶å”®æ¨¡å¼ç›´æ¥æ“ä½œ cart array (åˆä½µæ•¸é‡)
      let exist = cart.find(x => x.name === name);
      if(exist) {
        exist.qty += change;
        if(exist.qty <= 0) cart = cart.filter(x => x.name !== name);
      } else if (change > 0) {
        cart.push({name: name, price: price, qty: 1, total: price, opts: ""});
      }
      // æ›´æ–°ä»‹é¢æ•¸é‡
      currentShop.menu.forEach((item, idx) => {
        let el = document.getElementById(`r-qty-${idx}`);
        let inCart = cart.find(x => x.name === item.name);
        if(el) el.innerText = inCart ? inCart.qty : 0;
      });
      updateCartBar();
    }

    // 2. èŒ¶é£²/é¤é£²æ¸²æŸ“ (åˆ†é¡ + å½ˆçª—)
    function renderFoodMenu() {
      const catList = document.getElementById('food-sidebar');
      const prodList = document.getElementById('food-content');
      catList.innerHTML = ''; prodList.innerHTML = '';
      
      let menuData = Array.isArray(currentShop.menu) && currentShop.menu[0].category ? currentShop.menu : [{category:"å…¨éƒ¨", items:currentShop.menu}];
      
      menuData.forEach((cat, idx) => {
        catList.innerHTML += `<div class="category-item ${idx===0?'active':''}" onclick="document.getElementById('cat-${idx}').scrollIntoView({behavior:'smooth'})">${cat.category}</div>`;
        let itemsHtml = '';
        cat.items.forEach(item => {
          let itemJson = JSON.stringify(item).replace(/"/g, '&quot;');
          itemsHtml += `
            <div class="food-item" onclick="openSpecModal(${itemJson})">
              <div class="food-img" style="background-image:url(${item.img||currentShop.bannerUrl})"></div>
              <div class="food-info">
                <div><div style="font-weight:bold;">${item.name}</div><div style="font-size:11px;color:#999;">${item.desc||''}</div></div>
                <div style="display:flex;justify-content:space-between;">
                  <div style="font-weight:bold;">$${item.price}</div>
                  <div class="food-add-btn">+</div>
                </div>
              </div>
            </div>`;
        });
        prodList.innerHTML += `<div id="cat-${idx}"><div class="category-title">${cat.category}</div>${itemsHtml}</div>`;
      });
    }

    // è¦æ ¼å½ˆçª—é‚è¼¯
    function openSpecModal(item) {
      currentItem = item; currentQty = 1; currentOptions = {};
      document.getElementById('sp-name').innerText = item.name;
      document.getElementById('sp-desc').innerText = item.desc||'';
      document.getElementById('sp-price').innerText = item.price;
      document.getElementById('sp-img').style.backgroundImage = `url(${item.img||currentShop.bannerUrl})`;
      document.getElementById('sp-qty').innerText = 1;
      
      let html = '';
      for (let [k, vals] of Object.entries(item.options||{})) {
        currentOptions[k] = vals[0];
        let chips = vals.map((v,i) => `<div class="chip ${i===0?'selected':''}" onclick="selOpt(this,'${k}','${v}')">${v}</div>`).join('');
        html += `<div class="option-group"><div class="option-title">${k}</div><div class="option-chips">${chips}</div></div>`;
      }
      document.getElementById('sp-options').innerHTML = html || '<div style="color:#999;font-size:12px;">ç„¡è¦æ ¼é¸é …</div>';
      document.getElementById('spec-modal').classList.remove('hidden');
    }
    
    function selOpt(el, k, v) {
      el.parentNode.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
      el.classList.add('selected'); currentOptions[k] = v;
    }
    
    function updateSpQty(n) { 
      if(currentQty+n > 0) { currentQty+=n; document.getElementById('sp-qty').innerText=currentQty; document.getElementById('sp-price').innerText=currentItem.price*currentQty; } 
    }
    
    function addSpecToCart() {
      let opts = Object.values(currentOptions).join('/');
      if(opts) opts = `(${opts})`;
      cart.push({name: currentItem.name + " " + opts, price: currentItem.price, qty: currentQty, total: currentItem.price*currentQty});
      document.getElementById('spec-modal').classList.add('hidden');
      updateCartBar();
    }

    function updateCartBar() {
      let totalQty = cart.reduce((a,b)=>a+b.qty,0);
      let totalPrice = cart.reduce((a,b)=>a+(b.price*b.qty),0); // ä¿®æ­£ç¸½åƒ¹è¨ˆç®—
      if(totalQty > 0) {
        document.getElementById('cart-bar').style.display = 'flex';
        document.getElementById('cart-count').innerText = totalQty;
        document.getElementById('cart-total').innerText = totalPrice;
      } else {
        document.getElementById('cart-bar').style.display = 'none';
      }
    }

    // ========== çµå¸³æµç¨‹ ==========
    function preCheckout() {
      if(cart.length===0) return;
      const svcs = currentShop.services || ["è‡ªå–"];
      let html = '';
      svcs.forEach((s,i) => {
        html += `<div class="service-option ${i===0?'selected':''}" onclick="selSvc(this,'${s}')">${s}</div>`;
        if(i===0) selectedService = s;
      });
      document.getElementById('service-list').innerHTML = html;
      document.getElementById('service-modal').classList.remove('hidden');
    }
    
    function selSvc(el, s) {
      document.querySelectorAll('.service-option').forEach(e=>e.classList.remove('selected'));
      el.classList.add('selected'); selectedService = s;
    }

    async function confirmService() {
      document.getElementById('service-modal').classList.add('hidden');
      let detail = "", total = 0;
      cart.forEach(x => {
        let sub = x.price * x.qty; // ä¿®æ­£å°è¨ˆ
        detail += `${x.name} x ${x.qty} ($${sub})\n`;
        total += sub;
      });
      detail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ\næœå‹™æ–¹å¼ï¼š${selectedService}`;
      
      let phone = localStorage.getItem("uni_user_phone");
      if(!phone) { phone = prompt("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼š"); if(!phone) return; localStorage.setItem("uni_user_phone", phone); }
      detail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${phone}`;

      try {
        showMsg("è™•ç†ä¸­...", null);
        await liff.sendMessages([{type:"text", text:`ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${detail}`}]);
        await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({shopId:currentShop.id, userName:userProfile.displayName, userId:userProfile.userId, order:detail})});
        showMsg("âœ… è¨‚å–®å·²é€å‡ºï¼", () => { goLobby(); });
      } catch(e) { showMsg("å¤±æ•—:"+e.message); }
    }

    // ========== è¨‚å–®è©³æƒ… ==========
    function openOrderDetail(idx) {
      let o = orderCache[idx];
      document.getElementById('tab-bar').classList.add('hidden');
      ['lobby-view','coupons-view','member-view'].forEach(id=>document.getElementById(id).classList.add('hidden'));
      document.getElementById('order-detail-view').classList.remove('hidden');
      
      document.getElementById('od-shop-name').innerText = o.shopName;
      document.getElementById('od-status').innerText = o.status;
      document.getElementById('od-id').innerText = o.orderId;
      document.getElementById('od-time').innerText = o.time;
      
      let html = '', total = '', phone = '--';
      o.content.split('\n').forEach(line => {
        if(line.includes('ç¸½é‡‘é¡')) total = line.split('ï¼š')[1];
        else if(line.includes('é›»è©±')) phone = line.split('ï¼š')[1];
        else if(!line.includes('---') && line.trim()) html += `<div class="od-item"><div class="od-item-name">${line}</div></div>`;
      });
      document.getElementById('od-items-list').innerHTML = html;
      document.getElementById('od-total-price').innerText = total;
      document.getElementById('od-phone').innerText = phone;
      
      document.getElementById('od-cancel-container').innerHTML = o.status.includes('å¾…ç¢ºèª') ? `<div class="spec-add-btn" style="background:#fff;color:#D32F2F;border:1px solid #D32F2F;text-align:center;" onclick="cancelOrder('${o.orderId}')">å–æ¶ˆè¨‚å–®</div>` : '';
    }
    
    function closeOrderDetail() {
      document.getElementById('order-detail-view').classList.add('hidden');
      document.getElementById('member-view').classList.remove('hidden');
      document.getElementById('tab-bar').classList.remove('hidden');
    }
    
    async function cancelOrder(oid) {
      showConfirm("ç¢ºå®šå–æ¶ˆï¼Ÿ", async () => {
        await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:"cancelOrder", orderId:oid, userId:userProfile.userId})});
        setTimeout(() => { showMsg("å·²é€å‡ºå–æ¶ˆ", () => { closeOrderDetail(); loadOrderHistory(); }); }, 1500);
      });
    }

    // ========== å¤§å»³èˆ‡å…¶ä»– ==========
    function renderLobby(shops) {
      let html = '';
      Object.keys(shops).forEach(id => {
        let s = shops[id];
        html += `<div class="shop-card" onclick="openShop('${id}')"><div class="shop-thumb" style="background-image:url(${s.bannerUrl})"></div><div class="shop-info"><div class="shop-name">${s.name}</div><div class="shop-action"><button class="btn-visit">å»é€›é€›</button></div></div></div>`;
      });
      document.getElementById('shop-list').innerHTML = html;
    }
    function filterShops() {
      let key = document.getElementById('search-input').value.toLowerCase();
      let res = {}; Object.keys(allShops).forEach(k => { if(allShops[k].name.toLowerCase().includes(key)) res[k] = allShops[k]; });
      renderLobby(res);
    }
    function filterCategory(type, el) {
      document.querySelectorAll('.filter-tag').forEach(e=>e.classList.remove('active')); el.classList.add('active');
      if(type==='all') renderLobby(allShops);
      else {
        let res = {}; Object.keys(allShops).forEach(k => { if(allShops[k].type === type) res[k] = allShops[k]; });
        renderLobby(res);
      }
    }
    function goLobby() { 
      const url = new URL(window.location); url.searchParams.delete('id'); window.history.pushState({}, '', url);
      document.getElementById('shop-view').classList.add('hidden');
      document.getElementById('tab-bar').classList.remove('hidden');
      document.getElementById('lobby-view').classList.remove('hidden');
    }
    function openEditModal() { document.getElementById('edit-modal').classList.remove('hidden'); }
    function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
    async function saveProfile() {
      await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:"updateProfile", userId:userProfile.userId, name:document.getElementById('edit-name').value, phone:document.getElementById('edit-phone').value, birthday:document.getElementById('edit-birthday').value})});
      showMsg("å„²å­˜æˆåŠŸ", () => { closeEditModal(); fetchMemberData(); });
    }
    function closeSpecModal() { document.getElementById('spec-modal').classList.add('hidden'); }

    main();
  </script>
</body>
</html>
