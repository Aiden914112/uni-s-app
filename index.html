<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S Tea é»é¤</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- å¼•å…¥ Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* ==================== 0. å…¨å±€èˆ‡é‡ç½® (Aesthetics Upgrade) ==================== */
    :root { 
      --primary: #9F8C6D; /* ä¿æŒé™¶åœŸé‡‘/è¡Œå‹•è‰² */
      --gold: #CCB28A;    
      --bg: #F9F9F9;      /* æ›´äº®çš„èƒŒæ™¯ç™½ï¼Œæå‡å°æ¯”åº¦ */ 
      --text: #2C2620;    /* æ›´æ·±çš„æ–‡å­—å¢¨é»‘ */ 
      --tea-sidebar: #F0EDE5; 
      
      --danger: #B85C5C;  
      --success: #7A8B69; 
    }

    body { 
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      padding: 0; margin: 0; 
      background-color: var(--bg); 
      color: var(--text); 
      touch-action: manipulation; 
      -webkit-user-select: none; user-select: none; 
      height: 100vh; overflow: hidden; display: flex; flex-direction: column; 
    }
    
    h1, h2, h3, .shop-name, .coupon-val, .spec-header .title {
      font-family: 'Noto Serif TC', serif; 
    }

    .hidden { display: none !important; }
    #loading { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; justify-content: center; align-items: center; color: var(--primary); flex-direction: column; }

    /* é€šç”¨å½ˆçª—é®ç½© */
    .modal-overlay { position: fixed; inset: 0; background: rgba(44, 38, 32, 0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    /* åº•éƒ¨æ»‘å‡ºé¢æ¿ */
    .modal-sheet { background: #fff; width: 100%; border-radius: 20px 20px 0 0; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; padding-bottom: 20px; position: absolute; bottom: 0; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* ==================== 1. åº•éƒ¨å°èˆª (Tab Bar) ==================== */
    #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; height: 65px; display: flex; border-top: 1px solid #E0D8CC; z-index: 950; padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.02); }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 11px; cursor: pointer; transition: all 0.3s; }
    .tab-item.active { color: var(--primary); font-weight: bold; }
    .tab-item.active .tab-icon { transform: translateY(-2px); }
    .tab-icon { font-size: 20px; margin-bottom: 4px; }

    /* ==================== 2. ä¸»è¦–åœ–å®¹å™¨ ==================== */
    .scroll-view { flex: 1; overflow-y: auto; padding-bottom: 80px; -webkit-overflow-scrolling: touch; }

    /* å„ªæƒ åˆ¸èˆ‡æœƒå“¡ä¸­å¿ƒæ¨£å¼ */
    .coupon-grid { display: grid; grid-template-columns: 1fr; gap: 16px; padding: 0 20px; }
    .coupon-item { 
      background: #fff; border-radius: 14px; display: flex; overflow: hidden; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; border: 1px solid #EBE6DE;
    }
    .coupon-left { 
      background: linear-gradient(135deg, var(--primary), #8A7A5B); 
      width: 95px; color: #fff; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; text-align: center; padding: 10px; 
      position: relative;
    }
    .coupon-left::after { 
      content: ""; position: absolute; right: -6px; top: 0; bottom: 0; width: 12px; 
      background-image: radial-gradient(circle, #fff 4px, transparent 5px); 
      background-size: 10px 14px; background-repeat: repeat-y; 
    }
    .coupon-val { font-size: 26px; font-weight: bold; font-family: 'Noto Serif TC'; }
    .coupon-right { flex: 1; padding: 14px 16px; display: flex; flex-direction: column; justify-content: center; }
    .coupon-name { font-weight: bold; font-size: 15px; color: #2C2620; margin-bottom: 6px; }
    .coupon-cost { font-size: 12px; color: #888; }
    .btn-redeem { 
      position: absolute; right: 15px; top: 50%; transform: translateY(-50%); 
      background: transparent; border: 1px solid var(--primary); color: var(--primary); 
      padding: 5px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: bold;
    }
    .my-coupon-item { 
      background: #fff; border: 1px dashed var(--gold); border-radius: 10px; padding: 14px; 
      margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }

    .member-header-bg { display: none; }
    
    .premium-card { 
      margin: 20px; 
      background: linear-gradient(135deg, #3E362E, #26211C); 
      border-radius: 18px; padding: 24px; color: #E0D8CC; 
      box-shadow: 0 15px 40px rgba(44, 38, 32, 0.25); position: relative; overflow: hidden; 
      border: 1px solid rgba(255,255,255,0.1);
    }
    .premium-card::before { 
      content: ""; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; 
      background: radial-gradient(circle, rgba(204, 186, 138, 0.1) 0%, transparent 70%); 
      pointer-events: none;
    }
    .card-user-row { display: flex; align-items: center; margin-bottom: 28px; }
    
    .card-avatar { 
      width: 56px; height: 56px; 
      border-radius: 50%; border: 2px solid var(--gold); 
      margin-right: 15px; 
      object-fit: cover; flex-shrink: 0; 
    }

    .card-stats-row { display: flex; justify-content: space-between; text-align: center; }
    .stat-num { font-size: 22px; font-weight: bold; display: block; margin-bottom: 6px; font-family: 'Noto Serif TC'; color: var(--gold); }
    .stat-label { font-size: 11px; opacity: 0.7; letter-spacing: 1px; }
    
    .service-section { 
      background: #fff; margin: 0 20px 20px 20px; border-radius: 16px; padding: 24px 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; 
      border: 1px solid #F0EDE5;
    }
    .service-item { text-align: center; cursor: pointer; transition: transform 0.2s; }
    .service-item:active { transform: scale(0.95); }
    .service-icon { font-size: 24px; color: #6B6359; margin-bottom: 8px; }
    .service-label { font-size: 12px; color: #666; letter-spacing: 0.5px; }

    /* History Styles */
    .history-card {
      background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid #F0EDE5; position: relative; transition: transform 0.2s;
    }
    .history-card:active { transform: scale(0.98); }
    .hc-header { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed #E0D8CC; padding-bottom: 8px; }
    .hc-shop { font-weight: bold; font-size: 16px; color: #2C2620; font-family: 'Noto Serif TC'; }
    .hc-date { font-size: 12px; color: #999; }
    .hc-body { display: flex; justify-content: space-between; align-items: center; }
    .hc-summary { font-size: 13px; color: #666; line-height: 1.5; flex: 1; padding-right: 10px; }
    .hc-price { font-size: 18px; font-weight: bold; color: var(--primary); font-family: 'Noto Serif TC'; }
    .hc-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-top: 5px; }
    .status-wait { background: #FFF8E1; color: #D4A017; }
    .status-ok { background: #EEF5E5; color: var(--success); }
    .status-no { background: #FDEEEE; color: var(--danger); }

    /* ==================== 3. å–®ä¸€å“ç‰Œåº—é‹ªé é¢ (Main View) ==================== */
    #shop-view { background: #fff; height: 100%; display: flex; flex-direction: column; position: relative; z-index: 50; }
    .shop-banner-area { width: 100%; height: 220px; background-size: cover; background-position: center; position: relative; flex-shrink: 0; }
    .shop-banner-overlay { 
      position: absolute; inset: 0; 
      background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.7) 100%); 
      display: flex; flex-direction: column; justify-content: flex-end; padding: 25px 20px; 
    }
    .shop-title-large { 
      color: #fff; font-size: 28px; font-weight: bold; 
      text-shadow: 0 2px 10px rgba(0,0,0,0.5); letter-spacing: 2px; margin: 0;
      font-family: 'Noto Serif TC'; 
    }
    .shop-subtitle {
      color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 5px; letter-spacing: 1px;
    }

    .shop-controls { background: #fff; padding: 15px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); z-index: 20; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #F0EDE5; }
    .controls-top-row { display: flex; justify-content: space-between; align-items: center; }
    .shop-detail-info { font-size: 12px; color: #888; display: flex; flex-direction: column; gap: 6px; }
    .info-row { display: flex; align-items: center; gap: 8px; }
    .btn-nav { background: #F7F4EF; color: var(--primary); border: 1px solid var(--primary); padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    
    .delivery-toggle { display: flex; background: #F0EDE5; border-radius: 20px; padding: 3px; }
    .toggle-btn { padding: 6px 18px; border-radius: 18px; border: none; font-size: 13px; background: transparent; color: #888; font-weight: 500; }
    .toggle-btn.active { background: #fff; color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    /* [Fixed] Cart Bar Visibility & Scroll */
    .shop-body { 
      flex: 1; display: flex; overflow: hidden; position: relative; background: #fff; 
      padding-bottom: 0; /* Padding moved to content */
    }
    
    .menu-sidebar { width: 90px; background: var(--tea-sidebar); overflow-y: auto; scrollbar-width: none; padding-bottom: 80px; }
    .category-item { padding: 22px 5px; font-size: 13px; color: #888; text-align: center; cursor: pointer; position: relative; font-weight: 500; letter-spacing: 1px; }
    .category-item.active { background: #fff; color: var(--primary); font-weight: bold; }
    .category-item.active::before { content: ''; position: absolute; left: 0; top: 20px; bottom: 20px; width: 4px; background: var(--primary); border-radius: 0 4px 4px 0; }
    
    /* [Fixed] èœå–®å…§å®¹åº•éƒ¨å¢åŠ  180px paddingï¼Œç¢ºä¿ä¸è¢«è³¼ç‰©è»Šèˆ‡ Tab Bar é®æ“‹ */
    .menu-content { 
        flex: 1; overflow-y: auto; 
        padding: 0 15px 180px 15px; 
        scroll-behavior: smooth; 
    }
    
    .category-title { font-size: 15px; font-weight: bold; color: #2C2620; margin: 25px 0 15px 0; padding-left: 8px; border-left: 3px solid var(--gold); line-height: 1.2; letter-spacing: 1px; }
    .food-item { display: flex; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px dashed #E0D8CC; }
    .food-item:last-child { border-bottom: none; }
    .food-img { width: 96px; height: 96px; border-radius: 10px; background-color: #F0EDE5; background-size: cover; background-position: center; flex-shrink: 0; }
    .food-info { flex: 1; padding-left: 14px; display: flex; flex-direction: column; justify-content: space-between; }
    .food-name { font-size: 16px; font-weight: bold; color: #2C2620; font-family: 'Noto Serif TC'; }
    .food-desc { font-size: 12px; color: #999; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-top: 4px; line-height: 1.4; }
    .food-action { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px; }
    .food-price { color: var(--primary); font-weight: bold; font-family: 'Noto Serif TC'; font-size: 16px; }
    .btn-add-mini { background: var(--primary); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; box-shadow: 0 2px 5px rgba(159, 140, 109, 0.4); }

    .retail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 20px; width: 100%; overflow-y: auto; align-content: flex-start; padding-bottom: 180px; }
    .retail-item { background: #fff; border-radius: 14px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #EBE6DE; display: flex; flex-direction: column; }
    .retail-img { height: 150px; background-color: #F0EDE5; background-size: cover; background-position: center; }
    .retail-info { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .stepper-mini { display: flex; align-items: center; background: #F7F4EF; border-radius: 20px; }
    .stepper-mini button { width: 26px; height: 26px; border: none; background: transparent; font-size: 12px; display:flex; align-items:center; justify-content:center; color: var(--primary); }

    /* [Fixed] è³¼ç‰©è»Šåˆ—ï¼šå›ºå®šå®šä½ï¼Œè²¼åˆ Tab Bar ä¸Šæ–¹ */
    .cart-bar { 
      position: fixed; 
      bottom: 65px; /* 65px is Tab Bar Height */
      left: 0; right: 0; /* Full width logic with padding if needed, or keep consistent */
      margin: 0 15px; /* Keep side margins */
      background: #2C2620; border-radius: 50px; padding: 0; 
      display: flex; justify-content: space-between; align-items: center; 
      color: var(--gold); box-shadow: 0 8px 25px rgba(0,0,0,0.25); 
      z-index: 900; height: 56px; cursor: pointer; 
      border: 1px solid rgba(255,255,255,0.1); 
    }
    
    .cart-left { flex: 1; display: flex; align-items: center; padding-left: 24px; height: 100%; }
    .cart-badge { position: absolute; top: -6px; right: -6px; background: var(--danger); color: #fff; font-size: 10px; padding: 3px 7px; border-radius: 10px; border: 2px solid #2C2620; }
    .btn-checkout { background: var(--primary); color: #fff; border: none; height: 100%; padding: 0 35px; border-radius: 0 50px 50px 0; font-weight: bold; font-size: 16px; display: flex; align-items: center; letter-spacing: 1px; }

    /* ==================== 4. å„ç¨®å½ˆçª— (Elegant Style) ==================== */
    .cart-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 20px; background: #fff; border-bottom: 1px solid #F0EDE5; border-radius: 20px 20px 0 0; }
    .cart-stepper { display: flex; align-items: center; background: #F7F4EF; border-radius: 20px; border: 1px solid #E0D8CC; }
    .cart-stepper button { width: 30px; height: 30px; border: none; background: transparent; font-size: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); }
    .cart-stepper span { font-weight: bold; margin: 0 8px; font-size: 14px; min-width: 20px; text-align: center; color: #4A4A4A; }
    .cart-list { padding: 0 20px; max-height: 50vh; overflow-y: auto; }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px solid #F7F4EF; }
    
    /* [Fixed] Spec Modal Layout Refactor */
    .spec-header { padding: 20px; display: flex; gap: 15px; border-bottom: 1px dashed #E0D8CC; }
    .spec-img { width: 80px; height: 80px; border-radius: 12px; background-color: #eee; background-size: cover; background-position: center; }
    .spec-options { padding: 20px; max-height: 40vh; overflow-y: auto; }
    
    /* å®¢è£½åŒ–é¸é …ç¾¤çµ„ */
    .option-group { 
        margin-bottom: 20px; 
        padding-bottom: 15px; 
        border-bottom: 1px dashed #E0D8CC; /* è™›ç·šåˆ†éš” */
    }
    .option-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .option-title { 
        font-weight: bold; margin-bottom: 10px; color: #2C2620; font-size: 14px; 
        font-family: 'Noto Serif TC'; letter-spacing: 1px;
    }
    
    .chip { padding: 8px 16px; background: #fff; border-radius: 8px; font-size: 13px; color: #666; border: 1px solid #E0D8CC; cursor: pointer; margin-right: 8px; margin-bottom: 8px; display: inline-block; transition: all 0.2s; }
    .chip.selected { background: #F2EFE9; color: var(--primary); border-color: var(--primary); font-weight: bold; }
    .spec-add-btn { background: var(--primary); color: #fff; padding: 12px 30px; border-radius: 30px; font-weight: bold; cursor: pointer; text-align: center; box-shadow: 0 4px 12px rgba(159, 140, 109, 0.3); }
    .stepper { display: flex; align-items: center; background: #F7F4EF; border-radius: 20px; padding: 4px 10px; border: 1px solid #E0D8CC; }
    
    #order-detail-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(44, 38, 32, 0.6); backdrop-filter: blur(5px); z-index: 950; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    .od-paper { background: #fff; width: 100%; max-width: 350px; border-radius: 10px; padding: 0; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 85vh; position: relative; }
    .od-paper::before { content: ""; display: block; height: 10px; background: var(--primary); }
    .od-header { padding: 20px; text-align: center; border-bottom: 1px solid #F0EDE5; }
    .od-shop-name { font-size: 20px; font-weight: bold; font-family: 'Noto Serif TC'; color: #2C2620; }
    .od-id { font-size: 11px; color: #999; margin-top: 5px; letter-spacing: 1px; }
    .od-scroll-content { padding: 20px; overflow-y: auto; flex: 1; }
    .od-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #555; }
    .od-total-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #2C2620; display: flex; justify-content: space-between; align-items: center; }
    .od-total-label { font-size: 14px; font-weight: bold; }
    .od-total-val { font-size: 22px; font-weight: bold; color: var(--danger); font-family: 'Noto Serif TC'; }
    .od-footer { padding: 15px; background: #FAF9F6; text-align: center; border-top: 1px solid #F0EDE5; }
    .btn-close-od { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ccc; background: #fff; color: #333; font-size: 16px; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; margin: 0 auto; }

    .service-option { padding: 15px; border: 1px solid #E0D8CC; border-radius: 12px; font-weight: bold; text-align: center; cursor: pointer; margin-bottom: 12px; background: #fff; color: #666; transition: all 0.2s; }
    .service-option.selected { border-color: var(--primary); color: var(--primary); background: #F2EFE9; }

    .modal-content-center { background: #fff; width: 85%; border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .form-input { width: 100%; padding: 12px; border: 1px solid #E0D8CC; border-radius: 10px; margin-bottom: 15px; box-sizing: border-box; background: #FAF9F6; outline: none; }
    .form-input:focus { border-color: var(--primary); background: #fff; }
    
    .msg-box { background: #fff; width: 80%; max-width: 300px; border-radius: 18px; padding: 30px 20px; text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.15); animation: popIn 0.2s ease-out; }
    .msg-icon { font-size: 48px; margin-bottom: 15px; color: var(--primary); opacity: 0.9; }
    .msg-text { font-size: 17px; font-weight: bold; color: #444; margin-bottom: 25px; line-height: 1.5; }
    .msg-btns { display: flex; gap: 12px; justify-content: center; }
    .msg-btn { flex: 1; padding: 10px 0; border-radius: 25px; font-size: 14px; font-weight: bold; border: none; cursor: pointer; letter-spacing: 1px; }
    .msg-btn-ok { background: var(--primary); color: #fff; }
    .msg-btn-cancel { background: #F0EDE5; color: #888; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>

  <div id="loading">Uni-S è¼‰å…¥ä¸­...</div>

  <div id="msg-modal-overlay" class="modal-overlay hidden" style="z-index: 2000;">
    <div class="msg-box">
      <div id="msg-icon" class="msg-icon"><i class="fas fa-check-circle"></i></div>
      <div id="msg-text" class="msg-text">...</div>
      <div class="msg-btns">
        <button id="msg-btn-no" class="msg-btn msg-btn-cancel hidden" onclick="closeMsgModal(false)">å–æ¶ˆ</button>
        <button id="msg-btn-yes" class="msg-btn msg-btn-ok" onclick="closeMsgModal(true)">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- Coupons View (Standalone) -->
  <div id="coupons-view" class="scroll-view hidden" style="background:#fff;">
    <div style="padding:20px 20px 10px 20px; display:flex; align-items:center;">
        <div onclick="switchTab('member')" style="font-size:20px; color:#666; cursor:pointer; margin-right:15px;"><i class="fas fa-arrow-left"></i></div>
        <div style="font-weight:bold; font-size:20px; color:#2C2620;">ç©åˆ†å…Œæ›ä¸­å¿ƒ</div>
    </div>
    <div id="coupons-list" class="coupon-grid" style="padding-top:10px;">
        <div style="text-align:center;color:#999;font-size:12px;">è¼‰å…¥å„ªæƒ åˆ¸ä¸­...</div>
    </div>
  </div>

  <!-- History View (Standalone) -->
  <div id="history-view" class="scroll-view hidden" style="background:#fff;">
    <div style="padding:20px 20px 10px 20px; display:flex; align-items:center;">
        <div style="font-weight:bold; font-size:20px; color:#2C2620;">æ­·å²è¨‚å–®</div>
    </div>
    <div id="history-list-container" style="padding: 20px;">
        <div style="text-align:center;color:#999;font-size:12px;">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <!-- Member View -->
  <div id="member-view" class="scroll-view hidden" style="padding-top: 70px;">
    <div class="member-header-bg"></div>
    <div class="premium-card">
      <div class="card-user-row">
          <img id="m-avatar" src="" class="card-avatar" style="border:2px solid var(--gold);">
          <div style="flex:1;">
              <div id="m-name" style="font-size:20px;font-weight:bold;color:var(--gold);font-family:'Noto Serif TC';">...</div>
              <div style="font-size:11px;background:rgba(204,186,138,0.2);color:#E0D8CC;padding:3px 10px;border-radius:12px;display:inline-block;margin-top:6px;border:1px solid rgba(204,186,138,0.3);">æ™®é€šæœƒå“¡</div>
          </div>
          <i class="fas fa-cog" onclick="openEditModal()" style="font-size:20px;color:rgba(255,255,255,0.6);cursor:pointer;"></i>
      </div>
      <div class="card-stats-row">
          <div class="stat-box"><span class="stat-num">0</span><span class="stat-label">é¤˜é¡</span></div>
          <div class="stat-box" style="border-left:1px solid rgba(255,255,255,0.1); border-right:1px solid rgba(255,255,255,0.1);">
              <span class="stat-num" id="m-points">0</span><span class="stat-label">ç©åˆ†</span>
          </div>
          <div class="stat-box"><span class="stat-num">2</span><span class="stat-label">å„ªæƒ åˆ¸</span></div>
      </div>
    </div>
    
    <div class="service-section">
      <div class="service-item" onclick="switchTab('coupons')">
          <div class="service-icon" style="color:var(--primary);"><i class="fas fa-coins"></i></div>
          <div class="service-label" style="font-weight:bold; color:#4A4A4A;">ç©åˆ†å…Œæ›</div>
      </div>
      <div class="service-item" onclick="showMsg('å®¢æœé€£ç·šä¸­...')"><div class="service-icon"><i class="fas fa-headset"></i></div><div class="service-label">è¯ç¹«å®¢æœ</div></div>
      <div class="service-item" onclick="showMsg('å¸¸è¦‹å•é¡Œé é¢')"><div class="service-icon"><i class="fas fa-question-circle"></i></div><div class="service-label">å¸¸è¦‹å•é¡Œ</div></div>
      <div class="service-item" onclick="showMsg('Uni-S v1.3')"><div class="service-icon"><i class="fas fa-info-circle"></i></div><div class="service-label">é—œæ–¼æˆ‘å€‘</div></div>
    </div>

    <div style="padding:0 20px 20px 20px;">
        <div style="font-weight:bold; margin-bottom:15px; font-size:16px; color:#2C2620;">æˆ‘çš„å„ªæƒ åˆ¸</div>
        <div id="my-coupons-list" style="color:#999;font-size:13px; text-align:center; padding:20px 0;">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <!-- Shop View (Main Home) -->
  <div id="shop-view" class="hidden">
    <div id="shop-banner" class="shop-banner-area">
        <div class="shop-banner-overlay">
            <h1 class="shop-title-large" id="shop-name-title">...</h1>
            <div class="shop-subtitle">Uni-S Tea & Life</div>
        </div>
    </div>
    
    <div class="shop-controls">
      <div class="controls-top-row">
          <div class="delivery-toggle"><button class="toggle-btn active">è‡ªå–</button><button class="toggle-btn">å¤–é€</button></div>
          <div class="btn-nav" id="btn-navigate" onclick="openMap()"><i class="fas fa-directions"></i> å°èˆª</div>
      </div>
      <div class="shop-detail-info">
          <div class="info-row"><i class="fas fa-map-marker-alt" style="width:14px; text-align:center;"></i> <span id="shop-address">...</span></div>
          <div class="info-row"><i class="fas fa-clock" style="width:14px; text-align:center;"></i> <span id="shop-hours">...</span></div>
      </div>
    </div>
    
    <div class="shop-body">
      <div class="menu-sidebar" id="food-sidebar" style="display:none;"></div>
      <div class="menu-content" id="food-content" style="display:none;"></div>
      <div id="mode-retail" class="retail-grid" style="display:none;"></div>
    </div>
    
    <div id="cart-bar" class="cart-bar" style="display:none;">
      <div class="cart-left" onclick="openCartModal()">
        <div style="position:relative;margin-right:15px;"><i class="fas fa-shopping-bag" style="font-size:24px;"></i><div class="cart-badge" id="cart-count">0</div></div>
        <div style="font-size:18px;font-weight:bold;">$<span id="cart-total">0</span></div>
      </div>
      <div class="btn-checkout" onclick="preCheckout()">å»çµç®—</div>
    </div>
  </div>

  <!-- Receipt Order Detail -->
  <div id="order-detail-view" class="hidden">
    <div class="od-paper">
      <div class="od-header">
        <div class="od-shop-name" id="od-shop-name">...</div>
        <div class="od-id">å–®è™Ÿï¼š<span id="od-id"></span></div>
        <div style="font-size:11px;color:#999;margin-top:2px;" id="od-time"></div>
        <div style="margin-top:10px;"><span id="od-status" style="font-weight:bold;font-size:13px;padding:3px 8px;border-radius:4px;background:#eee;">...</span></div>
      </div>
      
      <div class="od-scroll-content" id="od-items-list"></div>

      <div style="padding:20px;background:#fff;">
        <div class="od-total-section">
          <span class="od-total-label">ç¸½è¨ˆé‡‘é¡</span>
          <span class="od-total-val" id="od-total-price">...</span>
        </div>
        
        <div style="margin-top:10px;font-size:13px;color:#666;display:flex;justify-content:space-between;">
            <span>è¯çµ¡é›»è©±</span>
            <span id="od-phone">...</span>
        </div>

        <div id="od-cancel-container" style="margin-top:20px;"></div>
      </div>

      <div class="od-footer">
        <div style="font-size:11px;color:#999;margin-bottom:8px;">Uni-S Platform Service</div>
        <button class="btn-close-od" onclick="closeOrderDetail()"><i class="fas fa-times"></i></button>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal" class="modal-overlay hidden" onclick="closeCartModal()">
    <div class="modal-sheet" style="padding:0;" onclick="event.stopPropagation()">
      <div class="cart-header">
         <div style="font-weight:bold;font-size:16px;color:#2C2620;">è³¼ç‰©è»Šå…§å®¹</div>
         <div onclick="closeCartModal()" style="cursor:pointer;padding:5px;color:#999;"><i class="fas fa-chevron-down"></i></div>
      </div>
      <div style="background:#FAF9F6;padding:10px 20px;font-size:12px;color:#888;display:flex;justify-content:space-between;align-items:center;">
          <span>å·²é¸å•†å“</span>
          <span onclick="clearCart()" style="cursor:pointer;color:#B85C5C;"><i class="fas fa-trash"></i> æ¸…ç©º</span>
      </div>
      <div id="cart-list" class="cart-list"></div>
      <div style="height:20px;"></div>
    </div>
  </div>

  <!-- Spec Modal -->
  <div id="spec-modal" class="modal-overlay hidden">
    <div class="modal-sheet">
      <div style="text-align:right;padding:15px;"><i class="fas fa-times" onclick="closeSpecModal()" style="font-size:22px;color:#ccc;cursor:pointer;"></i></div>
      <div class="spec-header"><div class="spec-img" id="sp-img"></div><div><div style="font-size:20px;font-weight:bold;color:#2C2620;" id="sp-name"></div><div style="font-size:13px;color:#888;margin-top:5px;" id="sp-desc"></div></div></div>
      <div id="sp-options" class="spec-options"></div>
      <div class="spec-footer" style="padding:15px 20px; border-top:1px solid #F0EDE5;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
           <div style="font-size:22px;font-weight:bold;color:var(--primary);font-family:'Noto Serif TC';">$<span id="sp-price">0</span></div>
           <div class="stepper"><button onclick="updateSpQty(-1)">-</button><span id="sp-qty" style="margin:0 10px;font-weight:bold;">1</span><button onclick="updateSpQty(1)">+</button></div>
        </div>
        <div class="spec-add-btn" onclick="addSpecToCart()">åŠ å…¥è³¼ç‰©è»Š</div>
      </div>
    </div>
  </div>
  
  <!-- Checkout Modal -->
  <div id="service-modal" class="modal-overlay hidden">
    <div class="modal-sheet">
      <div style="padding:25px;">
        <div style="text-align:center;font-weight:bold;font-size:18px;margin-bottom:20px;color:#2C2620;">é¸æ“‡æœå‹™æ–¹å¼</div>
        <div id="service-options"></div>
        <div style="margin-top:25px;">
            <div style="font-weight:bold;margin-bottom:10px;color:#4A4A4A;">å„ªæƒ åˆ¸</div>
            <select id="coupon-selector" style="width:100%;padding:12px;border-radius:10px;border:1px solid #E0D8CC;background:#FAF9F6;color:#4A4A4A;outline:none;">
                <option value="">ä¸ä½¿ç”¨å„ªæƒ åˆ¸</option>
            </select>
        </div>
        <div style="margin-top:25px;text-align:right;">
            <span style="font-size:14px;color:#888;">å¯¦ä»˜é‡‘é¡</span>
            <span id="final-checkout-price" style="font-size:24px;font-weight:bold;color:var(--danger);margin-left:8px;font-family:'Noto Serif TC';">$0</span>
        </div>
        <div class="spec-add-btn" style="text-align:center;margin-top:20px;" onclick="confirmOrder()">ç¢ºèªä¸‹å–®</div>
        <div style="text-align:center;margin-top:15px;color:#999;font-size:13px;cursor:pointer;" onclick="document.getElementById('service-modal').classList.add('hidden')">å–æ¶ˆ</div>
      </div>
    </div>
  </div>

  <div id="edit-modal" class="modal-overlay hidden">
    <div class="modal-content-center">
      <div style="text-align:center;font-weight:bold;margin-bottom:20px;font-size:18px;color:#2C2620;">ç·¨è¼¯è³‡æ–™</div>
      <div style="margin-bottom:12px;"><label style="font-size:12px;color:#888;margin-bottom:4px;display:block;">å§“å</label><input type="text" id="edit-name" class="form-input"></div>
      <div style="margin-bottom:12px;"><label style="font-size:12px;color:#888;margin-bottom:4px;display:block;">é›»è©±</label><input type="tel" id="edit-phone" class="form-input"></div>
      <div style="margin-bottom:20px;"><label style="font-size:12px;color:#888;margin-bottom:4px;display:block;">ç”Ÿæ—¥</label><input type="date" id="edit-birthday" class="form-input"></div>
      <div style="display:flex;gap:12px;"><div style="flex:1;text-align:center;padding:12px;background:#F0EDE5;color:#666;border-radius:25px;cursor:pointer;" onclick="closeEditModal()">å–æ¶ˆ</div><div class="btn-save" style="flex:1;text-align:center;padding:12px;background:var(--primary);color:#fff;border-radius:25px;font-weight:bold;cursor:pointer;" onclick="saveProfile()">å„²å­˜</div></div>
    </div>
  </div>

  <!-- Updated Tab Bar -->
  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('menu')">
        <div class="tab-icon"><i class="fas fa-mug-hot"></i></div>
        <div>é»é¤</div>
    </div>
    <div class="tab-item" onclick="switchTab('history')">
        <div class="tab-icon"><i class="fas fa-history"></i></div>
        <div>ç´€éŒ„</div>
    </div>
    <div class="tab-item" onclick="switchTab('member')">
        <div class="tab-icon"><i class="fas fa-user"></i></div>
        <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ è¨­å®šå€ âš ï¸âš ï¸âš ï¸
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";
    const TARGET_SHOP_ID = "1"; // ğŸ”¥ è«‹æ›¿æ›ç‚ºæ‚¨çš„ç›®æ¨™åº—å®¶ ID

    // ç‹€æ…‹
    let allShops = {}; let currentShop = null; let cart = []; 
    let userProfile = null; let orderCache = []; let selectedService = "";
    let currentItem = null; let currentOptions = {}; let currentQty = 1;
    let userLocation = null;
    let myCoupons = []; 

    let modalCb = null;
    // [Fixed] Updated showMsg to accept a showOkBtn flag
    function showMsg(txt, cb, showOkBtn = true) { 
      document.getElementById('msg-text').innerText = txt; 
      document.getElementById('msg-btn-no').classList.add('hidden'); 
      const yesBtn = document.getElementById('msg-btn-yes');
      if (showOkBtn) {
          yesBtn.classList.remove('hidden');
      } else {
          yesBtn.classList.add('hidden');
      }
      document.getElementById('msg-modal-overlay').classList.remove('hidden'); 
      modalCb = cb; 
    }

    // Helper to show loading state (no buttons)
    function showLoadingMsg(txt) {
        showMsg(txt, null, false);
    }

    function showConfirm(txt, cb) {
      document.getElementById('msg-text').innerText = txt; 
      document.getElementById('msg-btn-no').classList.remove('hidden');
      document.getElementById('msg-btn-yes').classList.remove('hidden'); // Ensure yes button is visible for confirm
      document.getElementById('msg-modal-overlay').classList.remove('hidden');
      modalCb = cb;
    }
    function closeMsgModal(isYes) {
      document.getElementById('msg-modal-overlay').classList.add('hidden');
      if(isYes && modalCb) modalCb();
      modalCb = null;
    }

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        // [Fixed] Safe DOM update
        updateUI();

        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        // ğŸ”¥ Single Brand Logic
        if (allShops[TARGET_SHOP_ID]) {
            openShop(TARGET_SHOP_ID);
        } else {
            showMsg("åº—å®¶è¨­å®šéŒ¯èª¤ (TARGET_SHOP_ID ç„¡æ•ˆ)");
        }
        
        fetchMemberData();
      } catch (err) { showMsg(err.message); }
    }

    // [Fixed] updateUI to prevent null errors
    function updateUI() { 
        const mName = document.getElementById('m-name');
        const mAvatar = document.getElementById('m-avatar');
        if (mName) mName.innerText = userProfile.displayName;
        if (mAvatar) mAvatar.src = userProfile.pictureUrl;
    }

    // ========== è·¯ç”±é‚è¼¯ ==========
    function switchTab(tab) {
        // éš±è—æ‰€æœ‰è¦–åœ– (ç¢ºä¿ lobby-view å·²ç§»é™¤)
        ['coupons-view', 'member-view', 'shop-view', 'history-view', 'order-detail-view'].forEach(id => {
             const el = document.getElementById(id);
             if(el) el.classList.add('hidden');
        });

        const tabBar = document.getElementById('tab-bar');
        if(tabBar) tabBar.classList.remove('hidden');

        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        
        if (tab === 'menu') {
            const shopView = document.getElementById('shop-view');
            if(shopView) shopView.classList.remove('hidden');
            document.querySelectorAll('.tab-item')[0].classList.add('active');
        } else if (tab === 'history') {
            const histView = document.getElementById('history-view');
            if(histView) histView.classList.remove('hidden');
            document.querySelectorAll('.tab-item')[1].classList.add('active');
            loadOrderHistory();
        } else if (tab === 'member') {
            const memView = document.getElementById('member-view');
            if(memView) memView.classList.remove('hidden');
            document.querySelectorAll('.tab-item')[2].classList.add('active');
            fetchMemberData();
            loadMyCoupons();
        } else if (tab === 'coupons') {
            if(tabBar) tabBar.classList.add('hidden'); 
            const coupView = document.getElementById('coupons-view');
            if(coupView) coupView.classList.remove('hidden');
            loadCoupons();
        }
    }

    // ========== å„ªæƒ åˆ¸é‚è¼¯ ==========
    async function loadCoupons() {
        const list = document.getElementById('coupons-list');
        list.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">è¼‰å…¥å„ªæƒ åˆ¸ä¸­...</div>';
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getCoupons" }) });
            const text = await res.text();
            let coupons;
            try { coupons = JSON.parse(text); } catch (e) { throw new Error("Server Error"); }

            if (coupons.status === 'error') throw new Error(coupons.message);
            
            if (!Array.isArray(coupons) || coupons.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;margin-top:20px;">ç›®å‰æ²’æœ‰å¯ç”¨çš„å„ªæƒ åˆ¸</div>';
                return;
            }
            let html = '';
            coupons.forEach(c => {
                html += `
                <div class="coupon-item">
                    <div class="coupon-left"><div class="coupon-val">$${c.value}</div><div style="font-size:10px;">æŠµç”¨åˆ¸</div></div>
                    <div class="coupon-right">
                        <div class="coupon-name">${c.name}</div>
                        <div class="coupon-cost">éœ€ ${c.cost} ç©åˆ†</div>
                        <div class="btn-redeem" onclick="redeemCoupon('${c.id}')">ç«‹å³å…Œæ›</div>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        } catch(e) { list.innerHTML = `<div style="text-align:center;color:var(--danger);">è¼‰å…¥å¤±æ•—</div>`; }
    }

    async function redeemCoupon(id) {
        showConfirm("ç¢ºå®šè¦å…Œæ›é€™å¼µå„ªæƒ åˆ¸å—ï¼Ÿ", async () => {
            // [Fixed] Use showLoadingMsg to hide button while processing
            showLoadingMsg("è™•ç†ä¸­...");
            try {
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "redeemCoupon", userId: userProfile.userId, couponId: id }) });
                setTimeout(() => { showMsg("âœ… å…Œæ›è«‹æ±‚å·²é€å‡ºï¼", () => { fetchMemberData(); }); }, 1500);
            } catch(e) { showMsg("éŒ¯èª¤ï¼š" + e.message); }
        });
    }

    async function loadMyCoupons() {
        const list = document.getElementById('my-coupons-list');
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMyCoupons", userId: userProfile.userId }) });
            const text = await res.text();
            try { myCoupons = JSON.parse(text); } catch(e) { myCoupons = []; }
            
            if (myCoupons.length === 0) {
                list.innerHTML = 'å°šç„¡å„ªæƒ åˆ¸';
            } else {
                let html = '';
                myCoupons.forEach(c => {
                    html += `<div class="my-coupon-item"><div><div style="font-weight:bold;color:#2C2620;">${c.name}</div><div style="font-size:11px;color:#999;">æŠ˜æŠµ $${c.value}</div></div><div style="color:var(--primary);font-weight:bold;font-size:12px;border:1px solid var(--primary);padding:2px 8px;border-radius:10px;">æœªä½¿ç”¨</div></div>`;
                });
                list.innerHTML = html;
            }
        } catch(e) { list.innerHTML = 'è¼‰å…¥å¤±æ•—'; }
    }

    // ========== çµå¸³ ==========
    async function preCheckout() {
      if(cart.length===0) { showMsg("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }
      const svcs = currentShop.services || ["è‡ªå–"];
      let html = '';
      svcs.forEach((s,i) => { html += `<div class="service-option ${i===0?'selected':''}" onclick="selSvc(this,'${s}')">${s}</div>`; if(i===0) selectedService = s; });
      document.getElementById('service-options').innerHTML = html;

      const select = document.getElementById('coupon-selector');
      select.innerHTML = '<option value="" data-val="0">ä¸ä½¿ç”¨å„ªæƒ åˆ¸</option>';
      select.onchange = updateFinalPrice; 

      try {
          const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMyCoupons", userId: userProfile.userId }) });
          const text = await res.text();
          myCoupons = JSON.parse(text);
          myCoupons.forEach(c => {
              let opt = document.createElement('option');
              opt.value = c.uuid;
              opt.setAttribute('data-val', c.value);
              opt.innerText = `${c.name} (æŠ˜æŠµ $${c.value})`;
              select.appendChild(opt);
          });
      } catch(e) {}

      updateFinalPrice();
      document.getElementById('service-modal').classList.remove('hidden');
    }

    function updateFinalPrice() {
        const select = document.getElementById('coupon-selector');
        const discount = parseInt(select.options[select.selectedIndex].getAttribute('data-val') || 0);
        const cartTotal = parseInt(document.getElementById('cart-total').innerText);
        const final = Math.max(0, cartTotal - discount);
        document.getElementById('final-checkout-price').innerText = "$" + final;
    }

    async function confirmOrder() {
      document.getElementById('service-modal').classList.add('hidden');
      const select = document.getElementById('coupon-selector');
      const couponUuid = select.value;
      const discount = parseInt(select.options[select.selectedIndex].getAttribute('data-val') || 0);

      let detail = "", total = 0;
      cart.forEach(x => { detail += `${x.name} x ${x.qty} ($${x.total})\n`; total += x.total; });
      detail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ\næœå‹™æ–¹å¼ï¼š${selectedService}`;
      if (discount > 0) { detail += `\nå„ªæƒ åˆ¸æŠ˜æŠµï¼š-$${discount}\nå¯¦ä»˜é‡‘é¡ï¼š$${Math.max(0, total - discount)}`; }

      let phone = localStorage.getItem("uni_user_phone");
      if(!phone) { phone = prompt("è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼š"); if(!phone) return; localStorage.setItem("uni_user_phone", phone); }
      detail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${phone}`;

      // [Fixed] Use showLoadingMsg to hide button while processing
      showLoadingMsg("è™•ç†ä¸­...");
      try {
        await liff.sendMessages([{type:"text", text:`ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${detail}`}]);
        await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({
                shopId:currentShop.id, userName:userProfile.displayName, userId:userProfile.userId, order:detail, couponUuid: couponUuid 
            })
        });
        showMsg("âœ… è¨‚å–®å·²é€å‡ºï¼", () => { cart=[]; updateCartUI(); });
      } catch(e) { showMsg("å¤±æ•—:"+e.message); }
    }

    // Helper Functions
    function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = deg2rad(lat2 - lat1); const dLon = deg2rad(lon2 - lon1); const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return (R * c).toFixed(1); }
    function deg2rad(deg) { return deg * (Math.PI/180); }
    // initLocationService removed from main flow but kept as helper if needed
    function initLocationService() { return new Promise((resolve) => { if (!navigator.geolocation) { resolve(); return; } const timeoutId = setTimeout(() => { resolve(); }, 5000); navigator.geolocation.getCurrentPosition((position) => { clearTimeout(timeoutId); userLocation = { lat: position.coords.latitude, lng: position.coords.longitude }; resolve(); }, (error) => { clearTimeout(timeoutId); resolve(); }); }); }
    
    function openShop(id) { 
        currentShop = allShops[id]; 
        currentShop.id = id; 
        cart = []; 
        updateCartUI(); 

        // Clean up view visibility (Removed lobby-view)
        ['coupons-view','member-view','history-view'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        });

        document.getElementById('shop-view').classList.remove('hidden');
        document.getElementById('tab-bar').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[0].classList.add('active');

        document.getElementById('shop-name-title').innerText = currentShop.name; 
        document.getElementById('shop-banner').style.backgroundImage = `url(${currentShop.bannerUrl})`; 
        document.getElementById('shop-address').innerText = currentShop.address || "æš«ç„¡åœ°å€è³‡è¨Š"; 
        document.getElementById('shop-hours').innerText = currentShop.openHours || "ç‡Ÿæ¥­æ™‚é–“æœªå®š"; 
        
        if (currentShop.type === 'retail') { 
            document.getElementById('food-sidebar').style.display = 'none'; 
            document.getElementById('food-content').style.display = 'none'; 
            document.getElementById('mode-retail').style.display = 'grid'; 
            renderRetailMenu(); 
        } else { 
            document.getElementById('mode-retail').style.display = 'none'; 
            document.getElementById('food-sidebar').style.display = 'block'; 
            document.getElementById('food-content').style.display = 'block'; 
            renderFoodMenu(); 
        } 
    }
    
    function openMap() { if (currentShop) { if (currentShop.address && currentShop.address.trim() !== "") { window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(currentShop.address)}`, '_blank'); } else if (currentShop.lat && currentShop.lng) { window.open(`https://www.google.com/maps/dir/?api=1&destination=${currentShop.lat},${currentShop.lng}`, '_blank'); } else { showMsg("ç„¡æ³•å–å¾—å•†å®¶ä½ç½®è³‡è¨Š"); } } }
    function renderFoodMenu() { const catList = document.getElementById('food-sidebar'); const prodList = document.getElementById('food-content'); catList.innerHTML = ''; prodList.innerHTML = ''; let menu = Array.isArray(currentShop.menu) && currentShop.menu[0].category ? currentShop.menu : [{category:"å…¨éƒ¨", items:currentShop.menu}]; menu.forEach((cat, idx) => { catList.innerHTML += `<div class="category-item ${idx===0?'active':''}" id="cat-btn-${idx}" onclick="document.getElementById('cat-sec-${idx}').scrollIntoView({behavior:'smooth'})">${cat.category}</div>`; let itemsHtml = ''; cat.items.forEach(item => { let itemJson = JSON.stringify(item).replace(/"/g, '&quot;'); itemsHtml += `<div class="food-item" onclick="openSpecModal(${itemJson})"><div class="food-img" style="background-image:url(${item.img||currentShop.bannerUrl})"></div><div class="food-info"><div><div class="food-name">${item.name}</div><div class="food-desc">${item.desc||''}</div></div><div class="food-action"><div class="food-price">$${item.price}</div><div class="btn-add-mini">+</div></div></div></div>`; }); prodList.innerHTML += `<div id="cat-sec-${idx}" class="cat-section"><div class="category-title" style="margin:15px 0 10px 0;font-weight:bold;color:#333;">${cat.category}</div>${itemsHtml}</div>`; }); prodList.onscroll = function() { const secs = document.querySelectorAll('.cat-section'); secs.forEach((sec,i) => { if(sec.offsetTop - prodList.offsetTop <= prodList.scrollTop + 50) { document.querySelectorAll('.category-item').forEach(e=>e.classList.remove('active')); document.getElementById(`cat-btn-${i}`).classList.add('active'); } }); }; }
    function renderRetailMenu() { let html = ''; currentShop.menu.forEach((item, idx) => { let img = item.img || currentShop.bannerUrl; html += `<div class="retail-item"><div class="retail-img" style="background-image:url(${img})"></div><div class="retail-info"><div style="font-weight:bold;font-size:14px;">${item.name}</div><div class="retail-actions" style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#e64a19;font-weight:bold;">$${item.price}</span><div class="stepper-mini"><button onclick="updateCartRetail('${item.name}', ${item.price}, -1)">-</button><span id="r-qty-${idx}" style="font-size:13px;font-weight:bold;margin:0 5px;">0</span><button onclick="updateCartRetail('${item.name}', ${item.price}, 1)">+</button></div></div></div></div>`; }); document.getElementById('mode-retail').innerHTML = html; }
    function openSpecModal(item) { currentItem = item; currentQty = 1; currentOptions = {}; document.getElementById('sp-name').innerText = item.name; document.getElementById('sp-desc').innerText = item.desc||''; document.getElementById('sp-price').innerText = item.price; document.getElementById('sp-img').style.backgroundImage = `url(${item.img||currentShop.bannerUrl})`; document.getElementById('sp-qty').innerText = 1; let html = ''; for (let [k, vals] of Object.entries(item.options||{})) { currentOptions[k] = vals[0]; let chips = vals.map((v,i) => `<div class="chip ${i===0?'selected':''}" onclick="selOpt(this,'${k}','${v}')">${v}</div>`).join(''); html += `<div class="option-group"><div class="option-title" style="margin-bottom:8px;font-size:13px;color:#666;">${k}</div><div class="option-chips" style="display:flex;gap:8px;flex-wrap:wrap;">${chips}</div></div>`; } document.getElementById('sp-options').innerHTML = html || '<div style="color:#999;font-size:12px;">ç„¡è¦æ ¼é¸é …</div>'; document.getElementById('spec-modal').classList.remove('hidden'); }
    function selOpt(el, k, v) { el.parentNode.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); currentOptions[k] = v; }
    function updateSpQty(n) { if(currentQty+n>0) { currentQty+=n; document.getElementById('sp-qty').innerText=currentQty; document.getElementById('sp-price').innerText=currentItem.price*currentQty; } }
    function addSpecToCart() { let opts = Object.values(currentOptions).join('/'); if(opts) opts = `(${opts})`; cart.push({name: currentItem.name + " " + opts, price: currentItem.price, qty: currentQty, total: currentItem.price*currentQty}); document.getElementById('spec-modal').classList.add('hidden'); updateCartUI(); }
    function updateCartRetail(name, price, change) { let exist = cart.find(x => x.name === name); if(exist) { exist.qty += change; if(exist.qty<=0) cart = cart.filter(x=>x.name!==name); else exist.total = exist.price*exist.qty; } else if(change>0) cart.push({name:name, price:price, qty:1, total:price, opts:""}); updateCartUI(); currentShop.menu.forEach((item,idx) => { let el = document.getElementById(`r-qty-${idx}`); let inCart = cart.find(x=>x.name===item.name); if(el) el.innerText = inCart?inCart.qty:0; }); }
    function updateCartUI() { let totalQty = cart.reduce((a,b)=>a+b.qty,0); let totalPrice = cart.reduce((a,b)=>a+b.total,0); if(totalQty > 0) { document.getElementById('cart-bar').style.display = 'flex'; document.getElementById('cart-count').innerText = totalQty; document.getElementById('cart-total').innerText = totalPrice; } else { document.getElementById('cart-bar').style.display = 'none'; closeCartModal(); } }
    function openCartModal() { if(cart.length===0) { closeCartModal(); return; } const list = document.getElementById('cart-list'); let html = ''; cart.forEach((item, idx) => { html += ` <div class="cart-item"> <div style="flex:1;"> <div style="font-size:15px;font-weight:bold;margin-bottom:4px;">${item.name}</div> <div style="font-size:12px;color:#999;">$${item.price}</div> </div> <div style="display:flex;align-items:center;gap:15px;"> <div style="font-weight:bold;min-width:40px;text-align:right;">$${item.total}</div> <div class="cart-stepper"> <button onclick="updateCartItemQty(${idx}, -1)"><i class="fas fa-minus"></i></button> <span>${item.qty}</span> <button onclick="updateCartItemQty(${idx}, 1)"><i class="fas fa-plus"></i></button> </div> </div> </div>`; }); list.innerHTML = html; document.getElementById('cart-modal').classList.remove('hidden'); }
    function updateCartItemQty(idx, change) { let item = cart[idx]; if(!item) return; item.qty += change; if(item.qty <= 0) { cart.splice(idx, 1); } else { item.total = item.price * item.qty; } updateCartUI(); if(cart.length > 0) { openCartModal(); } else { closeCartModal(); } }
    function closeCartModal() { document.getElementById('cart-modal').classList.add('hidden'); }
    function closeSpecModal() { document.getElementById('spec-modal').classList.add('hidden'); }
    function clearCart() { cart = []; updateCartUI(); }
    function removeCartItem(idx) { cart.splice(idx, 1); updateCartUI(); if(cart.length > 0) openCartModal(); }
    function selSvc(el, s) { document.querySelectorAll('.service-option').forEach(e=>e.classList.remove('selected')); el.classList.add('selected'); selectedService = s; }
    
    function loadOrderHistory() {
        document.getElementById('history-list-container').innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">è¼‰å…¥ä¸­...</div>';
        fetch(API_URL, {method:'POST', body:JSON.stringify({action:"getHistory", userId:userProfile.userId})})
        .then(res=>res.json())
        .then(data=>{ 
            orderCache = data; 
            const container = document.getElementById('history-list-container');
            if(orderCache.length===0) { container.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">å°šç„¡è¨‚å–®ç´€éŒ„</div>'; return; } 
            let html = ''; 
            orderCache.forEach((o, i) => { 
                let price = o.content.split('ç¸½é‡‘é¡ï¼š')[1]?.split('\n')[0].replace('å…ƒ','').trim() || ''; 
                let summary = o.content.split('\n').filter(line => !line.includes('ç¸½é‡‘é¡') && !line.includes('---') && !line.includes('é›»è©±') && line.trim() !== '').slice(0, 2).join(', ');
                if (summary.length > 20) summary = summary.substring(0, 20) + '...';
                let statusClass = 'status-wait';
                if (o.status.includes('å·²æ¥å–®')) statusClass = 'status-ok';
                else if (o.status.includes('å©‰æ‹’') || o.status.includes('å–æ¶ˆ')) statusClass = 'status-no';
                html += `<div class="history-card" onclick="openOrderDetail(${i})"><div class="hc-header"><div class="hc-shop">${o.shopName}</div><div class="hc-date">${o.time}</div></div><div class="hc-body"><div class="hc-summary">${summary || 'é»æ“ŠæŸ¥çœ‹è©³æƒ…'}</div><div style="text-align:right;"><div class="hc-price">$${price}</div><div class="hc-status ${statusClass}">${o.status}</div></div></div></div>`; 
            }); 
            container.innerHTML = html; 
        }).catch(e=>{}); 
    }

    function openOrderDetail(idx) { 
        let o = orderCache[idx]; 
        document.getElementById('order-detail-view').classList.remove('hidden'); 
        document.getElementById('od-shop-name').innerText = o.shopName; 
        document.getElementById('od-status').innerText = o.status; 
        document.getElementById('od-id').innerText = o.orderId; 
        document.getElementById('od-time').innerText = o.time; 
        let html = '', total = '0', phone = '--'; 
        o.content.split('\n').forEach(line => { 
            if(line.includes('ç¸½é‡‘é¡')) { total = line.split('ï¼š')[1].replace('å…ƒ','').trim(); } 
            else if(line.includes('é›»è©±')) { phone = line.split('ï¼š')[1]; } 
            else if(!line.includes('---') && line.trim()) { 
                let parts = line.split('$'); 
                let name = line; let price = ''; 
                if(parts.length > 1) { name = parts[0]; price = '$' + parts[1]; } 
                html += `<div class="od-row"><div>${name}</div><div>${price}</div></div>`; 
            } 
        }); 
        document.getElementById('od-items-list').innerHTML = html; 
        document.getElementById('od-total-price').innerText = total; 
        document.getElementById('od-phone').innerText = phone; 
        const cancelDiv = document.getElementById('od-cancel-container');
        if(o.status.includes('å¾…ç¢ºèª')) { cancelDiv.innerHTML = `<div class="spec-add-btn" style="background:#fff;color:#D32F2F;border:1px solid #D32F2F;text-align:center;box-shadow:none;" onclick="cancelOrder('${o.orderId}')">å–æ¶ˆè¨‚å–®</div>`; } 
        else { cancelDiv.innerHTML = ''; }
    }

    function closeOrderDetail() { document.getElementById('order-detail-view').classList.add('hidden'); }
    function cancelOrder(oid) { showConfirm("ç¢ºå®šå–æ¶ˆï¼Ÿ", async () => { await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:"cancelOrder", orderId:oid, userId:userProfile.userId})}); setTimeout(() => { showMsg("å·²é€å‡ºå–æ¶ˆ", () => { closeOrderDetail(); loadOrderHistory(); }); }, 1500); }); }
    function fetchMemberData() { fetch(`${API_URL}?action=getMember&userId=${userProfile.userId}`).then(res=>res.json()).then(data=>{ document.getElementById('m-points').innerText = data.points || 0; document.getElementById('home-points').innerText = data.points || 0; if(data.name && data.name!=="æœƒå“¡") ['home-name','m-name'].forEach(id=>document.getElementById(id).innerText=data.name); window.currentMemberData = data; }).catch(e=>{}); }
    function openEditModal() { const data = window.currentMemberData || {}; document.getElementById('edit-name').value = data.name || userProfile.displayName; document.getElementById('edit-phone').value = data.phone || localStorage.getItem("uni_user_phone") || ""; if (data.birthday) try { document.getElementById('edit-birthday').value = new Date(data.birthday).toISOString().split('T')[0]; } catch(e){} document.getElementById('edit-modal').classList.remove('hidden'); }
    function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
    function saveProfile() { const name = document.getElementById('edit-name').value; const phone = document.getElementById('edit-phone').value; const birthday = document.getElementById('edit-birthday').value; if (!name || !phone) { showMsg("å§“åèˆ‡é›»è©±ç‚ºå¿…å¡«"); return; } const btn = document.querySelector('.btn-save'); btn.innerText = "å„²å­˜ä¸­..."; fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: "updateProfile", userId: userProfile.userId, name: name, phone: phone, birthday: birthday }) }).then(()=>{ showMsg("è³‡æ–™æ›´æ–°æˆåŠŸï¼", () => { localStorage.setItem("uni_user_phone", phone); closeEditModal(); fetchMemberData(); }); }).catch(e=>{ showMsg("æ›´æ–°å¤±æ•—"); }).finally(()=>{ btn.innerText = "å„²å­˜"; }); }

    main();
  </script>
</body>
</html>
