<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S ç”Ÿæ´»åœˆ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ... (ä¿ç•™åŸæœ¬çš„ CSS å…¨å±€è¨­å®š) ... */
    :root { --primary: #06C755; --gold: #C5A674; --bg: #F5F6F7; --text: #333; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 0; margin: 0; background-color: var(--bg); color: var(--text); touch-action: manipulation; -webkit-user-select: none; user-select: none; padding-bottom: 90px; }
    .hidden { display: none !important; }
    #loading, #error-box { text-align: center; padding: 50px; color: #999; }

    /* åº•éƒ¨å°èˆªã€å¤§å»³ã€æœƒå“¡ CSS ä¿æŒä¸è®Š (ç‚ºç¯€çœç¯‡å¹…çœç•¥ï¼Œè«‹ç›´æ¥ä½¿ç”¨ä¸Šä¸€ç‰ˆçš„æ¨£å¼ï¼Œæˆ–æˆ‘å¹«ä½ è£œé½Š) */
    /* â†“â†“â†“ ç‚ºäº†ç¢ºä¿å®Œæ•´æ€§ï¼Œé€™è£¡æˆ‘æŠŠé—œéµ CSS éƒ½è£œé½Š â†“â†“â†“ */
    #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; height: 60px; display: flex; border-top: 1px solid #eee; z-index: 200; padding-bottom: env(safe-area-inset-bottom); }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; }
    .tab-item.active { color: var(--primary); font-weight: bold; }
    .tab-icon { font-size: 22px; margin-bottom: 3px; }
    
    /* å¤§å»³ & æœƒå“¡ (æ²¿ç”¨ä¸Šä¸€ç‰ˆæ¨£å¼ï¼Œé€™è£¡ç°¡ç•¥å¸¶éï¼Œå¯¦éš›è«‹è¤‡è£½å®Œæ•´ç‰ˆ) */
    #lobby-view, #coupons-view, #member-view { padding-bottom: 20px; }
    .lobby-header-bg { background: linear-gradient(135deg, #2c3e50, #000); height: 160px; border-radius: 0 0 20px 20px; padding: 20px; color: var(--gold); }
    .float-member-card { background: #fff; margin: -80px 15px 15px 15px; border-radius: 12px; padding: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); display: flex; align-items: center; cursor: pointer; }
    .mini-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; background: #eee; }
    .quick-points { margin-left: auto; text-align: center; border-left: 1px solid #eee; padding-left: 15px; }
    .shop-list-container { padding: 0 15px; }
    .shop-card { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; padding: 10px; }
    .shop-thumb { width: 80px; height: 80px; border-radius: 8px; background-size: cover; background-position: center; flex-shrink: 0; }
    .shop-info { padding-left: 15px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .shop-name { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .btn-visit { background: #333; color: var(--gold); border: none; padding: 4px 12px; border-radius: 20px; font-size: 12px; }
    /* æœƒå“¡ä¸­å¿ƒ CSS */
    .member-header-bg { background-color: var(--bg); height: 80px; }
    .premium-card { margin: -60px 15px 15px 15px; background: linear-gradient(135deg, #2b2b2b, #1a1a1a); border-radius: 16px; padding: 20px; color: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; overflow: hidden; }
    .card-user-row { display: flex; align-items: center; margin-bottom: 25px; }
    .card-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); margin-right: 12px; }
    .card-name { font-size: 18px; font-weight: bold; color: var(--gold); }
    .card-stats-row { display: flex; justify-content: space-between; text-align: center; }
    .stat-num { font-size: 20px; font-weight: bold; display: block; margin-bottom: 4px; }
    .service-section { background: #fff; margin: 0 15px 15px 15px; border-radius: 12px; padding: 20px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    .service-item { text-align: center; }
    .service-icon { font-size: 24px; color: #555; margin-bottom: 5px; }
    .history-section { padding: 0 15px 20px 15px; }
    .history-simple-item { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    /* è¨‚å–®è©³æƒ… */
    #order-detail-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #F5F6F7; z-index: 300; overflow-y: auto; display: flex; flex-direction: column; }
    .od-navbar { background: #fff; padding: 15px; display: flex; align-items: center; font-weight: bold; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .od-card { background: #fff; border-radius: 12px; padding: 20px; margin: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    /* ç·¨è¼¯å½ˆçª— */
    #edit-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 400; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #fff; width: 80%; border-radius: 16px; padding: 20px; }
    .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; }
    .modal-actions { display: flex; gap: 10px; }
    .btn-cancel, .btn-save { flex: 1; padding: 10px; border-radius: 20px; text-align: center; cursor: pointer; }
    .btn-cancel { border: 1px solid #ddd; background: #fff; }
    .btn-save { background: var(--primary); color: #fff; font-weight: bold; }

    /* ==================== ğŸ”¥ æ–°å¢ï¼šå‹•æ…‹æ’ç‰ˆ CSS (Shop) ==================== */
    #shop-view { background: #f8f9fa; }
    #banner { width: 100%; height: 200px; background-size: cover; background-position: center; position: relative; }
    #shop-title-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 20px; color: white; }
    
    /* æ¨¡å¼ A: é¤é£²åˆ—è¡¨ (Food List) */
    .menu-list-food .menu-item { 
      background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; 
      display: flex; justify-content: space-between; align-items: center; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
    }
    
    /* æ¨¡å¼ B: é›¶å”®ç¶²æ ¼ (Retail Grid) */
    .menu-list-retail { 
      display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; 
    }
    .menu-list-retail .menu-item { 
      background: white; border-radius: 12px; overflow: hidden; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
      display: flex; flex-direction: column; padding: 0;
    }
    .menu-item-img { height: 120px; background-color: #eee; background-size: cover; background-position: center; }
    .menu-item-content { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    
    .stepper button { width: 28px; height: 28px; border-radius: 50%; border: none; }
    .btn-plus { background: var(--primary); color: white; }
    
    #cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 100; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
    #checkout-btn { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 30px; font-weight: bold; }

    /* ==================== ğŸ”¥ æ–°å¢ï¼šæœå‹™é¸æ“‡å½ˆçª— (Service Modal) ==================== */
    #service-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 500; display: flex; align-items: flex-end; justify-content: center; }
    .service-sheet { background: #fff; width: 100%; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; }
    .service-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
    .service-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .service-option { padding: 15px; border: 2px solid #eee; border-radius: 12px; font-weight: bold; text-align: center; cursor: pointer; transition: all 0.2s; }
    .service-option.selected { border-color: var(--primary); color: var(--primary); background: rgba(6, 199, 85, 0.05); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

  </style>
</head>
<body>

  <div id="loading">è¼‰å…¥ä¸­...</div>
  <div id="error-box" class="hidden"></div>

  <div id="lobby-view" class="hidden">
    <div class="lobby-header-bg">
      <div style="font-weight:bold; letter-spacing:1px; font-size:12px; opacity:0.8;">UNI-S PLATFORM</div>
      <div style="font-size:20px; font-weight:bold; margin-top:5px; color:#fff;">æ¢ç´¢ç¾å¥½ç”Ÿæ´»</div>
    </div>
    <div class="float-member-card" onclick="switchTab('member')">
      <img id="home-avatar" src="" class="mini-avatar">
      <div class="user-greeting"><h3><span id="home-name">...</span></h3><p>é»æ“ŠæŸ¥çœ‹æœƒå“¡æ¬Šç›Š â€º</p></div>
      <div class="quick-points"><span class="num" id="home-points">0</span><span class="label">ç©åˆ†</span></div>
    </div>
    <div id="shop-list" class="shop-list-container" style="margin-top:20px;"></div>
  </div>

  <div id="coupons-view" class="hidden">
    <div style="padding:20px; text-align:center; color:#999;">å„ªæƒ åˆ¸åŠŸèƒ½é–‹ç™¼ä¸­...</div>
  </div>

  <div id="member-view" class="hidden">
    <div class="member-header-bg"></div>
    <div class="premium-card">
      <div class="card-user-row">
        <img id="m-avatar" src="" class="card-avatar">
        <div style="flex:1;"><div id="m-name" class="card-name">...</div><div id="m-level" class="card-level-tag">æ™®é€šæœƒå“¡</div></div>
        <i class="fas fa-edit" onclick="openEditModal()" style="font-size:20px; color:var(--gold); opacity:0.8; cursor:pointer;"></i>
      </div>
      <div class="card-stats-row">
        <div class="stat-box"><span class="stat-num">0</span><span class="stat-label">é¤˜é¡</span></div>
        <div class="stat-box"><span class="stat-num" id="m-points">0</span><span class="stat-label">ç©åˆ†</span></div>
        <div class="stat-box"><span class="stat-num">2</span><span class="stat-label">å„ªæƒ åˆ¸</span></div>
      </div>
    </div>
    <div class="service-section">
      <div class="service-item"><div class="service-icon"><i class="fas fa-gift"></i></div><div class="service-label">ç©åˆ†å…Œæ›</div></div>
      <div class="service-item"><div class="service-icon"><i class="fas fa-headset"></i></div><div class="service-label">è¯ç¹«å®¢æœ</div></div>
      <div class="service-item"><div class="service-icon"><i class="fas fa-question-circle"></i></div><div class="service-label">å¸¸è¦‹å•é¡Œ</div></div>
      <div class="service-item"><div class="service-icon"><i class="fas fa-info-circle"></i></div><div class="service-label">é—œæ–¼æˆ‘å€‘</div></div>
    </div>
    <div class="history-section">
      <div style="font-weight:bold; margin-bottom:10px;">æœ€è¿‘è¨‚å–®</div>
      <div id="history-loading" style="text-align:center; color:#999; font-size:12px;">è¼‰å…¥ä¸­...</div>
      <div id="history-list"></div>
    </div>
  </div>

  <div id="order-detail-view" class="hidden">
    <div class="od-navbar"><div class="od-back" onclick="closeOrderDetail()"><i class="fas fa-chevron-left"></i></div><div>è¨‚å–®è©³æƒ…</div></div>
    <div class="od-content">
      <div class="od-card">
        <div class="od-shop-header"><div class="od-shop-name" id="od-shop-name">...</div></div>
        <div class="od-info-row"><span class="od-label">è¨‚å–®ç‹€æ…‹</span><span id="od-status" style="font-weight:bold;">...</span></div>
      </div>
      <div class="od-card">
        <div style="font-weight:bold; margin-bottom:15px;">é¤é»æ˜ç´°</div>
        <div id="od-items-list"></div>
        <div style="border-top:1px solid #f5f5f5; margin-top:10px; padding-top:10px; text-align:right;">
          <span style="font-size:14px;">åˆè¨ˆ</span> <span id="od-total-price" style="font-size:18px; font-weight:bold; color:#D32F2F;">...</span>
        </div>
      </div>
      <div id="od-cancel-container" style="padding: 0 15px 30px 15px;"></div>
    </div>
  </div>

  <div id="edit-modal" class="hidden">
    <div class="modal-content">
      <div class="modal-title">å®Œå–„æœƒå“¡è³‡æ–™</div>
      <div class="form-group"><label class="form-label">çœŸå¯¦å§“å</label><input type="text" id="edit-name" class="form-input"></div>
      <div class="form-group"><label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼</label><input type="tel" id="edit-phone" class="form-input"></div>
      <div class="form-group"><label class="form-label">ç”Ÿæ—¥</label><input type="date" id="edit-birthday" class="form-input"></div>
      <div class="modal-actions"><div class="btn-cancel" onclick="closeEditModal()">å–æ¶ˆ</div><div class="btn-save" onclick="saveProfile()">å„²å­˜</div></div>
    </div>
  </div>

  <div id="service-modal" class="hidden">
    <div class="service-sheet">
      <div class="service-title">è«‹é¸æ“‡æœå‹™æ–¹å¼</div>
      <div id="service-options-container" class="service-options">
        </div>
      <div class="btn-save" onclick="confirmServiceAndSend()">ç¢ºèªä¸‹å–®</div>
      <div style="text-align:center; margin-top:15px; color:#999; font-size:14px; cursor:pointer;" onclick="closeServiceModal()">å–æ¶ˆ</div>
    </div>
  </div>

  <div id="shop-view" class="hidden">
    <button id="back-btn-shop" onclick="goLobby()">â€¹</button>
    <div id="banner"><div id="shop-title-overlay"><h1 id="shop-name-title" style="margin:0; font-size:24px;">...</h1></div></div>
    
    <div id="menu-container" class="container"></div>
    
    <div id="cart-bar">
      <div>ç¸½è¨ˆ $<span id="total-display">0</span></div>
      <button id="checkout-btn" onclick="preCheckout()">å»çµç®— (0)</button>
    </div>
  </div>

  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('lobby')"><div class="tab-icon"><i class="fas fa-home"></i></div><div>é¦–é </div></div>
    <div class="tab-item" onclick="switchTab('coupons')"><div class="tab-icon"><i class="fas fa-ticket-alt"></i></div><div>å„ªæƒ </div></div>
    <div class="tab-item" onclick="switchTab('member')"><div class="tab-icon"><i class="fas fa-user"></i></div><div>æˆ‘çš„</div></div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ ID âš ï¸âš ï¸âš ï¸
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";

    let allShops = {}; let currentShop = null; let cart = {}; let userProfile = null; let orderCache = [];
    let selectedService = ""; // å­˜ä½¿ç”¨è€…é¸çš„æœå‹™

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        updateUI();

        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        const shopId = new URLSearchParams(window.location.search).get('id');
        const targetTab = new URLSearchParams(window.location.search).get('tab');

        if (shopId && allShops[shopId]) { openShop(shopId); } 
        else if (targetTab === 'member') { renderLobby(allShops); switchTab('member'); }
        else { renderLobby(allShops); switchTab('lobby'); }
        
        fetchMemberData(); 

      } catch (err) { showError(err.message); }
    }

    function updateUI() {
      ['home-name','m-name'].forEach(id => document.getElementById(id).innerText = userProfile.displayName);
      ['home-avatar','m-avatar'].forEach(id => document.getElementById(id).src = userProfile.pictureUrl);
    }

    function switchTab(tab) {
      ['lobby-view', 'coupons-view', 'member-view', 'shop-view', 'order-detail-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('tab-bar').classList.remove('hidden');
      document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
      
      if (tab === 'lobby') {
        document.getElementById('lobby-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[0].classList.add('active');
        fetchMemberData();
      } else if (tab === 'coupons') {
        document.getElementById('coupons-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[1].classList.add('active');
      } else if (tab === 'member') {
        document.getElementById('member-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[2].classList.add('active');
        fetchMemberData();
        loadOrderHistory();
      }
    }

    async function fetchMemberData() {
      try {
        const res = await fetch(`${API_URL}?action=getMember&userId=${userProfile.userId}`);
        const data = await res.json();
        let points = data.points || 0;
        document.getElementById('m-points').innerText = points;
        document.getElementById('home-points').innerText = points;
        if(data.name && data.name !== "æœƒå“¡") {
           ['home-name','m-name'].forEach(id => document.getElementById(id).innerText = data.name);
        }
        window.currentMemberData = data;
      } catch(e) { console.error(e); }
    }

    async function loadOrderHistory() {
      const listDiv = document.getElementById('history-list');
      const loading = document.getElementById('history-loading');
      listDiv.innerHTML = ''; loading.style.display = 'block';
      try {
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", userId: userProfile.userId }) });
        orderCache = await res.json();
        loading.style.display = 'none';
        
        if (orderCache.length === 0) { listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">æš«ç„¡è¨‚å–®</div>'; return; }
        
        let html = '';
        orderCache.forEach((order, idx) => {
          let totalPrice = '';
          if (order.content.includes('ç¸½é‡‘é¡ï¼š')) totalPrice = order.content.split('ç¸½é‡‘é¡ï¼š')[1].split('\n')[0].replace('å…ƒ','').trim();
          let statusClass = 'status-wait';
          if (order.status.includes('å·²æ¥å–®')) statusClass = 'status-ok';
          if (order.status.includes('å·²å©‰æ‹’') || order.status.includes('å·²å–æ¶ˆ')) statusClass = 'status-no';

          html += `
            <div class="history-simple-item" onclick="openOrderDetail(${idx})">
              <div class="hs-info">
                <div class="hs-shop">${order.shopName}</div>
                <div class="hs-date">${order.time}</div>
                <div class="hs-status ${statusClass}">${order.status}</div>
              </div>
              <div class="hs-price">${totalPrice}</div>
              <div class="hs-arrow">â€º</div>
            </div>`;
        });
        listDiv.innerHTML = html;
      } catch(e) { loading.style.display = 'none'; }
    }

    function openOrderDetail(index) {
      const orderData = orderCache[index];
      if (!orderData) return;
      document.getElementById('tab-bar').classList.add('hidden');
      ['lobby-view', 'coupons-view', 'member-view', 'shop-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('order-detail-view').classList.remove('hidden');
      
      document.getElementById('od-shop-name').innerText = orderData.shopName;
      document.getElementById('od-status').innerText = orderData.status;
      
      let itemsHtml = ''; let total = '';
      const lines = orderData.content.split('\n');
      lines.forEach(line => {
        if (line.includes('ç¸½é‡‘é¡ï¼š')) total = line.replace('ç¸½é‡‘é¡ï¼š','').replace('----------------','').trim();
        else if (!line.includes('---') && !line.includes('è¯çµ¡é›»è©±') && !line.includes('æœå‹™æ–¹å¼') && line.trim() !== '') {
           let parts = line.split(' x ');
           if (parts.length >= 2) {
             itemsHtml += `<div class="od-item"><div class="od-item-name">${parts[0]}</div><div class="od-item-qty">x${parts[1].split(' ')[0]}</div><div class="od-item-price">${parts[1].split('(')[1]?.replace(')','') || ''}</div></div>`;
           }
        }
      });
      document.getElementById('od-items-list').innerHTML = itemsHtml;
      document.getElementById('od-total-price').innerText = total;

      const cancelContainer = document.getElementById('od-cancel-container');
      if (orderData.status.includes("å¾…ç¢ºèª")) {
        cancelContainer.innerHTML = `<button onclick="cancelOrder('${orderData.orderId}')" style="width:100%; padding:12px; border:1px solid #D32F2F; background:#fff; color:#D32F2F; border-radius:30px; font-weight:bold; margin-top:20px;">å–æ¶ˆè¨‚å–®</button>`;
      } else { cancelContainer.innerHTML = ''; }
    }

    function closeOrderDetail() {
      document.getElementById('order-detail-view').classList.add('hidden');
      document.getElementById('member-view').classList.remove('hidden');
      document.getElementById('tab-bar').classList.remove('hidden');
    }

    // ç·¨è¼¯è³‡æ–™ç›¸é—œ
    function openEditModal() {
      const data = window.currentMemberData || {};
      document.getElementById('edit-name').value = data.name || userProfile.displayName;
      document.getElementById('edit-phone').value = data.phone || localStorage.getItem("uni_user_phone") || "";
      if (data.birthday) { try { document.getElementById('edit-birthday').value = new Date(data.birthday).toISOString().split('T')[0]; } catch(e){} }
      document.getElementById('edit-modal').classList.remove('hidden');
    }
    function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
    async function saveProfile() {
      const name = document.getElementById('edit-name').value;
      const phone = document.getElementById('edit-phone').value;
      const birthday = document.getElementById('edit-birthday').value;
      if (!name || !phone) { alert("å§“åèˆ‡é›»è©±ç‚ºå¿…å¡«"); return; }
      const btn = document.querySelector('.btn-save'); btn.innerText = "å„²å­˜ä¸­...";
      try {
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: "updateProfile", userId: userProfile.userId, name: name, phone: phone, birthday: birthday }) });
        alert("è³‡æ–™æ›´æ–°æˆåŠŸï¼"); localStorage.setItem("uni_user_phone", phone); closeEditModal(); fetchMemberData();
      } catch(e) { alert("æ›´æ–°å¤±æ•—"); } finally { btn.innerText = "å„²å­˜"; }
    }

    // å¤§å»³èˆ‡é»é¤
    function renderLobby(shops) {
      const list = document.getElementById('shop-list');
      let html = '';
      Object.keys(shops).forEach(id => {
        const s = shops[id];
        // é¡¯ç¤ºè©²åº—çš„æœå‹™æ¨™ç±¤ (å–å‰2å€‹)
        let tagsHtml = '';
        if(s.services && s.services.length > 0) {
           s.services.slice(0,2).forEach(svc => tagsHtml += `<span style="font-size:10px;background:#eee;padding:2px 6px;border-radius:4px;margin-right:4px;">${svc}</span>`);
        }
        html += `
          <div class="shop-card" onclick="openShop('${id}', true)">
            <div class="shop-thumb" style="background-image:url(${s.bannerUrl})"></div>
            <div class="shop-info"><div class="shop-name">${s.name}</div><div style="margin-bottom:5px;">${tagsHtml}</div><div class="shop-action"><button class="btn-visit">å»é€›é€›</button></div></div>
          </div>`;
      });
      list.innerHTML = html;
    }

    function openShop(id, pushHistory=false) {
      currentShop = allShops[id]; currentShop.id = id; cart = {};
      if(pushHistory) { const url = new URL(window.location); url.searchParams.set('id', id); window.history.pushState({}, '', url); }
      document.getElementById('tab-bar').classList.add('hidden'); ['lobby-view','coupons-view','member-view'].forEach(id=>document.getElementById(id).classList.add('hidden')); document.getElementById('shop-view').classList.remove('hidden');
      
      document.getElementById('shop-name-title').innerText = currentShop.name;
      document.getElementById('banner').style.backgroundImage = `url(${currentShop.bannerUrl})`;
      document.getElementById('total-display').innerText = '0';
      const btn = document.getElementById('checkout-btn'); btn.innerText = 'å»çµç®— (0)'; btn.classList.remove('active'); btn.style.backgroundColor = '#ccc';
      
      const container = document.getElementById('menu-container'); // ä¿®æ­£ï¼šæŠ“å–å®¹å™¨
      if (!container) return; // é˜²å‘†

      // ğŸ”¥ å‹•æ…‹æ’ç‰ˆï¼šæ ¹æ“š type æ±ºå®š class
      if (currentShop.type === 'retail') {
        // é›¶å”®ç‰ˆï¼šç¶²æ ¼åœ–ç‰‡
        container.className = 'menu-list-retail';
        let html = '';
        currentShop.menu.forEach((item, idx) => {
          // é€™è£¡å‡è¨­ item.img å­˜åœ¨ï¼Œå¦‚æœæ²’æœ‰å°±ç”¨é è¨­åœ–
          let img = item.img || currentShop.bannerUrl; 
          html += `
            <div class="menu-item">
              <div class="menu-item-img" style="background-image:url(${img})"></div>
              <div class="menu-item-content">
                <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${item.name}</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <span style="color:#e64a19; font-weight:bold;">$${item.price}</span>
                  <div class="stepper"><button class="btn-plus" onclick="upd('${item.name}',${item.price},1)">+</button></div>
                </div>
              </div>
            </div>`;
        });
        container.innerHTML = html;
      } else {
        // é¤é£²ç‰ˆï¼šåˆ—è¡¨
        container.className = 'menu-list-food';
        let html = '';
        currentShop.menu.forEach((item, idx) => {
          html += `
            <div class="menu-item">
              <div><span style="font-weight:bold;display:block;">${item.name}</span><span style="color:#e64a19;font-weight:bold;">$${item.price}</span></div>
              <div class="stepper"><button style="background:#eee;" onclick="upd('${item.name}',${item.price},-1)">âˆ’</button><span class="count" id="c-${idx}" style="margin:0 10px; font-weight:bold;">0</span><button class="btn-plus" style="background:${currentShop.themeColor}" onclick="upd('${item.name}',${item.price},1)">+</button></div>
            </div>`;
        });
        container.innerHTML = html;
      }
    }

    function upd(n,p,c) {
      if(!cart[n]) cart[n]=0; cart[n]+=c; if(cart[n]<0) cart[n]=0;
      const items = currentShop.menu; let total=0, count=0;
      items.forEach((i, idx) => {
        // å¦‚æœæ˜¯é›¶å”®ç‰ˆï¼Œå¯èƒ½æ²’æœ‰ ID counté¡¯ç¤ºï¼Œé€™è£¡åšå€‹ç°¡å–®åˆ¤æ–·
        let el = document.getElementById(`c-${idx}`);
        if(i.name===n && el) el.innerText = cart[n];
        if(cart[i.name]) { total+=cart[i.name]*i.price; count+=cart[i.name]; }
      });
      document.getElementById('total-display').innerText = total;
      const btn = document.getElementById('checkout-btn'); btn.innerText = `å»çµç®— (${count})`;
      if(count>0) { btn.classList.add('active'); btn.style.backgroundColor = currentShop.themeColor; } else { btn.classList.remove('active'); btn.style.backgroundColor = '#ccc'; }
    }

    // ğŸ”¥ æº–å‚™çµå¸³ï¼šé¡¯ç¤ºæœå‹™é¸æ“‡
    function preCheckout() {
      let total = 0;
      for (let qty of Object.values(cart)) total += qty;
      if (total === 0) { alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }

      // è®€å–è©²åº—çš„æœå‹™é¸é …
      const services = currentShop.services || ["é è¨­æœå‹™"];
      const container = document.getElementById('service-options-container');
      container.innerHTML = '';
      
      // ç”Ÿæˆé¸é …æŒ‰éˆ•
      services.forEach((svc, idx) => {
        let div = document.createElement('div');
        div.className = 'service-option';
        div.innerText = svc;
        div.onclick = function() {
          document.querySelectorAll('.service-option').forEach(el => el.classList.remove('selected'));
          div.classList.add('selected');
          selectedService = svc;
        };
        // é è¨­é¸ç¬¬ä¸€å€‹
        if (idx === 0) div.click();
        container.appendChild(div);
      });

      document.getElementById('service-modal').classList.remove('hidden');
    }

    function closeServiceModal() { document.getElementById('service-modal').classList.add('hidden'); }

    async function confirmServiceAndSend() {
      closeServiceModal();
      
      let detail = "", total = 0;
      for (let [n, q] of Object.entries(cart)) { if (q>0) { let i = currentShop.menu.find(x=>x.name===n); let s = i.price*q; detail+=`${n} x ${q} ($${s})\n`; total+=s; } }
      detail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ`;
      
      // åŠ å…¥æœå‹™æ–¹å¼
      detail += `\næœå‹™æ–¹å¼ï¼š${selectedService}`;

      let phone = localStorage.getItem("uni_user_phone");
      if (!phone) { phone = prompt("è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼š"); if(!phone) return; localStorage.setItem("uni_user_phone", phone); }
      detail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${phone}`;

      const btn = document.getElementById('checkout-btn'); btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
      try {
        await liff.sendMessages([{type:"text", text:`ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº† (${selectedService})ï¼š\n\n${detail}`}]);
        await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({shopId:currentShop.id, userName:userProfile.displayName, userId:userProfile.userId, order:detail})});
        alert("âœ… è¨‚å–®å·²é€å‡ºï¼"); goLobby();
      } catch(e) { alert("å¤±æ•—: "+e.message); btn.innerText = "é‡è©¦"; btn.disabled = false; }
    }

    async function cancelOrder(id) { /* åŒä¸Šï¼Œçœç•¥é‡è¤‡ä»£ç¢¼ */ 
      if (!confirm("ç¢ºå®šè¦å–æ¶ˆé€™ç­†è¨‚å–®å—ï¼Ÿ")) return;
      try {
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: "cancelOrder", orderId: id, userId: userProfile.userId }) });
        setTimeout(() => { alert("å·²é€å‡ºå–æ¶ˆè«‹æ±‚ã€‚"); closeOrderDetail(); loadOrderHistory(); }, 1000);
      } catch (e) { alert("éŒ¯èª¤ï¼š" + e.message); }
    }

    function goLobby() { const url = new URL(window.location); url.searchParams.delete('id'); window.history.pushState({}, '', url); switchTab('lobby'); }
    function showError(m) { document.getElementById('loading').classList.add('hidden'); document.getElementById('error-box').classList.remove('hidden'); document.getElementById('error-box').innerText = m; }

    main();
  </script>
</body>
</html>

