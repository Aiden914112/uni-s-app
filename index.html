<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S Tea é»é¤</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- å¼•å…¥ Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* ==================== 0. å…¨å±€èˆ‡é‡ç½® (CHAGEE Standard) ==================== */
    :root { 
      --primary: #B33C3A; /* å“ç‰Œæœ±ç ‚ç´… */
      --gold: #C9A05C;    /* ç²¾ç…‰é‡‘ */ 
      --bg: #FFFFFF;      /* ç´”ç™½èƒŒæ™¯ */ 
      --text: #212121;    /* æ·±é‚ƒé»‘ */ 
      --tea-sidebar: #F7F7F7; 
      --danger: #B33C3A;  
      --success: #7A8B69; 
      --light-bg: #FAFAFA;
      --border: #F0F0F0;
    }

    body { 
      font-family: 'Noto Sans TC', sans-serif; 
      padding: 0; margin: 0; 
      background-color: var(--bg); 
      color: var(--text); 
      touch-action: manipulation; 
      -webkit-user-select: none; user-select: none; 
      height: 100vh; overflow: hidden; display: flex; flex-direction: column; 
    }
    
    h1, h2, h3, .shop-name, .coupon-val, .spec-header .title, .od-shop-name, .k-shop-name {
      font-family: 'Noto Serif TC', serif; 
    }

    .hidden { display: none !important; }
    #loading { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; justify-content: center; align-items: center; color: var(--primary); flex-direction: column; }

    /* ==================== 1. CHAGEE é ‚éƒ¨ä½ˆå±€ (å…¨æ–°) ==================== */
    .k-header {
        padding: 15px 20px 5px 20px;
        background: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    .mode-switch {
        display: flex;
        align-items: center;
        font-size: 18px;
    }
    .mode-item {
        font-weight: bold;
        color: #999;
        cursor: pointer;
        transition: color 0.2s;
    }
    .mode-item.active {
        color: #000; /* CHAGEE Bold Black */
        font-size: 20px;
    }
    .mode-split {
        margin: 0 10px;
        color: #E0E0E0;
        font-size: 14px;
    }
    .header-tools i {
        font-size: 18px;
        color: #333;
    }

    /* åº—é‹ªè³‡è¨Šå€ */
    .k-shop-info {
        padding: 10px 20px;
        background: #fff;
        position: relative;
        flex-shrink: 0;
    }
    .k-shop-name-row {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
    }
    .k-shop-name {
        font-size: 18px;
        font-weight: bold;
        color: #212121;
        margin-left: 5px;
    }
    .k-distance-row {
        font-size: 12px;
        color: #999;
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .k-friend-order {
        position: absolute;
        right: 20px;
        top: 10px;
        text-align: center;
        cursor: pointer;
    }
    .k-friend-order i {
        display: block;
        font-size: 20px;
        color: var(--gold);
        margin-bottom: 2px;
    }
    .k-friend-order span {
        font-size: 10px;
        color: #666;
    }

    /* å…¬å‘Šæ¨™ç±¤ */
    .k-announcement-row {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        scrollbar-width: none;
    }
    .k-tag {
        border: 1px solid var(--gold);
        color: #8A6D3B; /* Darker Gold for text */
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        white-space: nowrap;
        background: #FFFAF0;
    }

    /* æ»¾å‹•æ©«å¹… (Banner) */
    .k-banner-container {
        padding: 0 20px 15px 20px;
        background: #fff;
        flex-shrink: 0;
    }
    .k-banner-img {
        width: 100%;
        height: 100px; /* æ‰é•·å‹ Banner */
        object-fit: cover;
        border-radius: 8px;
    }

    /* é ‚éƒ¨é¡åˆ¥å°èˆª (Top Categories) */
    .k-top-tabs {
        display: flex;
        padding: 0 10px 10px 10px;
        background: #fff;
        overflow-x: auto;
        scrollbar-width: none;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
        position: sticky;
        top: 0;
        z-index: 40;
    }
    .k-tab-item {
        flex: 0 0 auto;
        padding: 8px 15px;
        font-size: 14px;
        color: #666;
        cursor: pointer;
        font-weight: 500;
        position: relative;
    }
    .k-tab-item.active {
        color: #000;
        font-weight: bold;
        font-size: 15px;
    }
    /* Active Indicator (Underline) */
    .k-tab-item.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 20px;
        height: 3px;
        background: var(--gold);
        border-radius: 3px;
    }

    /* ==================== 2. ä¸»è¦–åœ–å®¹å™¨ ==================== */
    /* èª¿æ•´ body ä½ˆå±€ä»¥é©æ‡‰æ–° Header */
    .shop-body { 
      flex: 1; display: flex; overflow: hidden; position: relative; background: #fff; 
      padding-bottom: 0; 
    }
    
    .menu-sidebar { width: 85px; background: var(--tea-sidebar); overflow-y: auto; scrollbar-width: none; padding-bottom: 80px; }
    .category-item { padding: 20px 5px; font-size: 13px; color: #666; text-align: center; cursor: pointer; position: relative; font-weight: 500; letter-spacing: 1px; }
    .category-item.active { background: #fff; color: #000; font-weight: bold; }
    .category-item.active::before { content: ''; position: absolute; left: 0; top: 18px; bottom: 18px; width: 3px; background: var(--primary); }
    
    .menu-content { 
        flex: 1; overflow-y: auto; 
        padding: 0 15px 150px 15px; 
        scroll-behavior: smooth; 
    }
    
    /* Food Item Styling Refinement */
    .category-title { font-size: 14px; font-weight: bold; color: #000; margin: 20px 0 10px 0; }
    .food-item { display: flex; margin-bottom: 25px; }
    .food-img { width: 90px; height: 90px; border-radius: 6px; background-color: #F5F5F5; background-size: cover; background-position: center; flex-shrink: 0; }
    .food-info { flex: 1; padding-left: 12px; display: flex; flex-direction: column; justify-content: space-between; }
    .food-name { font-size: 15px; font-weight: bold; color: #000; font-family: 'Noto Serif TC'; }
    .food-desc { font-size: 11px; color: #999; margin-top: 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .food-price { color: #000; font-weight: bold; font-family: 'Noto Serif TC'; font-size: 16px; }
    
    /* é¸è¦æ ¼æŒ‰éˆ• (CHAGEE Style: Rounded, Gold/Grey) */
    .btn-select-spec { 
        background: var(--primary); color: white; 
        padding: 4px 12px; border-radius: 15px; 
        font-size: 12px; font-weight: bold; cursor: pointer; 
    }

    /* ==================== 3. åº•éƒ¨èˆ‡è³¼ç‰©è»Š ==================== */
    .cart-bar { 
      position: fixed; bottom: 65px; left: 15px; right: 15px; 
      background: #212121; border-radius: 50px; padding: 0; 
      display: flex; justify-content: space-between; align-items: center; 
      color: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.25); 
      z-index: 900; height: 50px; cursor: pointer; 
    }
    .cart-left { flex: 1; display: flex; align-items: center; padding-left: 20px; }
    .btn-checkout { background: var(--primary); color: #fff; border: none; height: 100%; padding: 0 30px; border-radius: 0 50px 50px 0; font-weight: bold; font-size: 15px; }

    #tab-bar { 
      position: fixed; bottom: 0; left: 0; right: 0; 
      background: #fff; height: 60px; display: flex; 
      border-top: 1px solid #F0F0F0; z-index: 950; 
      padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0; 
    }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; font-size: 10px; cursor: pointer; transition: all 0.2s; }
    .tab-item.active { color: var(--primary); font-weight: bold; }
    .tab-icon { font-size: 22px; margin-bottom: 2px; }

    /* ==================== 4. å…¶ä»–é é¢ (æœƒå“¡/æ­·å²) ==================== */
    /* (æ²¿ç”¨ä¸Šä¸€ç‰ˆçš„æ¨£å¼ï¼Œä¿æŒä¸€è‡´æ€§) */
    .scroll-view { background-color: white; flex: 1; overflow-y: auto; padding-bottom: 80px; }
    .premium-card { margin: 20px; background: linear-gradient(135deg, #2B2B2B, #1A1A1A); border-radius: 12px; padding: 24px; color: #E0E0E0; position: relative; overflow: hidden; }
    .card-avatar { width: 56px; height: 56px; border-radius: 50%; border: 2px solid var(--gold); margin-right: 15px; object-fit: cover; flex-shrink: 0; }
    
    /* å½ˆçª—æ¨£å¼ */
    .spec-header { padding: 20px; display: flex; gap: 15px; border-bottom: 1px solid #F5F5F5; }
    .spec-img { width: 80px; height: 80px; border-radius: 8px; background-color: #eee; background-size: cover; }
    .option-group { margin-bottom: 10px; padding-bottom: 10px; border-bottom: none !important; }
    .option-title { font-weight: bold; margin-bottom: 10px; color: #212121; font-size: 14px; }
    .chip { padding: 6px 15px; background: #F5F5F5; border-radius: 4px; font-size: 12px; color: #666; border: none; cursor: pointer; margin-right: 8px; margin-bottom: 8px; display: inline-block; }
    .chip.selected { background: #FCEEEE; color: var(--primary); font-weight: bold; }

  </style>
</head>
<body>

  <div id="loading">Uni-S è¼‰å…¥ä¸­...</div>

  <!-- Shop View (Main Home - Reconstructed) -->
  <div id="shop-view" class="hidden">
    
    <!-- 1. Top Header -->
    <div class="k-header">
        <div class="mode-switch">
            <span class="mode-item active">å ‚é£Ÿ</span>
            <span class="mode-split">|</span>
            <span class="mode-item">å¤–è³£</span>
        </div>
        <div class="header-tools">
            <i class="fas fa-search" style="margin-right: 15px;"></i>
            <i class="fas fa-ellipsis-h"></i>
        </div>
    </div>

    <!-- 2. Shop Info Area -->
    <div class="k-shop-info">
        <div class="k-shop-name-row">
            <i class="fas fa-star" style="color:var(--gold); font-size:14px; margin-right:6px;"></i>
            <span id="current-shop-name" class="k-shop-name">è¼‰å…¥ä¸­...</span>
            <div id="shop-announcement-btn" onclick="openStoreDetailModal()" style="margin-left: 10px; color: #999; cursor: pointer;"><i class="fas fa-chevron-right"></i></div>
            
            <div class="k-friend-order" onclick="showMsg('å¥½å‹æ‹¼å–®åŠŸèƒ½é–‹ç™¼ä¸­')">
                <i class="fas fa-glass-cheers"></i>
                <span>å¥½å‹æ‹¼å–®</span>
            </div>
        </div>
        <div class="k-distance-row">
            <i class="fas fa-location-arrow" style="margin-right: 5px;"></i>
            <span id="shop-distance">è·æ‚¨ 0.0 km</span>
        </div>
        <div class="k-announcement-row">
             <div class="k-tag" id="anno-1">æŒ‡å®šå•†å“ç‰¹åƒ¹98å…ƒèµ·</div>
             <div class="k-tag" id="anno-2">æ­¡è¿å…‰è‡¨ Uni-S</div>
        </div>
    </div>

    <!-- 3. Banner Carousel -->
    <div class="k-banner-container">
        <!-- Placeholder for rolling banner -->
        <div id="shop-banner" style="width:100%; height:100px; background-size:cover; background-position:center; border-radius:8px; background-image:url('https://images.unsplash.com/photo-1544787219-7f47ccb76574?q=80&w=600');"></div>
    </div>

    <!-- 4. Top Category Tabs -->
    <div class="k-top-tabs">
        <div class="k-tab-item active" onclick="switchCategoryTab('classic', this)">ç¶“å…¸èœå–®</div>
        <div class="k-tab-item" onclick="switchCategoryTab('classic', this)">å€åŸŸå¥—é¤</div>
        <div class="k-tab-item" onclick="switchCategoryTab('classic', this)">ç¾èƒå°ˆå€</div>
        <div class="k-tab-item" onclick="switchCategoryTab('retail', this)">é›¶å”®å‘¨é‚Š</div>
    </div>
    
    <!-- 5. Content Area -->
    <div class="shop-body">
      <!-- Standard Menu -->
      <div class="menu-sidebar" id="food-sidebar"></div>
      <div class="menu-content" id="food-content"></div>
      
      <!-- Retail Grid (Initially hidden) -->
      <div id="mode-retail" class="retail-grid hidden" style="display:none;"></div>
    </div>
    
    <!-- Cart Bar -->
    <div id="cart-bar" class="cart-bar" style="display:none;">
      <div class="cart-left" onclick="openCartModal()">
        <div style="position:relative;margin-right:15px;"><i class="fas fa-shopping-bag" style="font-size:24px;"></i><div class="cart-badge" id="cart-count">0</div></div>
        <div style="font-size:18px;font-weight:bold;">$<span id="cart-total">0</span></div>
      </div>
      <div class="btn-checkout" onclick="preCheckout()">å»çµç®—</div>
    </div>
  </div>

  <!-- Store Detail Modal -->
  <div id="store-detail-modal" class="modal-overlay hidden" onclick="document.getElementById('store-detail-modal').classList.add('hidden')">
    <div class="modal-sheet" style="max-height: 50vh; padding: 20px;" onclick="event.stopPropagation()">
        <div style="text-align: center; font-weight: bold; font-size: 18px; color: #212121; margin-bottom: 20px;">é–€åº—è³‡è¨Š</div>
        <div class="detail-row" style="margin-bottom: 15px;">
            <div style="font-weight: bold; color:#555; font-size: 13px;">é–€åº—å…¬å‘Š</div>
            <p id="modal-announcement" style="font-size: 14px; color:#212121; margin: 5px 0; line-height: 1.5;">...</p>
        </div>
        <div class="detail-row" style="margin-bottom: 15px;">
            <div style="font-weight: bold; color:#555; font-size: 13px;">é–€åº—åœ°å€</div>
            <p id="modal-address" style="font-size: 14px; color:#212121; margin: 5px 0; line-height: 1.5;">...</p>
        </div>
        <div style="display:flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #F5F5F5;">
            <div style="color: #666; font-size: 13px;">è¯ç¹«åº—é•·ï¼š<span id="modal-phone" style="color:#212121; font-weight:bold;">...</span></div>
            <a id="modal-call-btn" href="#" class="btn-nav" style="padding: 8px 20px; font-size: 13px; background: var(--primary); color: white; border:none; text-decoration:none; border-radius:20px;">æ’¥æ‰“</a>
        </div>
    </div>
  </div>

  <!-- History View -->
  <div id="history-view" class="scroll-view hidden">
    <div style="padding:20px 20px 10px 20px; display:flex; align-items:center;">
        <div style="font-weight:bold; font-size:20px; color:#212121;">æ­·å²è¨‚å–®</div>
    </div>
    <div id="history-list-container" style="padding: 20px;"></div>
  </div>

  <!-- Member View -->
  <div id="member-view" class="scroll-view hidden" style="padding-top: 20px;">
    <div class="premium-card">
      <div class="card-user-row">
          <img id="m-avatar" src="" class="card-avatar">
          <div style="flex:1;">
              <div id="m-name" style="font-size:20px;font-weight:bold;color:var(--gold);">...</div>
              <div style="font-size:11px;background:rgba(201, 160, 92, 0.2);color:#E0E0E0;padding:3px 10px;border-radius:12px;display:inline-block;margin-top:6px;border:1px solid rgba(201, 160, 92, 0.3);">æ™®é€šæœƒå“¡</div>
          </div>
          <i class="fas fa-cog" onclick="openEditModal()" style="font-size:20px;color:rgba(255,255,255,0.6);cursor:pointer;"></i>
      </div>
      <div class="card-stats-row">
          <div class="stat-box"><span class="stat-num">0</span><span class="stat-label">é¤˜é¡</span></div>
          <div class="stat-box" style="border-left:1px solid rgba(255,255,255,0.1); border-right:1px solid rgba(255,255,255,0.1);">
              <span class="stat-num" id="m-points">0</span><span class="stat-label">ç©åˆ†</span>
          </div>
          <div class="stat-box"><span class="stat-num">2</span><span class="stat-label">å„ªæƒ åˆ¸</span></div>
      </div>
    </div>
    <div class="service-section">
      <div class="service-item" onclick="switchTab('coupons')">
          <div class="service-icon" style="color:var(--primary);"><i class="fas fa-coins"></i></div>
          <div class="service-label">ç©åˆ†å…Œæ›</div>
      </div>
      <div class="service-item" onclick="showMsg('åŠŸèƒ½é–‹ç™¼ä¸­')"><div class="service-icon"><i class="fas fa-headset"></i></div><div class="service-label">è¯ç¹«å®¢æœ</div></div>
      <div class="service-item" onclick="showMsg('åŠŸèƒ½é–‹ç™¼ä¸­')"><div class="service-icon"><i class="fas fa-question-circle"></i></div><div class="service-label">å¸¸è¦‹å•é¡Œ</div></div>
      <div class="service-item" onclick="showMsg('Uni-S v2.0')"><div class="service-icon"><i class="fas fa-info-circle"></i></div><div class="service-label">é—œæ–¼æˆ‘å€‘</div></div>
    </div>
  </div>

  <!-- Coupons View -->
  <div id="coupons-view" class="scroll-view hidden">
    <div style="padding:20px 20px 10px 20px; display:flex; align-items:center;">
        <div onclick="switchTab('member')" style="font-size:20px; color:#666; cursor:pointer; margin-right:15px;"><i class="fas fa-arrow-left"></i></div>
        <div style="font-weight:bold; font-size:20px;">ç©åˆ†å…Œæ›ä¸­å¿ƒ</div>
    </div>
    <div id="coupons-list" class="coupon-grid" style="padding-top:10px;"></div>
  </div>

  <!-- Modals (Cart, Spec, OrderDetail, Edit) -->
  <div id="cart-modal" class="modal-overlay hidden" onclick="closeCartModal()">
    <div class="modal-sheet" style="padding:0;" onclick="event.stopPropagation()">
      <div class="cart-header"><div style="font-weight:bold;font-size:16px;">è³¼ç‰©è»Šå…§å®¹</div><div onclick="closeCartModal()" style="cursor:pointer;padding:5px;"><i class="fas fa-chevron-down"></i></div></div>
      <div style="background:#FAFAFA;padding:10px 20px;font-size:12px;color:#888;display:flex;justify-content:space-between;align-items:center;"><span>å·²é¸å•†å“</span><span onclick="clearCart()" style="cursor:pointer;color:#B33C3A;"><i class="fas fa-trash"></i> æ¸…ç©º</span></div>
      <div id="cart-list" class="cart-list"></div>
      <div style="height:20px;"></div>
    </div>
  </div>

  <div id="spec-modal" class="modal-overlay hidden">
    <div class="modal-sheet">
      <div style="text-align:right;padding:15px;"><i class="fas fa-times" onclick="closeSpecModal()" style="font-size:22px;color:#ccc;cursor:pointer;"></i></div>
      <div class="spec-header"><div class="spec-img" id="sp-img"></div><div><div class="title" style="font-size:20px;font-weight:bold;" id="sp-name"></div><div style="font-size:13px;color:#888;margin-top:5px;" id="sp-desc"></div></div></div>
      <div id="sp-options" class="spec-options"></div>
      <div class="spec-footer" style="padding:15px 20px; border-top:1px solid #F0F0F0;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;"><div style="font-size:22px;font-weight:bold;color:var(--primary);font-family:'Noto Serif TC';">$<span id="sp-price">0</span></div><div class="stepper"><button onclick="updateSpQty(-1)">-</button><span id="sp-qty" style="margin:0 10px;font-weight:bold;">1</span><button onclick="updateSpQty(1)">+</button></div></div>
        <div class="spec-add-btn" onclick="addSpecToCart()">åŠ å…¥è³¼ç‰©è»Š</div>
      </div>
    </div>
  </div>

  <div id="service-modal" class="modal-overlay hidden">
    <div class="modal-sheet">
      <div style="padding:25px;">
        <div style="text-align:center;font-weight:bold;font-size:18px;margin-bottom:20px;">é¸æ“‡æœå‹™æ–¹å¼</div>
        <div id="service-options"></div>
        <div style="margin-top:25px;"><div style="font-weight:bold;margin-bottom:10px;">å„ªæƒ åˆ¸</div><select id="coupon-selector" style="width:100%;padding:12px;border-radius:4px;border:1px solid #E0E0E0;outline:none;"><option value="">ä¸ä½¿ç”¨å„ªæƒ åˆ¸</option></select></div>
        <div style="margin-top:25px;text-align:right;"><span style="font-size:14px;color:#888;">å¯¦ä»˜é‡‘é¡</span><span id="final-checkout-price" style="font-size:24px;font-weight:bold;color:var(--danger);margin-left:8px;">$0</span></div>
        <div class="spec-add-btn" style="text-align:center;margin-top:20px;" onclick="confirmOrder()">ç¢ºèªä¸‹å–®</div>
        <div style="text-align:center;margin-top:15px;color:#999;font-size:13px;cursor:pointer;" onclick="document.getElementById('service-modal').classList.add('hidden')">å–æ¶ˆ</div>
      </div>
    </div>
  </div>

  <div id="order-detail-view" class="hidden">
    <div class="od-paper">
      <div class="od-header"><div class="od-shop-name" id="od-shop-name">...</div><div class="od-id">å–®è™Ÿï¼š<span id="od-id"></span></div><div style="margin-top:10px;"><span id="od-status" style="font-weight:bold;font-size:13px;padding:3px 8px;border-radius:4px;background:#eee;">...</span></div></div>
      <div class="od-scroll-content" id="od-items-list"></div>
      <div style="padding:20px;background:#fff;"><div class="od-total-section"><span class="od-total-label">ç¸½è¨ˆé‡‘é¡</span><span class="od-total-val" id="od-total-price">...</span></div><div id="od-cancel-container" style="margin-top:20px;"></div></div>
      <div class="od-footer"><button class="btn-close-od" onclick="closeOrderDetail()"><i class="fas fa-times"></i></button></div>
    </div>
  </div>

  <!-- Tab Bar -->
  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('menu')"><div class="tab-icon"><i class="fas fa-home"></i></div><div>é¦–é </div></div>
    <div class="tab-item" onclick="switchTab('menu')"><div class="tab-icon"><i class="fas fa-mug-hot"></i></div><div>é»å–®</div></div>
    <div class="tab-item" onclick="switchTab('history')"><div class="tab-icon"><i class="fas fa-receipt"></i></div><div>å–èŒ¶</div></div>
    <div class="tab-item" onclick="switchTab('member')"><div class="tab-icon"><i class="fas fa-crown"></i></div><div>æœƒå“¡</div></div>
    <div class="tab-item" onclick="switchTab('member')"><div class="tab-icon"><i class="fas fa-user"></i></div><div>æˆ‘çš„</div></div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ è¨­å®šå€ âš ï¸âš ï¸âš ï¸
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";
    const TARGET_SHOP_ID = "1"; 

    // ç‹€æ…‹
    let allShops = {}; let currentShop = null; let cart = []; 
    let userProfile = null; let orderCache = []; let selectedService = "";
    let currentItem = null; let currentOptions = {}; let currentQty = 1;
    let userLocation = null;
    let myCoupons = []; 

    // Init
    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        userProfile = await liff.getProfile();
        updateUI();

        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        if (allShops[TARGET_SHOP_ID]) {
            openShop(TARGET_SHOP_ID);
        } else {
            showMsg("åº—å®¶è¨­å®šéŒ¯èª¤");
        }
        
        // å–å¾—ä½ç½® (LBS)
        await initLocationService();
        if(userLocation && currentShop && currentShop.lat) {
            const dist = calculateDistance(userLocation.lat, userLocation.lng, currentShop.lat, currentShop.lng);
            document.getElementById('shop-distance').innerText = `è·æ‚¨ ${dist} km`;
        }

        fetchMemberData();
      } catch (err) { showMsg(err.message); }
    }

    // æ›´æ–°é ‚éƒ¨é¡åˆ¥å°èˆª
    function switchCategoryTab(type, el) {
        document.querySelectorAll('.k-tab-item').forEach(e => e.classList.remove('active'));
        el.classList.add('active');

        if (type === 'retail') {
            document.getElementById('food-sidebar').style.display = 'none';
            document.getElementById('food-content').style.display = 'none';
            document.getElementById('mode-retail').style.display = 'grid';
            document.getElementById('mode-retail').classList.remove('hidden');
        } else {
            document.getElementById('mode-retail').style.display = 'none';
            document.getElementById('food-sidebar').style.display = 'block';
            document.getElementById('food-content').style.display = 'block';
        }
    }

    // è·¯ç”±æ§åˆ¶
    function switchTab(tab) {
        ['coupons-view', 'member-view', 'shop-view', 'history-view', 'order-detail-view'].forEach(id => {
             document.getElementById(id).classList.add('hidden');
        });
        document.getElementById('tab-bar').classList.remove('hidden');
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        
        if (tab === 'menu') {
            document.getElementById('shop-view').classList.remove('hidden');
            document.querySelectorAll('.tab-item')[0].classList.add('active'); // é¦–é 
            document.querySelectorAll('.tab-item')[1].classList.add('active'); // é»å–®
        } else if (tab === 'history') {
            document.getElementById('history-view').classList.remove('hidden');
            document.querySelectorAll('.tab-item')[2].classList.add('active'); // å–èŒ¶
            loadOrderHistory();
        } else if (tab === 'member') {
            document.getElementById('member-view').classList.remove('hidden');
            document.querySelectorAll('.tab-item')[3].classList.add('active'); // æœƒå“¡
            document.querySelectorAll('.tab-item')[4].classList.add('active'); // æˆ‘çš„
            fetchMemberData();
            loadMyCoupons();
        } else if (tab === 'coupons') {
            document.getElementById('tab-bar').classList.add('hidden');
            document.getElementById('coupons-view').classList.remove('hidden');
            loadCoupons();
        }
    }

    function openShop(id) { 
        currentShop = allShops[id]; 
        currentShop.id = id; 
        cart = []; updateCartUI(); 

        ['coupons-view','member-view','history-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('shop-view').classList.remove('hidden');
        document.getElementById('tab-bar').classList.remove('hidden');
        
        // Populate CHAGEE Header
        document.getElementById('current-shop-name').innerText = currentShop.name;
        document.getElementById('shop-address').innerText = currentShop.address || "";
        document.getElementById('modal-address').innerText = currentShop.address || "";
        document.getElementById('modal-announcement').innerText = currentShop.openHours || "ç‡Ÿæ¥­æ™‚é–“ï¼š09:00-22:00";
        document.getElementById('modal-phone').innerText = "188****6289"; // Mock

        if (currentShop.bannerUrl) {
            document.getElementById('shop-banner').style.backgroundImage = `url(${currentShop.bannerUrl})`;
        }
        
        renderFoodMenu();
        renderRetailMenu();
    }

    // ... (ä¿ç•™å…±ç”¨ Helper å‡½æ•¸: showMsg, calculateDistance, openSpecModal ç­‰ï¼Œé‚è¼¯ä¸è®Š) ...
    // ç‚ºç¯€çœç¯‡å¹…ï¼Œæ­¤è™•çœç•¥æœªè®Šå‹•çš„å‡½æ•¸ï¼Œè«‹ä½¿ç”¨ä¸Šä¸€ç‰ˆçš„å°æ‡‰å‡½æ•¸ã€‚
    // (ä¾‹å¦‚ openSpecModal, updateCartUI, preCheckout ç­‰é‚è¼¯å‡ç„¡éœ€è®Šå‹•ï¼Œåªéœ€ç¢ºä¿ CSS class å°æ‡‰æ­£ç¢º)
    
    // è£œå…¨é—œéµ Helper
    function updateUI() { 
        const mName = document.getElementById('m-name');
        const mAvatar = document.getElementById('m-avatar');
        if (mName) mName.innerText = userProfile.displayName;
        if (mAvatar) mAvatar.src = userProfile.pictureUrl;
    }
    
    function showMsg(txt, cb, showOk=true) {
        document.getElementById('msg-text').innerText = txt;
        document.getElementById('msg-btn-no').classList.add('hidden');
        document.getElementById('msg-btn-yes').classList.toggle('hidden', !showOk);
        document.getElementById('msg-modal-overlay').classList.remove('hidden');
        modalCb = cb;
    }
    function showLoadingMsg(txt) { showMsg(txt, null, false); }
    function closeMsgModal(isYes) { document.getElementById('msg-modal-overlay').classList.add('hidden'); if(isYes && modalCb) modalCb(); }
    function showConfirm(txt, cb) {
        document.getElementById('msg-text').innerText = txt;
        document.getElementById('msg-btn-no').classList.remove('hidden');
        document.getElementById('msg-btn-yes').classList.remove('hidden');
        document.getElementById('msg-modal-overlay').classList.remove('hidden');
        modalCb = cb;
    }

    // Render Logic
    function renderFoodMenu() { 
        const catList = document.getElementById('food-sidebar'); 
        const prodList = document.getElementById('food-content'); 
        catList.innerHTML = ''; prodList.innerHTML = ''; 
        let menu = Array.isArray(currentShop.menu) && currentShop.menu[0].category ? currentShop.menu : [{category:"å…¨éƒ¨", items:currentShop.menu}]; 
        menu.forEach((cat, idx) => { 
            catList.innerHTML += `<div class="category-item ${idx===0?'active':''}" id="cat-btn-${idx}" onclick="document.getElementById('cat-sec-${idx}').scrollIntoView({behavior:'smooth'})">${cat.category}</div>`; 
            let itemsHtml = ''; 
            cat.items.forEach(item => { 
                let itemJson = JSON.stringify(item).replace(/"/g, '&quot;'); 
                itemsHtml += `
                <div class="food-item" onclick="openSpecModal(${itemJson})">
                    <div class="food-img" style="background-image:url(${item.img||currentShop.bannerUrl})"></div>
                    <div class="food-info">
                        <div><div class="food-name">${item.name}</div><div class="food-desc">${item.desc||''}</div></div>
                        <div class="food-action">
                            <div class="food-price">$${item.price}</div>
                            <div class="btn-select-spec">é¸è¦æ ¼</div>
                        </div>
                    </div>
                </div>`; 
            }); 
            prodList.innerHTML += `<div id="cat-sec-${idx}" class="cat-section"><div class="category-title">${cat.category}</div>${itemsHtml}</div>`; 
        }); 
        prodList.onscroll = function() { const secs = document.querySelectorAll('.cat-section'); secs.forEach((sec,i) => { if(sec.offsetTop - prodList.offsetTop <= prodList.scrollTop + 50) { document.querySelectorAll('.category-item').forEach(e=>e.classList.remove('active')); document.getElementById(`cat-btn-${i}`).classList.add('active'); } }); }; 
    }
    
    function renderRetailMenu() { let html = ''; currentShop.menu.forEach((item, idx) => { let img = item.img || currentShop.bannerUrl; html += `<div class="retail-item"><div class="retail-img" style="background-image:url(${img})"></div><div class="retail-info"><div style="font-weight:bold;font-size:14px;">${item.name}</div><div class="retail-actions" style="display:flex;justify-content:space-between;align-items:center;"><span style="color:#e64a19;font-weight:bold;">$${item.price}</span><div class="stepper-mini"><button onclick="updateCartRetail('${item.name}', ${item.price}, -1)">-</button><span id="r-qty-${idx}" style="font-size:13px;font-weight:bold;margin:0 5px;">0</span><button onclick="updateCartRetail('${item.name}', ${item.price}, 1)">+</button></div></div></div></div>`; }); document.getElementById('mode-retail').innerHTML = html; }

    function openSpecModal(item) { 
        currentItem = item; currentQty = 1; currentOptions = {}; 
        document.getElementById('sp-name').innerText = item.name; 
        document.getElementById('sp-desc').innerText = item.desc||''; 
        document.getElementById('sp-price').innerText = item.price; 
        document.getElementById('sp-img').style.backgroundImage = `url(${item.img||currentShop.bannerUrl})`; 
        document.getElementById('sp-qty').innerText = 1; 
        let html = ''; 
        for (let [k, vals] of Object.entries(item.options||{})) { 
            currentOptions[k] = vals[0]; 
            let chips = vals.map((v,i) => `<div class="chip ${i===0?'selected':''}" onclick="selOpt(this,'${k}','${v}')">${v}</div>`).join(''); 
            html += `<div class="option-group"><div class="option-title">${k}</div><div class="option-chips">${chips}</div></div>`; 
        } 
        document.getElementById('sp-options').innerHTML = html || '<div style="color:#999;font-size:12px;">ç„¡è¦æ ¼é¸é …</div>'; 
        document.getElementById('spec-modal').classList.remove('hidden'); 
    }
    function selOpt(el, k, v) { el.parentNode.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); currentOptions[k] = v; }
    function updateSpQty(n) { if(currentQty+n>0) { currentQty+=n; document.getElementById('sp-qty').innerText=currentQty; document.getElementById('sp-price').innerText=currentItem.price*currentQty; } }
    function addSpecToCart() { let opts = Object.values(currentOptions).join('/'); if(opts) opts = `(${opts})`; cart.push({name: currentItem.name + " " + opts, price: currentItem.price, qty: currentQty, total: currentItem.price*currentQty}); document.getElementById('spec-modal').classList.add('hidden'); updateCartUI(); }
    function updateCartRetail(name, price, change) { let exist = cart.find(x => x.name === name); if(exist) { exist.qty += change; if(exist.qty<=0) cart = cart.filter(x=>x.name!==name); else exist.total = exist.price*exist.qty; } else if(change>0) cart.push({name:name, price:price, qty:1, total:price, opts:""}); updateCartUI(); currentShop.menu.forEach((item,idx) => { let el = document.getElementById(`r-qty-${idx}`); let inCart = cart.find(x=>x.name===item.name); if(el) el.innerText = inCart?inCart.qty:0; }); }
    function updateCartUI() { let totalQty = cart.reduce((a,b)=>a+b.qty,0); let totalPrice = cart.reduce((a,b)=>a+b.total,0); if(totalQty > 0) { document.getElementById('cart-bar').style.display = 'flex'; document.getElementById('cart-count').innerText = totalQty; document.getElementById('cart-total').innerText = totalPrice; } else { document.getElementById('cart-bar').style.display = 'none'; closeCartModal(); } }
    function openCartModal() { if(cart.length===0) { closeCartModal(); return; } const list = document.getElementById('cart-list'); let html = ''; cart.forEach((item, idx) => { html += ` <div class="cart-item"> <div style="flex:1;"> <div style="font-size:15px;font-weight:bold;margin-bottom:4px;">${item.name}</div> <div style="font-size:12px;color:#999;">$${item.price}</div> </div> <div style="display:flex;align-items:center;gap:15px;"> <div style="font-weight:bold;min-width:40px;text-align:right;">$${item.total}</div> <div class="cart-stepper"> <button onclick="updateCartItemQty(${idx}, -1)"><i class="fas fa-minus"></i></button> <span>${item.qty}</span> <button onclick="updateCartItemQty(${idx}, 1)"><i class="fas fa-plus"></i></button> </div> </div> </div>`; }); list.innerHTML = html; document.getElementById('cart-modal').classList.remove('hidden'); }
    function updateCartItemQty(idx, change) { let item = cart[idx]; if(!item) return; item.qty += change; if(item.qty <= 0) { cart.splice(idx, 1); } else { item.total = item.price * item.qty; } updateCartUI(); if(cart.length > 0) { openCartModal(); } else { closeCartModal(); } }
    function closeCartModal() { document.getElementById('cart-modal').classList.add('hidden'); }
    function closeSpecModal() { document.getElementById('spec-modal').classList.add('hidden'); }
    function clearCart() { cart = []; updateCartUI(); }
    function removeCartItem(idx) { cart.splice(idx, 1); updateCartUI(); if(cart.length > 0) openCartModal(); }
    
    // Checkout & Others
    async function preCheckout() {
      if(cart.length===0) { showMsg("è³¼ç‰©è»Šæ˜¯ç©ºçš„"); return; }
      const svcs = currentShop.services || ["è‡ªå–"];
      let html = '';
      svcs.forEach((s,i) => { html += `<div class="service-option ${i===0?'selected':''}" onclick="selSvc(this,'${s}')">${s}</div>`; if(i===0) selectedService = s; });
      document.getElementById('service-options').innerHTML = html;
      const select = document.getElementById('coupon-selector');
      select.innerHTML = '<option value="" data-val="0">ä¸ä½¿ç”¨å„ªæƒ åˆ¸</option>';
      select.onchange = updateFinalPrice; 
      try {
          const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getMyCoupons", userId: userProfile.userId }) });
          const text = await res.text();
          myCoupons = JSON.parse(text);
          myCoupons.forEach(c => {
              let opt = document.createElement('option');
              opt.value = c.uuid;
              opt.setAttribute('data-val', c.value);
              opt.innerText = `${c.name} (æŠ˜æŠµ $${c.value})`;
              select.appendChild(opt);
          });
      } catch(e) {}
      updateFinalPrice();
      document.getElementById('service-modal').classList.remove('hidden');
    }
    function selSvc(el, s) { document.querySelectorAll('.service-option').forEach(e=>e.classList.remove('selected')); el.classList.add('selected'); selectedService = s; }
    function updateFinalPrice() {
        const select = document.getElementById('coupon-selector');
        const discount = parseInt(select.options[select.selectedIndex].getAttribute('data-val') || 0);
        const cartTotal = parseInt(document.getElementById('cart-total').innerText);
        const final = Math.max(0, cartTotal - discount);
        document.getElementById('final-checkout-price').innerText = "$" + final;
    }
    async function confirmOrder() {
      document.getElementById('service-modal').classList.add('hidden');
      const select = document.getElementById('coupon-selector');
      const couponUuid = select.value;
      const discount = parseInt(select.options[select.selectedIndex].getAttribute('data-val') || 0);
      let detail = "", total = 0;
      cart.forEach(x => { detail += `${x.name} x ${x.qty} ($${x.total})\n`; total += x.total; });
      detail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ\næœå‹™æ–¹å¼ï¼š${selectedService}`;
      if (discount > 0) { detail += `\nå„ªæƒ åˆ¸æŠ˜æŠµï¼š-$${discount}\nå¯¦ä»˜é‡‘é¡ï¼š$${Math.max(0, total - discount)}`; }
      let phone = localStorage.getItem("uni_user_phone");
      if(!phone) { phone = prompt("è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼š"); if(!phone) return; localStorage.setItem("uni_user_phone", phone); }
      detail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${phone}`;
      showLoadingMsg("è™•ç†ä¸­...");
      try {
        await liff.sendMessages([{type:"text", text:`ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${detail}`}]);
        await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({ shopId:currentShop.id, userName:userProfile.displayName, userId:userProfile.userId, order:detail, couponUuid: couponUuid })
        });
        showMsg("âœ… è¨‚å–®å·²é€å‡ºï¼", () => { 
            cart=[]; 
            updateCartUI(); 
            switchTab('history'); 
        });
      } catch(e) { showMsg("å¤±æ•—:"+e.message); }
    }
    
    // Init Location Service Helper
    function initLocationService() { return new Promise((resolve) => { if (!navigator.geolocation) { resolve(); return; } const timeoutId = setTimeout(() => { resolve(); }, 5000); navigator.geolocation.getCurrentPosition((position) => { clearTimeout(timeoutId); userLocation = { lat: position.coords.latitude, lng: position.coords.longitude }; resolve(); }, (error) => { clearTimeout(timeoutId); resolve(); }); }); }
    function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = deg2rad(lat2 - lat1); const dLon = deg2rad(lon2 - lon1); const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return (R * c).toFixed(1); }
    function deg2rad(deg) { return deg * (Math.PI/180); }
    
    // Fetch Data
    function loadOrderHistory() {
        document.getElementById('history-list-container').innerHTML = '<div style="text-align:center;color:#999;font-size:12px;">è¼‰å…¥ä¸­...</div>';
        fetch(API_URL, {method:'POST', body:JSON.stringify({action:"getHistory", userId:userProfile.userId})})
        .then(res=>res.json())
        .then(data=>{ 
            orderCache = data; 
            const container = document.getElementById('history-list-container');
            if(orderCache.length===0) { container.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">å°šç„¡è¨‚å–®ç´€éŒ„</div>'; return; } 
            let html = ''; 
            orderCache.forEach((o, i) => { 
                let price = o.content.split('ç¸½é‡‘é¡ï¼š')[1]?.split('\n')[0].replace('å…ƒ','').trim() || ''; 
                let summary = o.content.split('\n').filter(line => !line.includes('ç¸½é‡‘é¡') && !line.includes('---') && !line.includes('é›»è©±') && line.trim() !== '').slice(0, 2).join(', ');
                if (summary.length > 20) summary = summary.substring(0, 20) + '...';
                let statusClass = 'status-wait';
                if (o.status.includes('å·²æ¥å–®')) statusClass = 'status-ok';
                else if (o.status.includes('å©‰æ‹’') || o.status.includes('å–æ¶ˆ')) statusClass = 'status-no';
                html += `<div class="history-card" onclick="openOrderDetail(${i})"><div class="hc-header"><div class="hc-shop">${o.shopName}</div><div class="hc-date">${o.time}</div></div><div class="hc-body"><div class="hc-summary">${summary || 'é»æ“ŠæŸ¥çœ‹è©³æƒ…'}</div><div style="text-align:right;"><div class="hc-price">$${price}</div><div class="hc-status ${statusClass}">${o.status}</div></div></div></div>`; 
            }); 
            container.innerHTML = html; 
        }).catch(e=>{}); 
    }
    
    // Remaining Helpers (My Coupons, Profile etc.)
    function fetchMemberData() { fetch(`${API_URL}?action=getMember&userId=${userProfile.userId}`).then(res=>res.json()).then(data=>{ document.getElementById('m-points').innerText = data.points || 0; document.getElementById('home-points').innerText = data.points || 0; if(data.name && data.name!=="æœƒå“¡") ['home-name','m-name'].forEach(id=>document.getElementById(id).innerText=data.name); window.currentMemberData = data; }).catch(e=>{}); }
    function openEditModal() { const data = window.currentMemberData || {}; document.getElementById('edit-name').value = data.name || userProfile.displayName; document.getElementById('edit-phone').value = data.phone || localStorage.getItem("uni_user_phone") || ""; if (data.birthday) try { document.getElementById('edit-birthday').value = new Date(data.birthday).toISOString().split('T')[0]; } catch(e){} document.getElementById('edit-modal').classList.remove('hidden'); }
    function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
    function saveProfile() { const name = document.getElementById('edit-name').value; const phone = document.getElementById('edit-phone').value; const birthday = document.getElementById('edit-birthday').value; if (!name || !phone) { showMsg("å§“åèˆ‡é›»è©±ç‚ºå¿…å¡«"); return; } const btn = document.querySelector('.btn-save'); btn.innerText = "å„²å­˜ä¸­..."; fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: "updateProfile", userId: userProfile.userId, name: name, phone: phone, birthday: birthday }) }).then(()=>{ showMsg("è³‡æ–™æ›´æ–°æˆåŠŸï¼", () => { localStorage.setItem("uni_user_phone", phone); closeEditModal(); fetchMemberData(); }); }).catch(e=>{ showMsg("æ›´æ–°å¤±æ•—"); }).finally(()=>{ btn.innerText = "å„²å­˜"; }); }

    // Start App
    main();
  </script>
</body>
</html>
