<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Uni-S ç”Ÿæ´»åœˆ</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ====================
       1. å…¨å±€è¨­å®š (æ——è‰¦ç‰ˆé…è‰²)
       ==================== */
    :root {
      --primary-color: #C5A674; /* åƒè€ƒæˆªåœ–çš„å¥¶èŒ¶é‡‘/è³ªæ„Ÿé‡‘ */
      --bg-color: #F7F7F7;
      --text-color: #333;
      --card-bg: #fff;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      padding: 0; margin: 0; background-color: var(--bg-color); 
      touch-action: manipulation; -webkit-user-select: none; user-select: none; 
      padding-bottom: 90px; 
    }
    .hidden { display: none !important; }
    #loading, #error-box { text-align: center; padding: 50px; color: #999; }

    /* ====================
       2. åº•éƒ¨å°èˆªåˆ— (Tab Bar - è³ªæ„Ÿå‡ç´š)
       ==================== */
    #tab-bar { 
      position: fixed; bottom: 0; left: 0; right: 0; 
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
      height: 60px; display: flex; 
      border-top: 1px solid #eee; z-index: 200; 
      padding-bottom: env(safe-area-inset-bottom); 
    }
    .tab-item { 
      flex: 1; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; 
      color: #999; font-size: 10px; cursor: pointer; 
      -webkit-tap-highlight-color: transparent;
    }
    .tab-item.active { color: var(--primary-color); font-weight: bold; }
    .tab-icon { font-size: 20px; margin-bottom: 4px; }

    /* ====================
       3. å¤§å»³æ¨£å¼ (Lobby - åƒè€ƒæˆªåœ–ä½ˆå±€)
       ==================== */
    #lobby-view { padding-bottom: 20px; }
    
    /* é ‚éƒ¨è£é£¾èƒŒæ™¯ */
    .lobby-header-bg {
      background: linear-gradient(135deg, #2c3e50, #000); /* æ·±è‰²è³ªæ„ŸèƒŒæ™¯ */
      height: 180px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
      position: relative; padding: 20px;
    }
    .lobby-brand { color: #C5A674; font-size: 14px; letter-spacing: 2px; font-weight: bold; opacity: 0.8; }

    /* æ‡¸æµ®æœƒå“¡å¡ (åƒè€ƒæˆªåœ–5) */
    .float-member-card {
      background: white; margin: -100px 15px 15px 15px; 
      border-radius: 12px; padding: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      position: relative; display: flex; align-items: center;
    }
    .mini-avatar { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-right: 15px; }
    .user-greeting { flex: 1; }
    .user-greeting h3 { margin: 0; font-size: 16px; color: #333; }
    .user-greeting p { margin: 4px 0 0 0; font-size: 12px; color: #888; display: flex; align-items: center; }
    .level-badge { background: #333; color: #C5A674; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
    
    .quick-points { text-align: center; border-left: 1px solid #eee; padding-left: 15px; }
    .quick-points .num { font-size: 20px; font-weight: bold; color: var(--primary-color); display: block; }
    .quick-points .label { font-size: 10px; color: #999; }

    /* é‡‘å‰›å€ (åŠŸèƒ½åœ–ç¤º - åƒè€ƒæˆªåœ–5) */
    .grid-menu { display: flex; justify-content: space-around; padding: 10px 15px; margin-bottom: 10px; }
    .grid-item { text-align: center; width: 25%; }
    .grid-icon { width: 40px; height: 40px; background: #FFF8E1; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px auto; color: var(--primary-color); font-size: 18px; }
    .grid-text { font-size: 12px; color: #555; }

    /* å•†å®¶åˆ—è¡¨æ¨™é¡Œ */
    .section-title { padding: 0 20px; font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px; display: flex; align-items: center; }
    .section-title::before { content: ''; width: 4px; height: 16px; background: var(--primary-color); margin-right: 8px; border-radius: 2px; }

    /* å•†å®¶å¡ç‰‡ (å„ªåŒ–ç‰ˆ) */
    .shop-list-container { padding: 0 15px; }
    .shop-card { 
      background: white; border-radius: 12px; overflow: hidden; 
      margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
      display: flex; /* æ”¹æˆæ©«å‘ä½ˆå±€ï¼Œåƒå¤–é€å¹³å° */
      padding: 10px;
      transition: transform 0.1s;
    }
    .shop-card:active { transform: scale(0.98); }
    .shop-thumb { width: 80px; height: 80px; border-radius: 8px; background-size: cover; background-position: center; flex-shrink: 0; }
    .shop-info { padding-left: 15px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .shop-name { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 5px; }
    .shop-tags { display: flex; gap: 5px; }
    .shop-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #f0f0f0; color: #666; }
    .shop-action { margin-top: 8px; }
    .btn-visit { background: #333; color: #C5A674; border: none; padding: 4px 12px; border-radius: 20px; font-size: 12px; }

    /* ====================
       4. æœƒå“¡ä¸­å¿ƒ & é»é¤ & æ­·å² (æ²¿ç”¨é‚è¼¯ä½†å„ªåŒ–æ¨£å¼)
       ==================== */
    #member-view, #shop-view { padding: 0; }
    /* æœƒå“¡é ­éƒ¨èƒŒæ™¯åœ– */
    .member-header-bg { background-image: url('https://images.unsplash.com/photo-1577053036830-e99b05374823'); background-size: cover; height: 150px; position: relative; }
    .member-info-overlay { 
      position: absolute; bottom: -40px; left: 20px; right: 20px; 
      background: white; padding: 20px; border-radius: 12px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      display: flex; align-items: center;
    }
    .big-avatar { width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .points-box { text-align: center; margin-left: auto; }
    
    .history-container { margin-top: 60px; padding: 20px; }
    
    /* é»é¤é é¢çš„å„ªåŒ– */
    #shop-view .shop-header { height: 180px; background-size: cover; background-position: center; position: relative; }
    #shop-view .shop-header::after { content:''; position:absolute; inset:0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); }
    .shop-header-content { position: absolute; bottom: 20px; left: 20px; color: white; }
    
    .menu-list { padding: 15px; }
    .menu-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .item-price { color: #D32F2F; font-weight: bold; }
    
    .stepper button { width: 28px; height: 28px; background: #f5f5f5; border: none; border-radius: 50%; color: #333; font-weight: bold; }
    .stepper .btn-plus { background: var(--primary-color); color: #fff; }

    #cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 100; padding-bottom: max(15px, env(safe-area-inset-bottom)); }
    #checkout-btn { background: #333; color: var(--primary-color); border: none; padding: 10px 30px; border-radius: 30px; font-weight: bold; }
    
    .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .status-wait { background: #FFF3E0; color: #F57C00; }
    .status-ok { background: #E8F5E9; color: #388E3C; }
    .status-no { background: #FFEBEE; color: #D32F2F; }
    .history-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; }

  </style>
</head>
<body>

  <div id="loading">Uni-S ç”Ÿæ´»åœˆè¼‰å…¥ä¸­...</div>
  <div id="error-box" class="hidden"></div>

  <div id="lobby-view" class="hidden">
    <div class="lobby-header-bg">
      <div class="lobby-brand">UNI-S PLATFORM</div>
      <div style="color:white; font-size:20px; font-weight:bold; margin-top:5px;">ç¾å¥½çš„ä¸€å¤©ï¼Œ<br>å¾ä¸€æ¯å¥½èŒ¶é–‹å§‹</div>
    </div>

    <div class="float-member-card" onclick="switchTab('member')">
      <img id="home-avatar" src="" class="mini-avatar">
      <div class="user-greeting">
        <h3><span id="home-user-name">...</span> <span class="level-badge" id="home-level">æ™®é€šæœƒå“¡</span></h3>
        <p>Uni-S ID: <span id="home-id-short">...</span></p>
      </div>
      <div class="quick-points">
        <span class="num" id="home-points">0</span>
        <span class="label">ç©åˆ†</span>
      </div>
    </div>

    <div class="grid-menu">
      <div class="grid-item">
        <div class="grid-icon"><i class="fas fa-qrcode"></i></div>
        <div class="grid-text">æƒç¢¼é»é¤</div>
      </div>
      <div class="grid-item">
        <div class="grid-icon"><i class="fas fa-ticket"></i></div>
        <div class="grid-text">å„ªæƒ åˆ¸</div>
      </div>
      <div class="grid-item">
        <div class="grid-icon"><i class="fas fa-map-marker-alt"></i></div>
        <div class="grid-text">é™„è¿‘é–€åº—</div>
      </div>
      <div class="grid-item">
        <div class="grid-icon"><i class="fas fa-headset"></i></div>
        <div class="grid-text">å®¢æœ</div>
      </div>
    </div>

    <div class="section-title">æ¨è–¦å•†å®¶</div>
    <div id="shop-list" class="shop-list-container"></div>
  </div>


  <div id="member-view" class="hidden">
    <div class="member-header-bg"></div>
    <div class="member-info-overlay">
      <img id="m-avatar" src="" class="big-avatar">
      <div>
        <div id="m-name" style="font-size:18px; font-weight:bold;">...</div>
        <div id="m-level" style="font-size:12px; color:#666;">æ™®é€šæœƒå“¡</div>
      </div>
      <div class="points-box">
        <div style="font-size:24px; font-weight:bold; color:#C5A674;" id="m-points">0</div>
        <div style="font-size:10px; color:#999;">å¯ç”¨ç©åˆ†</div>
      </div>
    </div>

    <div class="history-container">
      <div class="section-title">æœ€è¿‘è¨‚å–®</div>
      <div id="history-loading" style="text-align:center; color:#999; font-size:12px;">æŸ¥è©¢ä¸­...</div>
      <div id="history-list"></div>
    </div>
  </div>


  <div id="shop-view" class="hidden">
    <div id="back-btn" onclick="goLobby()"><i class="fas fa-chevron-left"></i></div>
    <div id="shop-banner" class="shop-header">
      <div class="shop-header-content">
        <h2 id="shop-name" style="margin:0;">...</h2>
        <div style="font-size:12px; opacity:0.8; margin-top:5px;">ç‡Ÿæ¥­ä¸­ â€¢ ç¾é»ç¾åš</div>
      </div>
    </div>

    <div class="menu-list" id="menu-list"></div>

    <div id="cart-bar">
      <div>
        <div style="font-size:10px; color:#999;">é ä¼°é‡‘é¡</div>
        <div style="font-size:20px; font-weight:bold; color:#333;">$<span id="total-display">0</span></div>
      </div>
      <button id="checkout-btn" onclick="sendOrder()">å»çµç®— (0)</button>
    </div>
  </div>


  <div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('lobby')">
      <div class="tab-icon"><i class="fas fa-home"></i></div>
      <div>é¦–é </div>
    </div>
    <div class="tab-item" onclick="switchTab('member')">
      <div class="tab-icon"><i class="fas fa-user"></i></div>
      <div>æˆ‘çš„</div>
    </div>
  </div>

  <script>
    // âš ï¸âš ï¸âš ï¸ è¨˜å¾—å¡«å…¥ä½ çš„ ID å’Œ URL âš ï¸âš ï¸âš ï¸
    const MY_LIFF_ID = "2008590518-p2AoVQO2"; 
    const API_URL = "https://script.google.com/macros/s/AKfycbzxUYXVSMjF8Zt7KqBo9qGvottN4zoxkM1qCu97ZqugJ7Nf6czxu0DzBY9DN1nVRtdn/exec";

    let allShops = {}; let currentShop = null; let cart = {}; let userProfile = null;

    async function main() {
      try {
        await liff.init({ liffId: MY_LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        
        userProfile = await liff.getProfile();
        updateUserUI(userProfile); // åˆå§‹åŒ–å¤§å»³é¡¯ç¤º

        const res = await fetch(API_URL);
        allShops = await res.json();
        document.getElementById('loading').classList.add('hidden');

        const shopId = new URLSearchParams(window.location.search).get('id');
        if (shopId && allShops[shopId]) openShop(shopId);
        else { renderLobby(); switchTab('lobby'); }
        
        // å·å·é å…ˆåŠ è¼‰é»æ•¸ï¼Œè®“é¦–é çœ‹èµ·ä¾†æœ‰æ•¸å­—
        fetchMemberData();

      } catch (err) { showError(err.message); }
    }

    function updateUserUI(profile) {
      // æ›´æ–°å¤§å»³
      document.getElementById('home-user-name').innerText = profile.displayName;
      document.getElementById('home-avatar').src = profile.pictureUrl;
      document.getElementById('home-id-short').innerText = profile.userId.substring(0, 8) + "...";
      // æ›´æ–°æœƒå“¡é 
      document.getElementById('m-name').innerText = profile.displayName;
      document.getElementById('m-avatar').src = profile.pictureUrl;
    }

    function switchTab(tab) {
      document.getElementById('lobby-view').classList.add('hidden');
      document.getElementById('member-view').classList.add('hidden');
      document.getElementById('shop-view').classList.add('hidden');
      document.getElementById('tab-bar').classList.remove('hidden');
      document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
      
      if (tab === 'lobby') {
        document.getElementById('lobby-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[0].classList.add('active');
        fetchMemberData(); // æ›´æ–°é¦–é é»æ•¸
      } else if (tab === 'member') {
        document.getElementById('member-view').classList.remove('hidden');
        document.querySelectorAll('.tab-item')[1].classList.add('active');
        fetchMemberData();
        loadOrderHistory();
      }
    }

    async function fetchMemberData() {
      try {
        const url = `${API_URL}?action=getMember&userId=${userProfile.userId}`;
        const res = await fetch(url);
        const data = await res.json();
        // åŒæ­¥æ›´æ–°é¦–é å’Œæœƒå“¡é çš„é»æ•¸
        document.getElementById('m-points').innerText = data.points;
        document.getElementById('m-level').innerText = data.level;
        document.getElementById('home-points').innerText = data.points;
        document.getElementById('home-level').innerText = data.level;
      } catch(e) { console.error(e); }
    }

    async function loadOrderHistory() {
      const listDiv = document.getElementById('history-list');
      const loadingDiv = document.getElementById('history-loading');
      listDiv.innerHTML = ''; loadingDiv.style.display = 'block';
      try {
        const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: "getHistory", userId: userProfile.userId }) });
        const history = await response.json();
        loadingDiv.style.display = 'none';
        
        if (history.length === 0) { listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;margin-top:20px;">æ‚¨é‚„æ²’æœ‰è¨‚å–®ç´€éŒ„</div>'; return; }
        
        let html = '';
        history.forEach(order => {
          let badgeClass = 'status-wait';
          if (order.status.includes('å·²æ¥å–®')) badgeClass = 'status-ok';
          if (order.status.includes('å·²å©‰æ‹’')) badgeClass = 'status-no';
          html += `
            <div class="history-item">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:12px; color:#888;">
                <span>${order.time}</span>
                <span class="status-badge ${badgeClass}">${order.status}</span>
              </div>
              <div style="font-weight:bold; margin-bottom:5px;">${order.shopName}</div>
              <div style="font-size:12px; color:#666; background:#f9f9f9; padding:8px; border-radius:4px;">${order.content}</div>
            </div>`;
        });
        listDiv.innerHTML = html;
      } catch (e) { loadingDiv.style.display = 'none'; }
    }

    function renderLobby() {
      const list = document.getElementById('shop-list');
      let html = '';
      Object.keys(allShops).forEach(id => {
        const s = allShops[id];
        // é€™è£¡æŠŠå•†å®¶å¡ç‰‡æ”¹æˆæ©«å¼çš„
        html += `
          <div class="shop-card" onclick="openShop('${id}', true)">
            <div class="shop-thumb" style="background-image:url(${s.bannerUrl})"></div>
            <div class="shop-info">
              <div class="shop-name">${s.name}</div>
              <div class="shop-tags">
                <span class="shop-tag">å…é‹è²»</span>
                <span class="shop-tag">å¥½è©•</span>
              </div>
              <div class="shop-action">
                <button class="btn-visit">å»é»é¤</button>
              </div>
            </div>
          </div>`;
      });
      list.innerHTML = html;
    }

    function openShop(id, pushHistory=false) {
      currentShop = allShops[id]; currentShop.id = id; cart = {};
      if(pushHistory) { const url = new URL(window.location); url.searchParams.set('id', id); window.history.pushState({}, '', url); }
      document.getElementById('tab-bar').classList.add('hidden'); document.getElementById('lobby-view').classList.add('hidden'); document.getElementById('member-view').classList.add('hidden'); document.getElementById('shop-view').classList.remove('hidden');
      renderShopUI(currentShop);
    }
    
    function renderShopUI(data) {
      document.getElementById('shop-name').innerText = data.name; 
      document.getElementById('shop-banner').style.backgroundImage = `url(${data.bannerUrl})`; 
      document.getElementById('total-display').innerText = '0';
      const btn = document.getElementById('checkout-btn'); btn.innerText = 'å»çµç®— (0)'; btn.classList.remove('active'); btn.style.backgroundColor = '#ccc'; btn.style.color = '#fff';
      
      let html = '';
      data.menu.forEach((item, index) => {
        html += `
          <div class="menu-item">
            <div style="flex:1;">
              <span class="item-name">${item.name}</span>
              <span class="item-price">$${item.price}</span>
            </div>
            <div class="stepper">
              <button class="btn-minus" onclick="updateCart('${item.name}', ${item.price}, -1)">âˆ’</button>
              <span class="count" id="count-${index}">0</span>
              <button class="btn-plus" style="background:${data.themeColor}" onclick="updateCart('${item.name}', ${item.price}, 1)">+</button>
            </div>
          </div>`;
      });
      document.getElementById('menu-list').innerHTML = html;
    }

    function updateCart(name, price, change) {
      if (!cart[name]) cart[name] = 0; cart[name] += change; if (cart[name] < 0) cart[name] = 0;
      const items = currentShop.menu; let total = 0; let count = 0;
      items.forEach((item, index) => {
        if (item.name === name) document.getElementById(`count-${index}`).innerText = cart[name];
        if (cart[item.name]) { total += cart[item.name] * item.price; count += cart[item.name]; }
      });
      document.getElementById('total-display').innerText = total;
      const btn = document.getElementById('checkout-btn'); btn.innerText = `å»çµç®— (${count})`;
      if (count > 0) { btn.classList.add('active'); btn.style.backgroundColor = '#333'; btn.style.color = '#C5A674'; } else { btn.classList.remove('active'); btn.style.backgroundColor = '#ccc'; btn.style.color = '#fff'; }
    }

    async function sendOrder() {
      if (!liff.isInClient()) { alert('è«‹åœ¨ LINE App ä¸­ä½¿ç”¨'); return; }
      let orderDetail = ""; let total = 0;
      for (let [name, qty] of Object.entries(cart)) { if (qty > 0) { let item = currentShop.menu.find(i => i.name === name); let subtotal = item.price * qty; orderDetail += `${name} x ${qty} ($${subtotal})\n`; total += subtotal; } }
      if (total === 0) { alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼"); return; }
      orderDetail += `----------------\nç¸½é‡‘é¡ï¼š$${total} å…ƒ`;

      let userPhone = localStorage.getItem("uni_user_phone");
      if (!userPhone) {
        userPhone = prompt("è«‹è¼¸å…¥æ‚¨çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œä»¥ä¾¿åº—å®¶è¯çµ¡ï¼š");
        if (!userPhone || userPhone.trim() === "") { alert("âŒ å¿…é ˆå¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼"); return; }
        localStorage.setItem("uni_user_phone", userPhone);
      }
      orderDetail += `\n----------------\nğŸ“ è¯çµ¡é›»è©±ï¼š${userPhone}`;

      const btn = document.getElementById('checkout-btn'); btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;
      try {
        await liff.sendMessages([{ type: "text", text: `ã€Uni-Sã€‘\næˆ‘å‘ ${currentShop.name} ä¸‹å–®äº†ï¼š\n\n${orderDetail}` }]);
        const orderData = { shopId: currentShop.id, userName: userProfile.displayName, userId: userProfile.userId, order: orderDetail };
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(orderData) });
        alert("âœ… è¨‚å–®å·²é€å‡ºï¼"); goLobby();
      } catch (err) { alert("ç™¼é€å¤±æ•—ï¼š" + err.message); btn.innerText = "é‡è©¦"; btn.disabled = false; }
    }
    
    function goLobby() { const url = new URL(window.location); url.searchParams.delete('id'); window.history.pushState({}, '', url); switchTab('lobby'); }
    function showError(msg) { document.getElementById('loading').classList.add('hidden'); document.getElementById('error-box').classList.remove('hidden'); document.getElementById('error-box').innerText = msg; }

    main();
  </script>
</body>
</html>
